<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RB Hybrid Kobun">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0b0e14">
    
    <title>RB Hybrid Kobun System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* Êï∞Â≠ó„ÇÑËã±Ë™û„ÅÆF1„Å£„ÅΩ„Åï„ÅØÊÆã„Åó„Å§„Å§„ÄÅÊó•Êú¨Ë™û„ÅØ„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì„Å∏ */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap');
        
        :root {
            --f1-red: #e10600;
            --rb-navy: #0b0e14;
            --neon-cyan: #00f0ff;
            --neon-green: #39ff14;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            background-color: transparent;
            color: #e2e8f0;
            /* „Ç¥„Ç∑„ÉÉ„ÇØ‰ΩìÊåáÂÆö */
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            padding-top: max(1rem, env(safe-area-inset-top));
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -1;
            object-fit: cover;
            filter: brightness(0.6);
        }

        .carbon-bg {
            background-image: none;
            background-color: transparent;
        }

        /* Êï∞Â≠ó„ÇÑËã±Ë™û„É≠„Ç¥Áî® */
        .f1-font { font-family: 'Chakra Petch', sans-serif; }
        
        /* Êó•Êú¨Ë™ûÁî®Ôºà„Ç¥„Ç∑„ÉÉ„ÇØÔºâ */
       /* Êó•Êú¨Ë™ûÁî®ÔºàF1‰ªïÊßò ÊòéÊúùÔºâ */
/* Êó•Êú¨Ë™ûÁî®ÔºàMochiy Pop OneÔºâ */
.jp-font { 
    font-family: 'Mochiy Pop One', sans-serif;
    font-weight: 400; /* „Åì„ÅÆ„Éï„Ç©„É≥„Éà„ÅØÂÖÉ„ÄÖÂ§™„ÅÑ„ÅÆ„Åß400„ÅßOK */
    
    /* ÊñáÂ≠ó„ÅÆË©∞„Åæ„ÇäÂÖ∑Âêà„ÇíË™øÊï¥„Åó„Å¶ÈñìÂª∂„Å≥„ÇíÈò≤„Åê */
    font-feature-settings: "palt";
    letter-spacing: 0.05em; /* Â∞ë„Åó„Å†„ÅëÈñìÈöî„ÇíÈñã„Åë„Çã„Å®Ë™≠„Åø„ÇÑ„Åô„ÅÑ */
    
}

/* „Çø„Éº„Ç≤„ÉÉ„ÉàÂçòË™ûÔºà„Éá„Ç´ÊñáÂ≠óÔºâ */
#target-word {
    font-family: 'Mochiy Pop One', sans-serif;
    /* Ëº™ÈÉ≠„ÇíÂº∑Ë™ø„Åó„Å¶„Çπ„ÉÜ„ÉÉ„Ç´„Éº„ÅÆ„Çà„ÅÜ„Å´Ë¶ã„Åõ„Çã */
    text-shadow: 
        3px 3px 0px #000, 
        0 0 15px rgba(225, 6, 0, 0.6); 
    line-height: 1.2;
}
        #app {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #app::-webkit-scrollbar { display: none; }

        .race-card {
            background: rgba(11, 14, 20, 0.1); /* Ë¶ñË™çÊÄßÂêë‰∏ä„ÅÆ„Åü„ÇÅÂ∞ë„ÅóÊøÉ„Åè */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .option-btn { 
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .option-btn:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.1); }
        .option-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .accent-f1 { accent-color: var(--f1-red); }
        .glitch-text { text-shadow: 2px 0 rgba(255,0,0,0.5), -2px 0 rgba(0,255,255,0.5); }

        .tire-btn { opacity: 0.4; transform: scale(0.95); transition: all 0.2s; border-width: 2px; }
        .tire-btn.active { opacity: 1; transform: scale(1); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .tire-soft.active { border-color: #ef4444; color: #ef4444; } 
        .tire-medium.active { border-color: #eab308; color: #eab308; } 
        .tire-hard.active { border-color: #f8fafc; color: #f8fafc; } 

        input, select { font-size: 16px !important; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }

        .wb-scroll::-webkit-scrollbar { width: 4px; }
        .wb-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .wb-scroll::-webkit-scrollbar-thumb { background: #e10600; border-radius: 4px; }
        
        .strategy-panel-mobile {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .strategy-panel-mobile.open {
            max-height: 80vh;
            overflow-y: auto;
            opacity: 1;
        }

        @media only screen and (max-width: 768px) {
            .carbon-bg {
                background-attachment: scroll; 
                min-height: 100vh;
            }
        }
        @media (min-width: 768px) {
            .strategy-panel-mobile {
                max-height: none !important;
                opacity: 1 !important;
                overflow: visible !important;
            }
        }
    </style>
</head>
<body class="carbon-bg text-sm md:text-base">

    <video autoplay muted loop playsinline poster="./F1.jpg" id="bg-video">
        <source src="./.mp4" type="video/mp4">
    </video>

    <div id="app" class="w-full max-w-6xl mx-auto flex flex-col">
        
        <div id="gate-screen" class="race-card p-8 rounded-2xl shadow-2xl text-center relative overflow-hidden animate-slide-in my-auto max-w-md mx-auto w-full">
            <h1 class="f1-font text-5xl mb-2 font-bold text-white tracking-wider">RB<span class="text-red-600">-KOBUN</span></h1>
            <p class="text-gray-400 font-mono text-xs uppercase tracking-[0.4em] mb-12">Hybrid Learning System</p>
            <button id="gate-login-btn" class="w-full f1-font bg-white hover:bg-gray-200 text-black px-8 py-4 rounded-xl font-bold tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-3 active:scale-95">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z" /></svg>
                Sign In
            </button>
            <p id="login-status" class="mt-6 text-[10px] text-gray-600 font-mono">System Standby...</p>
        </div>

        <div id="start-screen" class="hidden race-card p-4 md:p-6 rounded-2xl relative z-10 animate-slide-in my-auto w-full">
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                
                <div class="md:col-span-5 flex flex-col gap-6">
                    
                    <div class="flex justify-between items-end border-b border-gray-700 pb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                            <p id="user-name" class="f1-font text-xl text-white font-bold truncate">DRIVER</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-500 uppercase tracking-widest block">Global Daily Laps</span>
                            <span id="daily-laps-display" class="f1-font text-3xl text-white font-bold leading-none">0</span>
                        </div>
                    </div>

                    <div id="vocab-status-area" class="grid grid-cols-2 gap-4">
                        <div id="tire-status-box" class="bg-red-900/20 p-4 rounded-xl border border-red-900/30 text-center relative overflow-hidden group hover:bg-red-900/30 transition-colors">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">SRS Condition</p>
                            <span id="mistake-count-display" class="f1-font text-xl text-green-500 font-bold">OPTIMAL</span>
                            <div id="pit-alert-overlay" class="hidden absolute inset-0 bg-red-600 flex items-center justify-center cursor-pointer active:bg-red-700 transition-colors">
                                <span class="f1-font text-white font-bold animate-pulse text-sm">PIT STOP REQUIRED</span>
                            </div>
                        </div>
                        <button onclick="quiz.openTelemetry()" class="bg-blue-900/20 p-4 rounded-xl border border-blue-900/30 flex flex-col items-center justify-center hover:bg-blue-900/30 transition-colors group">
                            <span class="text-2xl mb-1 group-hover:scale-110 transition-transform">üìä</span>
                            <span class="text-[10px] text-blue-300 uppercase font-bold tracking-widest">Telemetry Data</span>
                        </button>
                    </div>

                    <button onclick="quiz.startFPMode()" class="w-full f1-font bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white py-4 rounded-xl font-bold tracking-[0.2em] uppercase transition-all transform active:scale-[0.98] shadow-lg shadow-blue-900/40 text-lg border-b-4 border-blue-900 mt-4 mb-2">
                        Free Practice
                    </button>

                    <button onclick="quiz.start()" class="w-full f1-font bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white py-6 rounded-xl font-bold tracking-[0.2em] uppercase transition-all transform active:scale-[0.98] shadow-lg shadow-red-900/40 text-2xl border-b-4 border-red-900 mt-auto">
                        Start Engine
                    </button>
                </div>

                <div class="md:col-span-7 flex flex-col gap-4 border-t md:border-t-0 md:border-l border-gray-700 pt-6 md:pt-0 md:pl-8">
                    
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-gray-400">‚öôÔ∏è</span>
                        <h3 class="f1-font text-lg font-bold text-white tracking-widest uppercase">Race Strategy</h3>
                        <p id="strategy-summary" class="ml-auto text-[10px] text-gray-500 font-mono border border-gray-700 px-2 py-1 rounded">Setup: Standard</p>
                    </div>

                    <button onclick="quiz.toggleStrategyMenu()" id="strategy-toggle-btn" class="md:hidden w-full bg-gray-800 text-white py-3 rounded-lg font-bold text-xs uppercase mb-2">
                        Show Settings ‚ñº
                    </button>

                    <div id="strategy-panel" class="strategy-panel-mobile space-y-6">
                        
                        <div class="flex border-b border-gray-700">
                            <button onclick="quiz.switchStrategyTab('normal')" id="tab-normal" class="px-6 py-2 text-xs font-bold text-white border-b-2 border-red-500 hover:bg-white/5 transition-colors">NORMAL GP</button>
                            <button onclick="quiz.switchStrategyTab('random')" id="tab-random" class="px-6 py-2 text-xs font-bold text-gray-500 border-b-2 border-transparent hover:text-white transition-colors">RANDOM GP</button>
                        </div>

                        <div id="strategy-normal" class="space-y-5">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-gray-500 text-[10px] uppercase tracking-widest block mb-2">Sector Selection</label>
                                    <div class="relative">
                                        <select id="round-selector" class="w-full bg-black/50 text-white p-3 rounded-lg border border-gray-600 focus:border-red-500 outline-none font-mono text-xs appearance-none cursor-pointer hover:bg-black/70 transition-colors" onchange="quiz.updateSummary()"></select>
                                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-500">‚ñº</div>
                                    </div>
                                </div>
                                
                                <div>                                    
                                    <label class="text-gray-500 text-[10px] uppercase tracking-widest block mb-2">Custom Range</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="custom-start" placeholder="1" class="w-16 bg-black text-white p-3 rounded-lg border border-gray-600 text-center text-xs font-mono focus:border-red-500 outline-none">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="custom-end" placeholder="50" class="w-16 bg-black text-white p-3 rounded-lg border border-gray-600 text-center text-xs font-mono focus:border-red-500 outline-none">
                                        <button onclick="quiz.createCustomRound()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white text-[10px] font-bold uppercase rounded-lg py-3 border border-gray-600 transition-colors whitespace-nowrap">
                                            SET
                                        </button>
                                    </div>
                                </div>
                            </div> </div> 

                        <div id="strategy-random" class="hidden space-y-4">
                            <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl">
                                <p class="text-[10px] text-indigo-300 mb-3 uppercase tracking-widest">Random Generator</p>
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="text-[9px] text-gray-400 block mb-1">Start</label>
                                        <input type="number" id="rand-start" placeholder="1" class="w-full bg-black text-white p-2 rounded border border-gray-600 text-center text-sm font-mono">
                                    </div>
                                    <span class="text-gray-500 pb-2">-</span>
                                    <div class="flex-1">
                                        <label class="text-[9px] text-gray-400 block mb-1">End</label>
                                        <input type="number" id="rand-end" placeholder="Max" class="w-full bg-black text-white p-2 rounded border border-gray-600 text-center text-sm font-mono">
                                    </div>
                                    <div class="flex-1">
                                        <label class="text-[9px] text-yellow-500 font-bold block mb-1">Laps</label>
                                        <input type="number" id="rand-qty" placeholder="20" class="w-full bg-black text-white p-2 rounded border border-yellow-600 text-center text-sm font-mono">
                                    </div>
                                </div>
                                <button onclick="quiz.createRandomRound()" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold text-xs uppercase tracking-widest shadow-lg shadow-indigo-900/50 transition-all">
                                    üé≤ Generate Grid
                                </button>
                            </div>
                        </div>

                        <div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3">Tire Strategy (Questions per Lap)</p>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="quiz.setTireStrategy(10, 'soft')" id="tire-soft" class="tire-btn tire-soft bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">üî¥ Soft</span>
                                    <span class="text-[10px] opacity-70">(10)</span>
                                </button>
                                <button onclick="quiz.setTireStrategy(20, 'medium')" id="tire-medium" class="tire-btn tire-medium active bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">üü° Medium</span>
                                    <span class="text-[10px] opacity-70">(20)</span>
                                </button>
                                <button onclick="quiz.setTireStrategy(50, 'hard')" id="tire-hard" class="tire-btn tire-hard bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">‚ö™ Hard</span>
                                    <span class="text-[10px] opacity-70">(50)</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                             <label class="flex items-center justify-between cursor-pointer group bg-black/30 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors">
                                <span class="text-xs font-bold text-gray-300 group-hover:text-cyan-400 transition-colors flex items-center gap-2"><span class="text-cyan-400">üîÑ</span> REVERSE (Áèæ‰ª£Ë™û‚áíÂè§Êñá)</span>
                                <input type="checkbox" id="reverse-mode" class="accent-f1 w-5 h-5 cursor-pointer" onchange="quiz.updateSummary()">
                            </label>
                        </div>

                        <div class="pt-4 border-t border-gray-700 relative">
                            <input type="text" id="search-input" placeholder="Quick Scan (Search)..." class="w-full bg-black text-white p-3 rounded-lg border border-gray-700 focus:border-red-500 outline-none font-mono text-sm mb-3 placeholder-gray-600">
                             <div id="search-results" class="hidden absolute top-16 left-0 right-0 bg-gray-900 border border-gray-700 rounded-lg shadow-2xl max-h-48 overflow-y-auto z-50"></div>
                            <button onclick="quiz.openWordBook()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 py-3 rounded-lg font-bold transition-all uppercase text-xs flex items-center justify-center gap-2">
                                <span>üìÅ</span> OPEN DATA CENTER
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="telemetry-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-blue-500 h-[90%] my-auto z-40 relative absolute inset-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="f1-font text-2xl font-bold text-blue-400 tracking-widest">TELEMETRY</h2>
                <button onclick="quiz.closeOverlay('telemetry-screen')" class="text-gray-400 active:text-white text-3xl p-2 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="bg-black/50 p-2 rounded-xl mb-4 border border-gray-800 h-64 w-full relative">
                <canvas id="weaknessRadarChart"></canvas>
            </div>
            <div class="text-left mb-4 h-full overflow-hidden flex flex-col">
                <h3 class="text-xs text-red-500 font-bold uppercase tracking-widest mb-2 flex-shrink-0">Degradation Report (Worst Laps)</h3>
                <div id="worst-words-list" class="space-y-1 overflow-y-auto pr-2 flex-grow scrollbar-thin"></div>
            </div>
        </div>
        
        <div id="wordbook-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-yellow-500 h-[90%] my-auto z-50 flex flex-col absolute inset-4">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="f1-font text-2xl font-bold text-yellow-500 tracking-widest">DATA CENTER</h2>
                <button onclick="quiz.closeOverlay('wordbook-screen')" class="text-gray-400 active:text-white text-3xl p-2 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 flex-shrink-0 justify-center items-center">
                <div class="bg-gray-900 p-2 rounded border border-gray-700 flex items-center gap-2">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">SECTOR</span>
                    <input type="number" id="wb-start" placeholder="1" class="w-16 bg-black text-white p-1 text-sm rounded border border-gray-700 font-mono text-center focus:border-yellow-500 outline-none">
                    <span class="text-gray-500">-</span>
                    <input type="number" id="wb-end" placeholder="END" class="w-16 bg-black text-white p-1 text-sm rounded border border-gray-700 font-mono text-center focus:border-yellow-500 outline-none">
                </div>
            </div>
            <div class="flex gap-2 mb-4 flex-shrink-0">
                <input type="text" id="wb-search" placeholder="Search components..." class="flex-1 bg-black text-white p-2 text-sm rounded border border-gray-700 font-mono focus:border-yellow-500 outline-none">
                <button id="wb-filter-btn" class="bg-gray-800 text-white px-3 rounded border border-gray-600 text-xs font-bold uppercase hover:bg-gray-700 transition-colors" onclick="quiz.toggleBookFilter()">ALL</button>
            </div>
            <div id="wb-list" class="flex-1 overflow-y-auto wb-scroll text-left space-y-2 pr-1">
            </div>
        </div>

        <div id="quiz-screen" class="hidden race-card p-6 rounded-2xl shadow-2xl relative flex flex-col justify-between my-auto min-h-[500px] w-full max-w-5xl mx-auto">
            <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col text-left">
                    <span id="circuit-name" class="f1-font text-[10px] text-gray-400 uppercase tracking-widest">ROUND 1</span>
                    <span id="question-number" class="f1-font text-white font-bold text-lg">LAP 1/20</span>
                </div>
                <div class="text-right">
                    <div id="timer" class="f1-font text-2xl text-yellow-400 font-mono">0.00s</div>
                    <div id="streak-display" class="f1-font text-[10px] text-green-500 font-bold uppercase tracking-widest hidden">PURPLE SECTOR</div>
                </div>
            </div>
            <div class="w-full bg-gray-800 h-1 mb-8 rounded-full overflow-hidden">
                <div id="progress-fill" class="bg-gradient-to-r from-red-600 to-yellow-500 h-full w-0 transition-all duration-300"></div>
            </div>
            
            <div id="vocab-interface" class="flex-grow flex flex-col justify-between">
                <div class="flex-grow flex flex-col items-center justify-center mb-8 relative">
                    <div class="absolute -top-6 text-gray-500 text-[10px] uppercase tracking-widest" id="question-label">Target</div>
                    <h2 id="target-word" class="jp-font text-5xl md:text-7xl font-bold text-white tracking-wide drop-shadow-xl break-words px-2 text-center transition-all"></h2>
                </div>
                
                <div id="options-container" class="grid grid-cols-2 gap-4 max-w-4xl mx-auto w-full"></div>
            </div>

            <div id="feedback" class="h-8 mt-4 flex items-center justify-center text-sm font-bold tracking-wider uppercase"></div>
        </div>

        <div id="fp-screen" class="hidden race-card p-6 rounded-2xl shadow-2xl relative flex flex-col justify-between my-auto min-h-[500px] w-full max-w-2xl mx-auto border-t-4 border-blue-500">
            <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col text-left">
                    <span class="f1-font text-[10px] text-blue-400 uppercase tracking-widest">FREE PRACTICE</span>
                    <span id="fp-counter" class="f1-font text-white font-bold text-lg">LAP 1/20</span>
                </div>
                <button onclick="quiz.exitFPMode()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="f1-font font-bold text-xs uppercase border border-gray-600 px-3 py-1 rounded">BOX (Êàª„Çã)</span>
                </button>
            </div>
            
            <div onclick="quiz.flipFPCard()" class="flex-grow flex flex-col items-center justify-center cursor-pointer bg-white/5 hover:bg-white/10 border border-white/20 rounded-2xl p-8 transition-colors relative min-h-[300px]">
                <div class="absolute top-4 right-4 text-gray-500 text-[10px] uppercase tracking-widest animate-pulse">Tap to Flip</div>
                
                <div id="fp-front" class="text-center">
                    <h2 id="fp-word" class="jp-font text-5xl md:text-7xl font-bold text-white tracking-wide drop-shadow-xl break-words px-2 leading-tight"></h2>
                </div>
                
                <div id="fp-back" class="hidden text-center w-full">
                    <h3 class="text-xs text-red-500 font-bold uppercase tracking-widest mb-2 border-b border-red-900/50 pb-1">Meaning</h3>
                    <p id="fp-meaning" class="jp-font text-2xl md:text-4xl font-bold text-white mb-8"></p>
                    
                    <h3 class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2 border-b border-blue-900/50 pb-1">Telemetry (Ë™ûÂëÇÂêà„Çè„Åõ)</h3>
                    <p id="fp-goro" class="jp-font text-lg md:text-xl font-bold text-yellow-300"></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <button onclick="quiz.prevFPCard()" class="f1-font bg-gray-800 hover:bg-gray-700 text-white py-4 rounded-xl font-bold transition-all uppercase text-sm tracking-wider active:scale-95 border border-gray-600">‚óÄ PREV</button>
                <button onclick="quiz.nextFPCard()" class="f1-font bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/50 uppercase text-sm tracking-wider active:scale-95">NEXT ‚ñ∂</button>
            </div>
        </div>
        
        <div id="result-screen" class="hidden race-card p-8 rounded-2xl shadow-2xl text-center animate-slide-in my-auto max-w-2xl mx-auto w-full">
            <h2 id="result-title" class="f1-font text-4xl mb-2 font-bold text-white italic tracking-tighter">CHECKERED FLAG</h2>
            <div class="w-full h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent opacity-50 mb-8"></div>
            
            <div id="accuracy-display" class="f1-font text-8xl font-bold mb-2 text-white glitch-text tracking-tighter">95.0%</div>
            <p id="rank-text" class="f1-font text-sm mb-8 text-gray-400 font-mono">P1: MAX VERSTAPPEN</p>
            
            <div id="pass-area" class="hidden mb-8 animate-slide-in">
                <p class="text-[#39ff14] font-bold f1-font text-xl mb-3 tracking-widest">LICENSE ACQUIRED</p>
            </div>
            
            <div id="fail-msg" class="hidden mb-8">
                <p class="text-red-500 font-bold f1-font text-sm tracking-widest">LICENSE DENIED (Req: 90%)</p>
            </div>

            <div class="bg-black/40 p-4 rounded-xl mb-8 text-left max-h-48 overflow-y-auto border border-gray-800 scrollbar-thin" id="review-list"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="quiz.returnToGrid()" class="f1-font border border-gray-600 hover:bg-gray-800 text-white py-4 rounded-xl font-bold transition-all uppercase text-sm tracking-wider">Garage</button>
                <button id="next-round-btn" class="f1-font bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-red-900/50 uppercase text-sm tracking-wider">Next Sector</button>
            </div>
        </div>
    </div>

    <script>
      // ‚òÖ„Åì„Åì„Å´Âè§Êñá„Éá„Éº„Çø„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ
      const rawData = `
      „ÅÇ„ÅÑ„Åé„ÇÉ„ÅÜ: „Åã„Çè„ÅÑ„Çâ„Åó„Åï | È≠ÖÂäõ // „ÅÇ„ÅÑ„Å°„ÇÉ„Çì„Åé„Çá„ÅÜ„Åï„Çì„Åã„Çè„ÅÑ„Çâ„Åó„ÅÑ
„ÅÇ„Åã„Çâ„Åï„Åæ„Å™„Çä: „Åª„Çì„ÅÆ„Å°„Çá„Å£„Å® // „ÅÇ„Åã„Çâ„Åï„Åæ„Å´„ÄÅ„Åª„Çì„ÅÆ„Å°„Çá„Å£„Å®„Å†
„ÅÇ„Åç„Çâ„ÇÄ: Êòé„Çâ„Åã„Å´„Åô„Çã | „ÅØ„Å£„Åç„ÇäË¶ã„Çã // „ÅÇ„Åç„Çâ„ÇÄ„Åè„Çì„ÅÆÊ∞óÊåÅ„Å°„ÇíÊòé„Çâ„Åã„Å´„Åô„Çã
      `; 

    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
    document.addEventListener('touchmove', function(event) { if (event.scale !== 1) { event.preventDefault(); } }, { passive: false });

    class HybridQuiz {
        constructor() {
            this.wordsPerRound = 20; 
            this.masterList = [];
            this.vocabRounds = [];
            this.currentRoundIndex = 0;
            this.questions = [];
            this.currentIndex = 0;
            this.missCount = 0;
            this.missedWordsLog = [];
            this.startTime = 0;
            this.lapStartTime = 0; 
            this.timerInterval = null;
            this.currentStreak = 0;
            this.maxStreak = 0; 
            this.dueMistakes = [];
            this.allMistakes = []; 
            this.bookmarkedOnly = false;

            this.isPitStopMode = false;
            this.isReverseMode = false;
            
            document.getElementById('wb-search').addEventListener('input', () => this.renderWordBook());
            document.getElementById('wb-start').addEventListener('input', () => this.renderWordBook());
            document.getElementById('wb-end').addEventListener('input', () => this.renderWordBook());

            this.parseData();
            this.generateRounds();
            this.initUI();
            this.initSearch(); 
        }

        parseData() {
            if(!rawData.trim()) { this.masterList = []; return; }
            const lines = rawData.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            this.masterList = [];
            lines.forEach(line => {
                let goro = "";
                let mainPart = line;
                // Ë™ûÂëÇÂêà„Çè„ÅõÔºà//Ôºâ„ÅÆÂàÜÈõ¢
                if(line.includes('//')) {
                    const parts = line.split('//');
                    mainPart = parts[0].trim();
                    goro = parts[1].trim();
                }

                let sep = -1;
                if (mainPart.indexOf(':') !== -1) sep = mainPart.indexOf(':');
                else if (mainPart.indexOf('Ôºö') !== -1) sep = mainPart.indexOf('Ôºö');
                
                if (sep !== -1) {
                    const w = mainPart.substring(0, sep).trim();
                    const mRaw = mainPart.substring(sep + 1).trim();
                    const mList = mRaw.split('|').map(s => s.trim());
                    // g: goro „Å®„Åó„Å¶„Éá„Éº„Çø„Çí‰øùÊåÅ
                    this.masterList.push({ w: w, m: mList, g: goro });
                }
            });
        }

        generateRounds() {
            const wordCopy = [...this.masterList]; 
            this.vocabRounds = [];
            let roundNum = 1;
            let currentWordIndex = 1; 
            while (wordCopy.length > 0) {
                const chunk = wordCopy.splice(0, this.wordsPerRound);
                if (chunk.length > 0) {
                    this.vocabRounds.push({ id: roundNum, name: `SECTOR ${roundNum} (No.${currentWordIndex} - ${currentWordIndex + chunk.length - 1})`, words: chunk });
                    roundNum++;
                    currentWordIndex += chunk.length;
                }
            }
        }

        initUI() {
            const selector = document.getElementById('round-selector');
            selector.innerHTML = '';
            if(this.vocabRounds.length === 0) { selector.innerHTML = '<option>Load Data or Login</option>'; }
            else {
                this.vocabRounds.forEach((round, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = round.name;
                    selector.appendChild(opt);
                });
            }

            const lastPlayed = localStorage.getItem('rb26_kobun_last_round');
            if (lastPlayed) {
                const roundIdx = parseInt(lastPlayed);
                if (!isNaN(roundIdx) && roundIdx < this.vocabRounds.length) {
                    selector.value = roundIdx;
                    const option = selector.options[roundIdx];
                    if (option) option.text = "‚óÄ LAST ‚ñ∂ " + option.text;
                }
            }
            this.updateSummary();
        }

        updateSummary() {
            const selector = document.getElementById('round-selector');
            let roundName = "Custom / Random";
            if (selector.selectedIndex >= 0) {
                roundName = selector.options[selector.selectedIndex].text;
            }
            
            const tire = this.wordsPerRound;
            const rev = document.getElementById('reverse-mode').checked ? "REV" : "STD";
            
            document.getElementById('strategy-summary').innerText = `${roundName} | ${tire} Qs | ${rev}`;
        }

        toggleStrategyMenu() {
            const panel = document.getElementById('strategy-panel');
            const btn = document.getElementById('strategy-toggle-btn');
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                btn.classList.remove('bg-gray-700', 'text-white');
                btn.classList.add('bg-gray-800', 'text-gray-400');
                btn.innerText = "Show Settings ‚ñº";
            } else {
                panel.classList.add('open');
                btn.classList.remove('bg-gray-800', 'text-gray-400');
                btn.classList.add('bg-gray-700', 'text-white');
                btn.innerText = "Hide Settings ‚ñ≤";
            }
        }

        switchStrategyTab(tab) {
            const normalDiv = document.getElementById('strategy-normal');
            const randomDiv = document.getElementById('strategy-random');
            const tabNorm = document.getElementById('tab-normal');
            const tabRand = document.getElementById('tab-random');

            if (tab === 'normal') {
                normalDiv.classList.remove('hidden');
                randomDiv.classList.add('hidden');
                tabNorm.classList.add('text-white', 'border-red-500');
                tabNorm.classList.remove('text-gray-500', 'border-transparent');
                tabRand.classList.remove('text-white', 'border-red-500');
                tabRand.classList.add('text-gray-500', 'border-transparent');
            } else {
                normalDiv.classList.add('hidden');
                randomDiv.classList.remove('hidden');
                tabRand.classList.add('text-white', 'border-red-500');
                tabRand.classList.remove('text-gray-500', 'border-transparent');
                tabNorm.classList.remove('text-white', 'border-red-500');
                tabNorm.classList.add('text-gray-500', 'border-transparent');
            }
        }

        initSearch() {
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            input.addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase().trim();
                if (!q) { results.classList.add('hidden'); return; }
                const hits = this.masterList.map((item, index) => ({ ...item, i: index + 1 }))
                    .filter(item => item.w.toLowerCase().includes(q) || item.m.some(m => m.toLowerCase().includes(q)))
                    .slice(0, 50);
                if (hits.length > 0) {
                    results.classList.remove('hidden');
                    results.innerHTML = hits.map(h => `
                        <div class="p-3 border-b border-gray-800 flex justify-between items-center group hover:bg-white/5 transition-colors">
                            <div class="text-left"><div class="flex items-baseline gap-2"><span class="text-[10px] text-yellow-500 font-mono opacity-70">No.${h.i}</span><span class="text-red-400 font-bold text-xs jp-font">${h.w}</span></div><span class="text-gray-400 text-[10px] pl-1 truncate block max-w-[200px]">${h.m.join(' / ')}</span></div>
                        </div>`).join('');
                } else {
                    results.classList.remove('hidden');
                    results.innerHTML = `<div class="p-3 text-gray-500 text-[10px] text-center">NO DATA</div>`;
                }
            });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden'); });
        }

        createCustomRound() {
            const s = parseInt(document.getElementById('custom-start').value) - 1;
            const e = parseInt(document.getElementById('custom-end').value);
            if(isNaN(s) || isNaN(e) || s < 0 || e > this.masterList.length || s >= e) { alert("Invalid Range"); return; }
            const customWords = this.masterList.slice(s, e);
            this.vocabRounds.unshift({ id: 'custom', name: `CUSTOM (No.${s+1}-${e})`, words: customWords });
            this.initUI();
            document.getElementById('round-selector').value = 0;
            this.updateSummary();
        }

        createRandomRound() {
            const sVal = document.getElementById('rand-start').value;
            const eVal = document.getElementById('rand-end').value;
            const qVal = document.getElementById('rand-qty').value;
            
            let s = parseInt(sVal) - 1;
            let e = parseInt(eVal);
            let qty = parseInt(qVal);

            if (isNaN(s)) s = 0;
            if (isNaN(e)) e = this.masterList.length;
            if (isNaN(qty) || qty <= 0) qty = this.wordsPerRound; 

            if (s < 0 || e > this.masterList.length || s >= e) { alert("Invalid Range for Random GP"); return; }

            const rangePool = this.masterList.slice(s, e);
            this.shuffle(rangePool);
            const selectedWords = rangePool.slice(0, qty);
            
            this.vocabRounds.unshift({ id: 'random', name: `üé≤ RANDOM (Range: ${s+1}-${e})`, words: selectedWords });
            this.initUI();
            document.getElementById('round-selector').value = 0;
            this.updateSummary();
            this.start();
        }
        
        setTireStrategy(count, type) {
            this.wordsPerRound = count;
            this.generateRounds();
            this.initUI();
            document.querySelectorAll('.tire-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tire-${type}`).classList.add('active');
            this.updateSummary();
        }

        start() {
            this.currentIndex = 0;
            this.missCount = 0;
            this.currentStreak = 0; 
            this.maxStreak = 0;     
            this.missedWordsLog = [];
            this.startTime = Date.now();
            this.startTimer();
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            this.startVocabMode();
        }

        startVocabMode() {
            if(this.vocabRounds.length === 0) { alert("Data not loaded"); this.returnToGrid(); return; }
            this.isPitStopMode = false;
            
            const selector = document.getElementById('round-selector');
            this.currentRoundIndex = parseInt(selector.value);
            const selectedRound = this.vocabRounds[this.currentRoundIndex];
            
            if (selectedRound.id !== 'custom' && selectedRound.id !== 'random') {
                localStorage.setItem('rb26_kobun_last_round', this.currentRoundIndex);
            }

            this.isReverseMode = document.getElementById('reverse-mode').checked;

            let modeTitle = this.isReverseMode ? " [REV]" : "";
            document.getElementById('circuit-name').innerText = selectedRound.name + modeTitle;
            document.getElementById('question-label').innerText = this.isReverseMode ? "TRANSLATE" : "MEANING";

            this.questions = selectedRound.words.map(target => {
                // Â§öÁæ©Ë™û„ÅÆ‰∏≠„Åã„Çâ1„Å§„Å†„Åë„É©„É≥„ÉÄ„É†„Å´ÈÅ∏„Å∂
                const randomMeaning = target.m[Math.floor(Math.random() * target.m.length)];
                const fullMeanings = target.m; // ‰øùÂ≠òÁî®„Å´ÂÖ®ÊÑèÂë≥„ÇÇÊåÅ„Å£„Å¶„Åä„Åè

                const qText = this.isReverseMode ? randomMeaning : target.w;
                const aText = this.isReverseMode ? target.w : randomMeaning;
                
                const distractors = this.getDistractors(target, this.isReverseMode);
                const options = [aText, ...distractors].sort(() => Math.random() - 0.5);
                
                const existingData = (this.allMistakes || []).find(item => item.word === target.w || item.w === target.w) || {};

                return { 
                    w: target.w, 
                    m: fullMeanings, // Ë®òÈå≤Áî®ÔºàÈÖçÂàóÔºâ
                    displayM: randomMeaning, // Ë°®Á§∫Áî®ÔºàÂçò‰∏ÄÔºâ
                    qText: qText, 
                    aText: aText, 
                    o: options,
                    docId: existingData.id || null, 
                    interval: existingData.interval || 0,
                    repetitions: existingData.repetitions || 0,
                    easeFactor: existingData.easeFactor || 2.5
                };
            });
            this.questions.sort(() => Math.random() - 0.5);
            this.showVocabQuestion();
        }
        
        getDistractors(targetWord, isReverse) {
             const distractors = [];
             if (this.masterList.length < 4) return ["Option A", "Option B", "Option C"]; 

             // „Çø„Éº„Ç≤„ÉÉ„Éà„ÅÆ„ÄåÊ≠£Ëß£ÊñáÂ≠óÂàó„Äç
             // ÈÄöÂ∏∏„É¢„Éº„Éâ„Å™„ÇâÔºötargetWord.w „ÅåÂïèÈ°å„ÄÇtargetWord.m (ÈÖçÂàó) „ÅÆ„Å©„Çå„Åã„ÅåÊ≠£Ëß£„ÄÇ
             // „ÉÄ„Éü„ÉºÈÅ∏ÊäûËÇ¢„ÅØ‰ªñ„ÅÆÂçòË™û„ÅÆ m (ÈÖçÂàó) „Åã„Çâ1„Å§ÈÅ∏„Å∂„ÄÇ
             
             // Reverse„É¢„Éº„Éâ„Å™„ÇâÔºötargetWord.m (ÈÖçÂàó) „ÅÆ„Å©„Çå„Åã„ÅåÂïèÈ°å„ÄÇtargetWord.w „ÅåÊ≠£Ëß£„ÄÇ
             // „ÉÄ„Éü„ÉºÈÅ∏ÊäûËÇ¢„ÅØ‰ªñ„ÅÆÂçòË™û„ÅÆ w „ÇíÈÅ∏„Å∂„ÄÇ

             let attempts = 0;
             while (distractors.length < 3 && attempts < 100) {
                 const r = this.masterList[Math.floor(Math.random() * this.masterList.length)];
                 
                 // Ê≠£Ëß£ÂÄôË£ú„Å®Âêå„ÅòÂçòË™û„Éá„Éº„Çø„Å™„Çâ„Çπ„Ç≠„ÉÉ„Éó
                 if (r.w === targetWord.w) {
                     attempts++;
                     continue;
                 }

                 let candidate;
                 if (isReverse) {
                     // Á≠î„Åà„ÅØÂçòË™û„Åù„ÅÆ„ÇÇ„ÅÆ
                     candidate = r.w;
                 } else {
                     // Á≠î„Åà„ÅØÊÑèÂë≥ÔºàÂ§öÁæ©Ë™û„ÅÆ‰∏≠„Åã„Çâ1„Å§ÈÅ∏„Å∂Ôºâ
                     candidate = r.m[Math.floor(Math.random() * r.m.length)];
                 }

                 if (!distractors.includes(candidate)) {
                     distractors.push(candidate);
                 }
                 attempts++;
             }
             return distractors;
         }

         showVocabQuestion() {
             const q = this.questions[this.currentIndex];
             document.getElementById('question-number').innerText = `LAP ${this.currentIndex + 1} / ${this.questions.length}`;
             
             const targetDisplay = document.getElementById('target-word');
             targetDisplay.innerHTML = "";
             targetDisplay.innerText = q.qText;
             
             // ÊñáÂ≠óÊï∞„Åß„Çµ„Ç§„Ç∫Ë™øÊï¥
             const len = q.qText.length;
             let sizeClass = "text-5xl md:text-7xl";
             if(len > 10) sizeClass = "text-3xl md:text-5xl";
             if(len > 20) sizeClass = "text-xl md:text-3xl";

             targetDisplay.className = `jp-font ${sizeClass} font-bold text-white tracking-wide drop-shadow-lg break-words px-2 text-center leading-tight`;

             this.lapStartTime = Date.now(); 

             document.getElementById('progress-fill').style.width = `${(this.currentIndex / this.questions.length) * 100}%`;
             document.getElementById('feedback').innerText = '';
             
             const container = document.getElementById('options-container');
             container.innerHTML = '';
             
             q.o.forEach(opt => {
                 const btn = document.createElement('button');
                 // Êó•Êú¨Ë™û„ÅåÂê´„Åæ„Çå„ÇãÂ†¥Âêà„ÅØ„Ç¥„Ç∑„ÉÉ„ÇØ‰Ωì
                 const isJp = /[„ÅÇ-„Çì„Ç¢-„É≥‰∏Ä-Èæ•]/.test(opt);
                 const fontClass = isJp ? "jp-font tracking-wider" : "text-sm";
                 // ÊñáÂ≠óÊï∞„Åß„Çµ„Ç§„Ç∫Ë™øÊï¥
                 const textSize = opt.length > 20 ? "text-xs" : (opt.length > 10 ? "text-sm" : "text-lg");
                 
                 btn.className = `option-btn w-full h-full flex items-center justify-center p-5 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 active:border-red-500 font-bold shadow-lg ${fontClass} ${textSize} transition-all min-h-[80px]`;
                 btn.innerText = opt;
                 btn.onclick = () => this.handleVocabAnswer(opt, q);
                 container.appendChild(btn);
             });
         }

         handleVocabAnswer(selected, q) {
             const btns = document.querySelectorAll('.option-btn');
             if (btns.length > 0 && btns[0].disabled) return;
             btns.forEach(b => b.disabled = true);

             const feedback = document.getElementById('feedback');
             const timeTaken = (Date.now() - this.lapStartTime) / 1000;
             const isCorrect = (selected === q.aText);

             if (window.handleSRSUpdate) {
                 window.handleSRSUpdate({ ...q, timeTaken: timeTaken }, isCorrect);
             }

             if (isCorrect) {
                 this.currentStreak++;
                 if (this.currentStreak > this.maxStreak) {
                     this.maxStreak = this.currentStreak;
                 }
                 
                 if (timeTaken < 1.5) {
                     feedback.innerHTML = `<span class="text-[#39ff14] text-xs font-bold animate-pulse">üü£ PURPLE SECTOR (${timeTaken.toFixed(2)}s)</span>`;
                 } else if (timeTaken > 5.0) {
                     feedback.innerHTML = `<span class="text-yellow-500 text-xs font-bold">üü° SLOW (${timeTaken.toFixed(2)}s)</span>`;
                 }

                 setTimeout(() => {
                     this.currentIndex++;
                     if (this.currentIndex < this.questions.length) this.showVocabQuestion();
                     else this.finish();
                 }, 400); 

             } else {
                 this.missCount++;
                 this.currentStreak = 0; 
                 
                 // Ê≠£Ëß£Ë°®Á§∫ÔºàÊÑèÂë≥„ÅØÂÖ®„É™„Çπ„ÉàË°®Á§∫„Åß„ÅØ„Å™„Åè„ÄÅÂá∫È°å„Åï„Çå„ÅüÊ≠£Ëß£„ÇíË°®Á§∫„Åô„Çã„Åå„ÄÅ„Çè„Åã„Çä„ÇÑ„Åô„Åï„ÅÆ„Åü„ÇÅÂÖ®ÊÑèÂë≥„ÇíÂá∫„Åó„Å¶„ÇÇ„Çà„ÅÑ„ÄÇ„Åì„Åì„Åß„ÅØ„Ç∑„É≥„Éó„É´„Å´Ôºâ
                 // ÂÖ®ÊÑèÂë≥„ÇíË°®Á§∫„Åó„Å¶Âæ©Áøí„Åó„ÇÑ„Åô„Åè„Åô„Çã
                 const displayCorrect = Array.isArray(q.m) ? q.m.join(' / ') : q.m;
                 
                 feedback.innerText = `WRONG: ${q.w} = ${displayCorrect}`;
                 feedback.className = "mt-4 text-center h-6 font-bold text-red-500 animate-pulse";
                 
                 if (!this.missedWordsLog.find(item => item.w === q.w)) {
                     this.missedWordsLog.push({ w: q.w, m: displayCorrect });
                 }
                 
                 this.questions.push(q);
                 setTimeout(() => { 
                     this.currentIndex++; 
                     this.showVocabQuestion(); 
                 }, 2000); // Ë™≠„ÇÄÊôÇÈñì„ÇíÂ∞ë„ÅóÁ¢∫‰øù
             }
         }

         startTimer() {
             if (this.timerInterval) clearInterval(this.timerInterval);
             this.timerInterval = setInterval(() => { document.getElementById('timer').innerText = ((Date.now() - this.startTime) / 1000).toFixed(2) + 's'; }, 50);
         }

         shuffle(array) {
             for (let i = array.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [array[i], array[j]] = [array[j], array[i]];
             }
         }

         finish() {
             clearInterval(this.timerInterval);
             document.getElementById('quiz-screen').classList.add('hidden');
             document.getElementById('result-screen').classList.remove('hidden');
             
             const totalTime = (Date.now() - this.startTime) / 1000;
             let totalQs = this.questions.length; // „Éö„Éä„É´„ÉÜ„Ç£Ëæº„Åø„ÅÆÁ∑èÂá∫È°åÊï∞„Å´„ÅØ„Åó„Åü„Åè„Å™„ÅÑÂ†¥ÂêàË™øÊï¥„ÅåÂøÖË¶Å„Å†„Åå„ÄÅ„Ç∑„É≥„Éó„É´„Å´
             
             // Á¥îÁ≤ã„Å™ÂïèÈ°åÊï∞„Éô„Éº„Çπ„Åß„ÅÆ„Çπ„Ç≥„Ç¢
             let correctCount = Math.max(0, this.wordsPerRound - this.missCount);
             let accuracy = (correctCount / this.wordsPerRound) * 100;
             if(accuracy < 0) accuracy = 0;
             if(accuracy > 100) accuracy = 100; // Âøµ„ÅÆ„Åü„ÇÅ
             
             const accDisplay = document.getElementById('accuracy-display');
             accDisplay.innerText = `${accuracy.toFixed(1)}%`;

             if (window.saveRaceResult) {
                 let roundName = "UNKNOWN ROUND";
                 if (this.isPitStopMode) {
                     roundName = "SRS PIT STOP";
                 } else if (this.vocabRounds[this.currentRoundIndex]) {
                     roundName = this.vocabRounds[this.currentRoundIndex].name;
                 }

                 const resultData = {
                     accuracy: parseFloat(accuracy.toFixed(1)),
                     round: roundName,
                     score: `${correctCount}/${this.wordsPerRound}`,
                     streak: this.maxStreak,
                     time: parseFloat(totalTime.toFixed(2))
                 };
                 window.saveRaceResult(resultData);
             }
             
             const passArea = document.getElementById('pass-area');
             const failMsg = document.getElementById('fail-msg');

             if (accuracy >= 90) {
                 accDisplay.style.color = "#4ade80"; 
                 passArea.classList.remove('hidden');
                 failMsg.classList.add('hidden');
             } else {
                 accDisplay.style.color = "#ef4444"; 
                 passArea.classList.add('hidden');
                 failMsg.classList.remove('hidden');
             }

             document.getElementById('rank-text').innerText = `Time: ${totalTime.toFixed(2)}s | Misses: ${this.missCount}`;
             document.getElementById('result-title').innerText = "CHECKERED FLAG";
             
             const review = document.getElementById('review-list');
             let summaryHtml = `<div class="mb-4 font-bold text-white uppercase text-sm tracking-widest border-b border-gray-700 pb-2">Lap Analysis</div>`;
             if (this.missedWordsLog.length > 0) { summaryHtml += this.missedWordsLog.map(item => `<div class="mb-2 text-sm p-2 bg-red-900/10 border border-red-900/30 rounded"><span class="font-bold text-white block jp-font">${item.w}</span><span class="text-gray-400">${item.m}</span></div>`).join(''); } else { summaryHtml += '<p class="text-green-500 font-bold">Perfect Lap. No Issues Detected.</p>'; }
             review.innerHTML = summaryHtml;
             
            const nextBtn = document.getElementById('next-round-btn');
            const currentRound = this.vocabRounds[this.currentRoundIndex];

            if (!this.isPitStopMode) {
                if (currentRound && currentRound.id === 'random') {
                    nextBtn.classList.remove('hidden');
                    nextBtn.innerText = "AGAIN (SAME SETUP)"; 
                    nextBtn.onclick = () => { 
                        this.createRandomRound(); 
                    };
                } else if (this.currentRoundIndex + 1 < this.vocabRounds.length) {
                    nextBtn.classList.remove('hidden');
                    nextBtn.innerText = "NEXT SECTOR";
                    nextBtn.onclick = () => { 
                        document.getElementById('round-selector').value = this.currentRoundIndex + 1; 
                        this.start(); 
                    };
                } else {
                    nextBtn.classList.add('hidden');
                }
            } else { 
                nextBtn.classList.add('hidden'); 
            }
             
             if (window.fetchSRSItems) window.fetchSRSItems();
             if (window.incrementDailyLaps) window.incrementDailyLaps(); 
         }

         returnToGrid() {
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
             if (window.fetchSRSItems) window.fetchSRSItems();
         }
        
         updatePitStopButton(count) {
             const text = document.getElementById('mistake-count-display');
             const overlay = document.getElementById('pit-alert-overlay');
             if (count > 0) {
                 text.innerText = "CRITICAL"; text.classList.remove('text-green-500'); text.classList.add('text-red-500');
                 overlay.classList.remove('hidden'); overlay.onclick = () => this.startPitStop();
             } else {
                 text.innerText = "OPTIMAL"; text.classList.add('text-green-500'); text.classList.remove('text-red-500');
                 overlay.classList.add('hidden');
             }
         }
        
         startPitStop() {
             if (!this.dueMistakes || this.dueMistakes.length === 0) return;
             const vocabDue = this.dueMistakes;
             if (!vocabDue || vocabDue.length === 0) return;

             this.isPitStopMode = true; 
             
             this.questions = vocabDue.map(item => {
                 const word = item.word || item.w;
                 const meaningArray = Array.isArray(item.meaning) ? item.meaning : [item.meaning || item.m];
                 // Âæ©ÁøíÊôÇ„ÇÇ„É©„É≥„ÉÄ„É†„Å´ÊÑèÂë≥„Çí1„Å§ÈÅ∏„Å∂
                 const randomMeaning = meaningArray[Math.floor(Math.random() * meaningArray.length)];

                 const targetWord = { w: word, m: meaningArray };
                 
                 const distractors = this.getDistractors(targetWord, false);
                 const options = [randomMeaning, ...distractors].sort(() => Math.random() - 0.5);
                 
                 return { 
                     w: word, 
                     m: meaningArray, 
                     displayM: randomMeaning,
                     qText: word, 
                     aText: randomMeaning, 
                     o: options, 
                     docId: item.id, 
                     interval: item.interval || 0, 
                     repetitions: item.repetitions || 0, 
                     easeFactor: item.easeFactor || 2.5 
                 };
             });
             
             this.questions.sort(() => Math.random() - 0.5);
             this.currentIndex = 0; this.missCount = 0; this.missedWordsLog = [];
             this.currentStreak = 0; this.maxStreak = 0;
             document.getElementById('circuit-name').innerText = "SRS PIT STOP";
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('quiz-screen').classList.remove('hidden');
             
             this.startTime = Date.now();
             this.startTimer();
             this.showVocabQuestion();
         }
        
         openTelemetry() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('telemetry-screen').classList.remove('hidden');
             const mistakes = this.allMistakes || [];
             const worstWords = [...mistakes].sort((a, b) => (a.easeFactor || 2.5) - (b.easeFactor || 2.5)).slice(0, 20);
             const listContainer = document.getElementById('worst-words-list');
             if (worstWords.length === 0) listContainer.innerHTML = `<div class="text-gray-500 text-xs italic">No degradation.</div>`;
             else {
                 listContainer.innerHTML = worstWords.map(item => `
                     <div class="flex justify-between items-center bg-gray-900/40 p-3 rounded-lg border-l-2 border-red-500 mb-1">
                         <span class="font-bold text-gray-200 text-xs jp-font">${item.word || item.w}</span>
                         <span class="text-[10px] text-gray-500 font-mono">EF:${(item.easeFactor||2.5).toFixed(2)}</span>
                     </div>`).join('');
             }
             const ctx = document.getElementById('weaknessRadarChart').getContext('2d');
             if (this.telemetryChart) this.telemetryChart.destroy();
             const buckets = [0, 0, 0, 0, 0];
             mistakes.forEach(m => {
                 const int = m.interval || 0;
                 if (int <= 1) buckets[0]++; else if (int <= 6) buckets[1]++; else if (int <= 14) buckets[2]++; else if (int <= 30) buckets[3]++; else buckets[4]++;
             });
             this.telemetryChart = new Chart(ctx, {
                 type: 'bar',
                 data: { labels: ['1d', '2-6d', '2w', '1mo', 'Master'], datasets: [{ data: buckets, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'], borderColor: '#333', borderWidth: 1 }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
             });
         }
         closeOverlay(id) {
             document.getElementById(id).classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
         }

         openWordBook() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('wordbook-screen').classList.remove('hidden');
             this.bookmarkedOnly = false;
             document.getElementById('wb-filter-btn').innerText = "ALL";
             this.renderWordBook();
         }

         toggleBookFilter() {
             this.bookmarkedOnly = !this.bookmarkedOnly;
             document.getElementById('wb-filter-btn').innerText = this.bookmarkedOnly ? "FLAGGED" : "ALL";
             document.getElementById('wb-filter-btn').className = this.bookmarkedOnly 
                 ? "bg-red-600 text-white px-3 rounded border border-red-800 text-xs font-bold uppercase hover:bg-red-500 transition-colors" 
                 : "bg-gray-800 text-white px-3 rounded border border-gray-600 text-xs font-bold uppercase hover:bg-gray-700 transition-colors";
             this.renderWordBook();
         }

        // ===== FREE PRACTICE („Éï„É©„ÉÉ„Ç∑„É•„Ç´„Éº„Éâ) „É¢„Éº„Éâ =====
        startFPMode() {
            if(this.vocabRounds.length === 0) { alert("Data not loaded"); return; }
            const selector = document.getElementById('round-selector');
            this.currentRoundIndex = parseInt(selector.value);
            const selectedRound = this.vocabRounds[this.currentRoundIndex];
            
            this.fpQuestions = selectedRound.words;
            this.fpIndex = 0;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('fp-screen').classList.remove('hidden');
            
            this.showFPCard();
        }
        
        showFPCard() {
            const q = this.fpQuestions[this.fpIndex];
            document.getElementById('fp-counter').innerText = `LAP ${this.fpIndex + 1} / ${this.fpQuestions.length}`;
            document.getElementById('fp-word').innerText = q.w;
            document.getElementById('fp-meaning').innerText = q.m.join(' / ');
            document.getElementById('fp-goro').innerText = q.g ? q.g : "‚ÄªNO DATA (Ë™ûÂëÇÂêà„Çè„ÅõÊú™ÁôªÈå≤)";
            
            // Â∏∏„Å´Ë°®Èù¢ÔºàÂçòË™ûÔºâ„Åã„Çâ„Çπ„Çø„Éº„Éà
            document.getElementById('fp-front').classList.remove('hidden');
            document.getElementById('fp-back').classList.add('hidden');
        }
        
        flipFPCard() {
            const front = document.getElementById('fp-front');
            const back = document.getElementById('fp-back');
            if (!front.classList.contains('hidden')) {
                front.classList.add('hidden');
                back.classList.remove('hidden');
            } else {
                front.classList.remove('hidden');
                back.classList.add('hidden');
            }
        }
        
        nextFPCard() {
            if (this.fpIndex < this.fpQuestions.length - 1) {
                this.fpIndex++;
                this.showFPCard();
            } else {
                this.exitFPMode();
            }
        }
        
        prevFPCard() {
            if (this.fpIndex > 0) {
                this.fpIndex--;
                this.showFPCard();
            }
        }
        
        exitFPMode() {
            document.getElementById('fp-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

         renderWordBook() {
             const listEl = document.getElementById('wb-list');
             const query = document.getElementById('wb-search').value.toLowerCase().trim();
             const startVal = parseInt(document.getElementById('wb-start').value);
             const endVal = parseInt(document.getElementById('wb-end').value);

             listEl.innerHTML = '';

             let dataSrc = this.masterList.length > 0 ? this.masterList : (this.allMistakes || []);
             
             let merged = dataSrc.map((item, idx) => {
                 const srs = this.allMistakes.find(m => m.word === item.w || m.w === item.w);
                 // „Éá„Éº„Çø„Çª„É≥„Çø„Éº„Åß„ÅØÂÖ®ÊÑèÂë≥„ÇíË°®Á§∫„Åó„Åü„ÅÑ„ÅÆ„Åßjoin„Åô„Çã
                 const mStr = Array.isArray(item.m) ? item.m.join(' / ') : (item.meaning ? (Array.isArray(item.meaning) ? item.meaning.join(' / ') : item.meaning) : "");
                 
                 return {
                     w: item.w || item.word,
                     m: mStr,
                     id: idx,
                     srs: srs || null
                 };
             });

             const filtered = merged.filter(item => {
                 const matchQ = item.w.toLowerCase().includes(query) || item.m.toLowerCase().includes(query);
                 const matchBook = this.bookmarkedOnly ? (item.srs && item.srs.bookmarked) : true;
                 const wordNum = item.id + 1;
                 const matchRange = (!startVal || wordNum >= startVal) && (!endVal || wordNum <= endVal);

                 return matchQ && matchBook && matchRange;
             });

             if (filtered.length === 0) {
                 listEl.innerHTML = `<div class="text-gray-500 text-xs text-center py-4">No components found.</div>`;
                 return;
             }

             const displayLimit = 100;
             const viewData = filtered.slice(0, displayLimit);

             viewData.forEach(item => {
                 const div = document.createElement('div');
                 div.className = "flex items-center justify-between bg-gray-900/50 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors group";
                 
                 let statusColor = "bg-gray-700"; 
                 let statusText = "NEW";
                 if (item.srs) {
                     if (item.srs.interval > 14) { statusColor = "bg-green-500"; statusText = "OK"; }
                     else if (item.srs.interval > 3) { statusColor = "bg-yellow-500"; statusText = "WARN"; }
                     else { statusColor = "bg-red-500"; statusText = "CRIT"; }
                 }

                 const isBookmarked = item.srs && item.srs.bookmarked;
                 const safeW = encodeURIComponent(item.w);
                 const safeM = encodeURIComponent(item.m);
                 const displayW = item.w.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                 const displayM = item.m.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                 div.innerHTML = `
                     <div class="flex items-center gap-3 overflow-hidden">
                         <div class="w-1 h-8 ${statusColor} rounded-full shrink-0"></div>
                         <div class="text-left overflow-hidden">
                             <div class="flex items-center gap-2">
                                 <span class="text-[9px] text-yellow-500 font-mono opacity-70">No.${item.id + 1}</span>
                                 <span class="font-bold text-gray-200 text-sm jp-font truncate">${displayW}</span>
                                 <span class="text-[9px] text-gray-500 font-mono border border-gray-700 px-1 rounded">${statusText}</span>
                             </div>
                             <p class="text-[10px] text-gray-400 truncate">${displayM}</p>
                         </div>
                     </div>
                     <div class="flex items-center gap-2 shrink-0">
                         <button class="${isBookmarked ? 'text-red-500' : 'text-gray-600 hover:text-gray-400'} p-2" onclick="window.toggleBookmark('${safeW}', '${safeM}')">
                             ${isBookmarked ? 'üö©' : 'üè≥Ô∏è'}
                         </button>
                     </div>
                 `;
                 listEl.appendChild(div);
             });
             
             if(filtered.length > displayLimit) {
                  const more = document.createElement('div');
                  more.className = "text-center text-xs text-gray-600 py-2";
                  more.innerText = `...and ${filtered.length - displayLimit} more. Refine sector or search.`;
                  listEl.appendChild(more);
             }
         }
    }

    window.quiz = new HybridQuiz();
    </script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import { 
          getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, updateDoc, 
          Timestamp, orderBy, limit, runTransaction, onSnapshot, getDoc, increment,
          initializeFirestore, persistentLocalCache, 
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      // KobunÁî®Firebase Config
      const firebaseConfig = {
         apiKey: "AIzaSyC_30asSoRz9LAyYLuzYqxGhHJNWbuLvKE",
         authDomain: "kobun-b0fb5.firebaseapp.com",
        projectId: "kobun-b0fb5",
        storageBucket: "kobun-b0fb5.firebasestorage.app",
        messagingSenderId: "892077460039",
        appId: "1:892077460039:web:d2fb94787344b49087ff62",
        measurementId: "G-1RJJ1LPXS9"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      const db = initializeFirestore(app, {
          localCache: persistentLocalCache({
              tabManager: undefined 
          })
      });

      const gateScreen = document.getElementById('gate-screen');
      const startScreen = document.getElementById('start-screen');
      const loginStatus = document.getElementById('login-status');
      const gateLoginBtn = document.getElementById('gate-login-btn');
      
      window.currentUser = null;
      let unsubscribeStats = null;
      const statsRef = doc(db, "stats", "daily_global_kobun");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("Authorized Driver:", user.displayName);
          window.currentUser = user;
          loginStatus.innerText = "Syncing Telemetry Data...";
          
          if (!unsubscribeStats) {
              unsubscribeStats = onSnapshot(statsRef, (docSnap) => {
                  if (docSnap.exists()) {
                      const data = docSnap.data();
                      const todayStr = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }).split(' ')[0];
                      if (data.date === todayStr) {
                          const display = document.getElementById('daily-laps-display');
                          if(display) display.innerText = data.count;
                      } else {
                          const display = document.getElementById('daily-laps-display');
                          if(display) display.innerText = 0;
                      }
                  }
              }, (error) => {
                  console.warn("Stats sync warning:", error.message);
              });
          }

          try {
              await window.fetchSRSItems();
              
              const userNameDisplay = document.getElementById('user-name');
              if(userNameDisplay) userNameDisplay.innerText = user.displayName || "RACING DRIVER";
              
              gateScreen.classList.add('hidden');
              
              const isQuizActive = !document.getElementById('quiz-screen').classList.contains('hidden');
              const isResultActive = !document.getElementById('result-screen').classList.contains('hidden');
              
              if (!isQuizActive && !isResultActive) {
                  startScreen.classList.remove('hidden');
              }
          } catch (error) {
              console.error("Init Error:", error);
              loginStatus.innerText = "Data Sync Failed. Retrying...";
              setTimeout(() => location.reload(), 3000);
          }

        } else {
          if (unsubscribeStats) {
              unsubscribeStats();
              unsubscribeStats = null;
          }

          window.currentUser = null;
          startScreen.classList.add('hidden');
          gateScreen.classList.remove('hidden');
          loginStatus.innerText = "System Standby...";
        }
      });

      gateLoginBtn.addEventListener('click', async () => {
        loginStatus.innerText = "Connecting to Paddock...";
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } 
        catch (error) { console.error(error); loginStatus.innerText = "Access Denied."; }
      });

      window.fetchSRSItems = async () => {
        if (!window.currentUser) return;
        const CACHE_KEY = `kobun_srs_data_${window.currentUser.uid}`;
        const TIME_KEY = `kobun_srs_time_${window.currentUser.uid}`;
        const CACHE_DURATION = 12 * 60 * 60 * 1000; 

        const now = Date.now();
        const lastFetch = parseInt(localStorage.getItem(TIME_KEY) || '0');
        let allItems = [];
        let loadedFromCache = false;

        if (now - lastFetch < CACHE_DURATION && localStorage.getItem(CACHE_KEY)) {
            try {
                const rawString = localStorage.getItem(CACHE_KEY);
                if (rawString) {
                    const rawData = JSON.parse(rawString);
                    allItems = rawData.map(item => ({ 
                        ...item, 
                        nextReview: { toDate: () => new Date(item.nextReviewSeconds * 1000) } 
                    }));
                    loadedFromCache = true;
                }
            } catch (e) { 
                console.warn("Cache corrupted"); 
                localStorage.removeItem(CACHE_KEY); 
            }
        }

        if (!loadedFromCache) {
            try {
                const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
                const snapshot = await getDocs(mistakesRef);
                allItems = [];
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const nrSec = d.nextReview && d.nextReview.seconds ? d.nextReview.seconds : (Date.now()/1000);
                    allItems.push({ id: docSnap.id, ...d, nextReviewSeconds: nrSec });
                });
                localStorage.setItem(CACHE_KEY, JSON.stringify(allItems));
                localStorage.setItem(TIME_KEY, now.toString());
                allItems = allItems.map(item => ({ ...item, nextReview: { toDate: () => new Date(item.nextReviewSeconds * 1000) } }));
            } catch (e) { console.error("Telemetry Error:", e); throw e; }
        }

        const dueItems = [];
        const nowTs = Date.now() / 1000;
        
        allItems.forEach(item => { 
            if (item.nextReviewSeconds <= nowTs) {
                dueItems.push(item); 
            }
        });

        if(window.quiz) {
            window.quiz.allMistakes = allItems;
            window.quiz.dueMistakes = dueItems;
            window.quiz.updatePitStopButton(dueItems.length);
        }
      };

      window.handleSRSUpdate = async (questionObj, isCorrect) => {
        if (!window.currentUser) return;
        
        const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
        const now = new Date();
        const safeWordId = questionObj.docId || btoa(encodeURIComponent(questionObj.w)).replace(/\//g, '_').replace(/\+/g, '-');
        const targetRef = doc(mistakesRef, safeWordId);
        
        const currentParams = { 
            interval: questionObj.interval || 0, 
            repetitions: questionObj.repetitions || 0, 
            easeFactor: questionObj.easeFactor || 2.5 
        };
        
        const timeTaken = questionObj.timeTaken || 3.0;
        let nextInterval, nextRepetitions, nextEaseFactor;

        if (!isCorrect) {
            nextRepetitions = 0; 
            nextInterval = 1; 
            nextEaseFactor = Math.max(1.3, currentParams.easeFactor - 0.2); 
        } else {
            nextRepetitions = currentParams.repetitions + 1;
            
            let easeBonus = 0;
            if (timeTaken < 1.5) easeBonus = 0.3;
            else if (timeTaken > 5.0) easeBonus = -0.15;
            else easeBonus = 0.1;

            let rawEase = currentParams.easeFactor + easeBonus;
            nextEaseFactor = Math.min(3.0, Math.max(1.3, rawEase));

            if (nextRepetitions === 1) nextInterval = 1; 
            else if (nextRepetitions === 2) nextInterval = 6; 
            else nextInterval = Math.max(1, Math.round(currentParams.interval * nextEaseFactor));
        }

        const nextDate = new Date(); 
        nextDate.setDate(now.getDate() + nextInterval);
        const nextReviewSeconds = Math.floor(nextDate.getTime() / 1000);

        // Firestore‰øùÂ≠òÔºàÂÖ®ÊÑèÂë≥ÈÖçÂàó„Çí‰øùÂ≠òÔºâ
        setDoc(targetRef, { 
            word: questionObj.w, 
            meaning: questionObj.m, // ÈÖçÂàó
            nextReview: Timestamp.fromDate(nextDate), 
            interval: nextInterval, 
            repetitions: nextRepetitions, 
            easeFactor: nextEaseFactor, 
            lastReviewed: Timestamp.fromDate(now) 
        }, { merge: true })
        .catch((e) => console.error("Telemetry Failed:", e));

        try {
            const CACHE_KEY = `kobun_srs_data_${window.currentUser.uid}`;
            const rawString = localStorage.getItem(CACHE_KEY);
            let localData = [];
            if (rawString) localData = JSON.parse(rawString);

            const index = localData.findIndex(item => item.word === questionObj.w || item.id === safeWordId);
            
            const newItemState = {
                id: safeWordId,
                word: questionObj.w,
                meaning: questionObj.m,
                nextReviewSeconds: nextReviewSeconds, 
                interval: nextInterval,
                repetitions: nextRepetitions,
                easeFactor: nextEaseFactor
            };

            if (index !== -1) {
                localData[index] = { ...localData[index], ...newItemState };
            } else {
                localData.push(newItemState);
            }

            localStorage.setItem(CACHE_KEY, JSON.stringify(localData));

            if(window.quiz && window.quiz.allMistakes) {
                const memIndex = window.quiz.allMistakes.findIndex(m => m.id === safeWordId || m.word === questionObj.w);
                
                if(memIndex !== -1) {
                     window.quiz.allMistakes[memIndex] = { 
                         ...window.quiz.allMistakes[memIndex], 
                         ...newItemState,
                         nextReview: { toDate: () => new Date(nextReviewSeconds * 1000) }
                     };
                }
                
                const nowTs = Date.now() / 1000;
                window.quiz.dueMistakes = window.quiz.allMistakes.filter(item => 
                    item.nextReviewSeconds <= nowTs
                );
                window.quiz.updatePitStopButton(window.quiz.dueMistakes.length);
            }

        } catch(e) {
            console.error("Cache Update Failed:", e);
        }
      };

      window.saveRaceResult = async (data) => {
          if (!window.currentUser) return;
          try {
              const now = new Date();
              const docId = now.getFullYear() + "-" +
                  ("0" + (now.getMonth() + 1)).slice(-2) + "-" +
                  ("0" + now.getDate()).slice(-2) + "_" +
                  ("0" + now.getHours()).slice(-2) +
                  ("0" + now.getMinutes()).slice(-2) +
                  ("0" + now.getSeconds()).slice(-2) + "-" +
                  ("00" + now.getMilliseconds()).slice(-4);

              const leaderboardDocRef = doc(db, "leaderboard", docId);
              const payload = {
                  uid: window.currentUser.uid,
                  driver: window.currentUser.displayName || "Unknown Driver",
                  date: now.toLocaleString('ja-JP'),
                  timestamp: Timestamp.now(), 
                  ...data                   
              };
              await setDoc(leaderboardDocRef, payload);
          } catch (e) { console.error(e); }
      };

      window.toggleBookmark = async (safeWord, safeMeaning) => {
          if (!window.currentUser) { alert("Sign in required."); return; }
          const word = decodeURIComponent(safeWord);
          const meaning = decodeURIComponent(safeMeaning); // „Åì„Åì„ÅßÊù•„Çã„ÅÆ„ÅØÂÖ®ÊÑèÂë≥ÊñáÂ≠óÂàó

          let currentItem = window.quiz.allMistakes.find(m => m.word === word || m.w === word);
          const isCurrentlyBookmarked = currentItem && currentItem.bookmarked === true;
          const newValue = !isCurrentlyBookmarked;

          if (currentItem) {
              currentItem.bookmarked = newValue;
          } else {
              // Êñ∞Ë¶èËøΩÂä†
              // meaningÊñáÂ≠óÂàó„ÇíÈÖçÂàó„Å´Êàª„Åó„Å¶‰øùÊåÅ„Åó„Å¶„ÇÇ„Çà„ÅÑ„Åå„ÄÅË°®Á§∫Áî®„Å™„ÅÆ„ÅßÊñáÂ≠óÂàó„ÅÆ„Åæ„Åæ„Åß„ÇÇÈÅãÁî®ÂèØ
              // „Åü„Å†„ÅóSRS„É≠„Ç∏„ÉÉ„ÇØ„Åß„ÅØÈÖçÂàó„ÇíÊúüÂæÖ„Åó„Å¶„ÅÑ„Çã„ÅÆ„ÅßÊ≥®ÊÑè
              // „Åì„Åì„Åß„ÅØÁ∞°ÊòìÁöÑ„Å´ÊñáÂ≠óÂàó„ÇíÈÖçÂàóÂåñ„Åó„Å¶‰øùÊåÅ
              const mList = meaning.split(' / ');
              window.quiz.allMistakes.push({ 
                   word: word, meaning: mList, bookmarked: newValue, 
                   interval: 0, repetitions: 0, easeFactor: 2.5,
                   nextReviewSeconds: Date.now() / 1000 
              });
              currentItem = window.quiz.allMistakes.find(m => m.word === word);
          }
          window.quiz.renderWordBook(); 

          const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
          const docId = btoa(encodeURIComponent(word)).replace(/\//g, '_').replace(/\+/g, '-');
          const targetRef = doc(mistakesRef, docId);

          let safeNextReview = Timestamp.now();
          if (currentItem && currentItem.nextReviewSeconds) {
              safeNextReview = Timestamp.fromDate(new Date(currentItem.nextReviewSeconds * 1000));
          }

          try {
              await setDoc(targetRef, {
                  word: word,
                  meaning: currentItem.meaning || meaning.split(' / '), // ÈÖçÂàó„Åß‰øùÂ≠ò
                  bookmarked: newValue,
                  interval: currentItem ? (currentItem.interval || 0) : 0,
                  repetitions: currentItem ? (currentItem.repetitions || 0) : 0,
                  easeFactor: currentItem ? (currentItem.easeFactor || 2.5) : 2.5,
                  nextReview: safeNextReview
              }, { merge: true });
          } catch(e) {
              console.error("Bookmark Error:", e);
              if(currentItem) currentItem.bookmarked = !newValue;
              window.quiz.renderWordBook();
          }
      };

      window.incrementDailyLaps = async () => {
          if (!window.currentUser) return; 
          const statsRef = doc(db, "stats", "daily_global_kobun");
          const todayStr = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }).split(' ')[0];
          try {
              await runTransaction(db, async (transaction) => {
                  const sfDoc = await transaction.get(statsRef);
                  if (!sfDoc.exists()) {
                      transaction.set(statsRef, { count: 1, date: todayStr });
                  } else {
                      const data = sfDoc.data();
                      if (data.date === todayStr) {
                          transaction.update(statsRef, { count: increment(1) });
                      } else {
                          transaction.set(statsRef, { count: 1, date: todayStr });
                      }
                  }
              });
          } catch (e) { console.error(e); }
      };
    </script>
</body>
</html>
