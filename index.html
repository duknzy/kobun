<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="RB Hybrid Kobun">
    <link rel="apple-touch-icon" href="icon.png">
    <link rel="manifest" href="manifest.json">
    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Mochiy+Pop+One&display=swap" rel="stylesheet">
    <meta name="theme-color" content="#0b0e14">
    
    <title>RB Hybrid Kobun System</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        /* 数字や英語のF1っぽさは残しつつ、日本語はゴシック体へ */
        @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap');
        
        :root {
            --f1-red: #e10600;
            --rb-navy: #0b0e14;
            --neon-cyan: #00f0ff;
            --neon-green: #39ff14;
        }

        html, body {
            height: 100%;
            width: 100%;
            overflow: hidden; 
            background-color: transparent;
            color: #e2e8f0;
            /* ゴシック体指定 */
            font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", Meiryo, sans-serif;
            -webkit-font-smoothing: antialiased;
            touch-action: manipulation;
            overscroll-behavior: none;
            -webkit-user-select: none;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            padding-top: max(1rem, env(safe-area-inset-top));
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }

        #bg-video {
            position: fixed;
            right: 0;
            bottom: 0;
            min-width: 100%;
            min-height: 100%;
            width: auto;
            height: auto;
            z-index: -1;
            object-fit: cover;
            filter: brightness(0.6);
        }

        .carbon-bg {
            background-image: none;
            background-color: transparent;
        }

        /* 数字や英語ロゴ用 */
        .f1-font { font-family: 'Chakra Petch', sans-serif; }
        
        /* 日本語用（ゴシック） */
       /* 日本語用（F1仕様 明朝） */
/* 日本語用（Mochiy Pop One） */
.jp-font { 
    font-family: 'Mochiy Pop One', sans-serif;
    font-weight: 400; /* このフォントは元々太いので400でOK */
    
    /* 文字の詰まり具合を調整して間延びを防ぐ */
    font-feature-settings: "palt";
    letter-spacing: 0.05em; /* 少しだけ間隔を開けると読みやすい */
    
}

/* ターゲット単語（デカ文字） */
#target-word {
    font-family: 'Mochiy Pop One', sans-serif;
    /* 輪郭を強調してステッカーのように見せる */
    text-shadow: 
        3px 3px 0px #000, 
        0 0 15px rgba(225, 6, 0, 0.6); 
    line-height: 1.2;
}
        #app {
            height: 100%;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding: 1rem;
            position: relative;
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        #app::-webkit-scrollbar { display: none; }

        .race-card {
            background: rgba(11, 14, 20, 0.1); /* 視認性向上のため少し濃く */
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .option-btn { 
            transition: transform 0.1s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            touch-action: manipulation;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .option-btn:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.1); }
        .option-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

        .accent-f1 { accent-color: var(--f1-red); }
        .glitch-text { text-shadow: 2px 0 rgba(255,0,0,0.5), -2px 0 rgba(0,255,255,0.5); }

        .tire-btn { opacity: 0.4; transform: scale(0.95); transition: all 0.2s; border-width: 2px; }
        .tire-btn.active { opacity: 1; transform: scale(1); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .tire-soft.active { border-color: #ef4444; color: #ef4444; } 
        .tire-medium.active { border-color: #eab308; color: #eab308; } 
        .tire-hard.active { border-color: #f8fafc; color: #f8fafc; } 

        input, select { font-size: 16px !important; }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }

        .wb-scroll::-webkit-scrollbar { width: 4px; }
        .wb-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .wb-scroll::-webkit-scrollbar-thumb { background: #e10600; border-radius: 4px; }
        
        .strategy-panel-mobile {
            transition: max-height 0.3s ease-in-out, opacity 0.3s ease-in-out;
            max-height: 0;
            opacity: 0;
            overflow: hidden;
        }
        .strategy-panel-mobile.open {
            max-height: 80vh;
            overflow-y: auto;
            opacity: 1;
        }

        @media only screen and (max-width: 768px) {
            .carbon-bg {
                background-attachment: scroll; 
                min-height: 100vh;
            }
        }
        @media (min-width: 768px) {
            .strategy-panel-mobile {
                max-height: none !important;
                opacity: 1 !important;
                overflow: visible !important;
            }
        }
    </style>
</head>
<body class="carbon-bg text-sm md:text-base">

    <video autoplay muted loop playsinline poster="./F1.jpg" id="bg-video">
        <source src="./.mp4" type="video/mp4">
    </video>

    <div id="app" class="w-full max-w-6xl mx-auto flex flex-col">
        
        <div id="gate-screen" class="race-card p-8 rounded-2xl shadow-2xl text-center relative overflow-hidden animate-slide-in my-auto max-w-md mx-auto w-full">
            <h1 class="f1-font text-5xl mb-2 font-bold text-white tracking-wider">RB<span class="text-red-600">-KOBUN</span></h1>
            <p class="text-gray-400 font-mono text-xs uppercase tracking-[0.4em] mb-12">Hybrid Learning System</p>
            <button id="gate-login-btn" class="w-full f1-font bg-white hover:bg-gray-200 text-black px-8 py-4 rounded-xl font-bold tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-3 active:scale-95">
                <svg class="w-5 h-5" viewBox="0 0 24 24"><path fill="currentColor" d="M21.35,11.1H12.18V13.83H18.69C18.36,17.64 15.19,19.27 12.19,19.27C8.36,19.27 5,16.25 5,12C5,7.9 8.2,4.73 12.2,4.73C15.29,4.73 17.1,6.7 17.1,6.7L19,4.72C19,4.72 16.56,2 12.1,2C6.42,2 2.03,6.8 2.03,12C2.03,17.05 6.16,22 12.25,22C17.6,22 21.5,18.33 21.5,12.91C21.5,11.76 21.35,11.1 21.35,11.1V11.1Z" /></svg>
                Sign In
            </button>
            <p id="login-status" class="mt-6 text-[10px] text-gray-600 font-mono">System Standby...</p>
        </div>

        <div id="start-screen" class="hidden race-card p-4 md:p-6 rounded-2xl relative z-10 animate-slide-in my-auto w-full">
            
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                
                <div class="md:col-span-5 flex flex-col gap-6">
                    
                    <div class="flex justify-between items-end border-b border-gray-700 pb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                            <p id="user-name" class="f1-font text-xl text-white font-bold truncate">DRIVER</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-500 uppercase tracking-widest block">Global Daily Laps</span>
                            <span id="daily-laps-display" class="f1-font text-3xl text-white font-bold leading-none">0</span>
                        </div>
                    </div>

                    <div id="vocab-status-area" class="grid grid-cols-2 gap-4">
                        <div id="tire-status-box" class="bg-red-900/20 p-4 rounded-xl border border-red-900/30 text-center relative overflow-hidden group hover:bg-red-900/30 transition-colors">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">SRS Condition</p>
                            <span id="mistake-count-display" class="f1-font text-xl text-green-500 font-bold">OPTIMAL</span>
                            <div id="pit-alert-overlay" class="hidden absolute inset-0 bg-red-600 flex items-center justify-center cursor-pointer active:bg-red-700 transition-colors">
                                <span class="f1-font text-white font-bold animate-pulse text-sm">PIT STOP REQUIRED</span>
                            </div>
                        </div>
                        <button onclick="quiz.openTelemetry()" class="bg-blue-900/20 p-4 rounded-xl border border-blue-900/30 flex flex-col items-center justify-center hover:bg-blue-900/30 transition-colors group">
                            <span class="text-2xl mb-1 group-hover:scale-110 transition-transform">📊</span>
                            <span class="text-[10px] text-blue-300 uppercase font-bold tracking-widest">Telemetry Data</span>
                        </button>
                    </div>

                    <button onclick="quiz.startFPMode()" class="w-full f1-font bg-gradient-to-r from-blue-600 to-blue-700 hover:from-blue-500 hover:to-blue-600 text-white py-4 rounded-xl font-bold tracking-[0.2em] uppercase transition-all transform active:scale-[0.98] shadow-lg shadow-blue-900/40 text-lg border-b-4 border-blue-900 mt-4 mb-2">
                        Free Practice
                    </button>

                    <button onclick="quiz.start()" class="w-full f1-font bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 hover:to-red-600 text-white py-6 rounded-xl font-bold tracking-[0.2em] uppercase transition-all transform active:scale-[0.98] shadow-lg shadow-red-900/40 text-2xl border-b-4 border-red-900 mt-auto">
                        Start Engine
                    </button>
                </div>

                <div class="md:col-span-7 flex flex-col gap-4 border-t md:border-t-0 md:border-l border-gray-700 pt-6 md:pt-0 md:pl-8">
                    
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-gray-400">⚙️</span>
                        <h3 class="f1-font text-lg font-bold text-white tracking-widest uppercase">Race Strategy</h3>
                        <p id="strategy-summary" class="ml-auto text-[10px] text-gray-500 font-mono border border-gray-700 px-2 py-1 rounded">Setup: Standard</p>
                    </div>

                    <button onclick="quiz.toggleStrategyMenu()" id="strategy-toggle-btn" class="md:hidden w-full bg-gray-800 text-white py-3 rounded-lg font-bold text-xs uppercase mb-2">
                        Show Settings ▼
                    </button>

                    <div id="strategy-panel" class="strategy-panel-mobile space-y-6">
                        
                        <div class="flex border-b border-gray-700">
                            <button onclick="quiz.switchStrategyTab('normal')" id="tab-normal" class="px-6 py-2 text-xs font-bold text-white border-b-2 border-red-500 hover:bg-white/5 transition-colors">NORMAL GP</button>
                            <button onclick="quiz.switchStrategyTab('random')" id="tab-random" class="px-6 py-2 text-xs font-bold text-gray-500 border-b-2 border-transparent hover:text-white transition-colors">RANDOM GP</button>
                        </div>

                        <div id="strategy-normal" class="space-y-5">
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                <div>
                                    <label class="text-gray-500 text-[10px] uppercase tracking-widest block mb-2">Sector Selection</label>
                                    <div class="relative">
                                        <select id="round-selector" class="w-full bg-black/50 text-white p-3 rounded-lg border border-gray-600 focus:border-red-500 outline-none font-mono text-xs appearance-none cursor-pointer hover:bg-black/70 transition-colors" onchange="quiz.updateSummary()"></select>
                                        <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-500">▼</div>
                                    </div>
                                </div>
                                
                                <div>                                    
                                    <label class="text-gray-500 text-[10px] uppercase tracking-widest block mb-2">Custom Range</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" id="custom-start" placeholder="1" class="w-16 bg-black text-white p-3 rounded-lg border border-gray-600 text-center text-xs font-mono focus:border-red-500 outline-none">
                                        <span class="text-gray-500">-</span>
                                        <input type="number" id="custom-end" placeholder="50" class="w-16 bg-black text-white p-3 rounded-lg border border-gray-600 text-center text-xs font-mono focus:border-red-500 outline-none">
                                        <button onclick="quiz.createCustomRound()" class="flex-1 bg-gray-800 hover:bg-gray-700 text-white text-[10px] font-bold uppercase rounded-lg py-3 border border-gray-600 transition-colors whitespace-nowrap">
                                            SET
                                        </button>
                                    </div>
                                </div>
                            </div> </div> 

                        <div id="strategy-random" class="hidden space-y-4">
                            <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 rounded-xl">
                                <p class="text-[10px] text-indigo-300 mb-3 uppercase tracking-widest">Random Generator</p>
                                <div class="flex items-end gap-3">
                                    <div class="flex-1">
                                        <label class="text-[9px] text-gray-400 block mb-1">Start</label>
                                        <input type="number" id="rand-start" placeholder="1" class="w-full bg-black text-white p-2 rounded border border-gray-600 text-center text-sm font-mono">
                                    </div>
                                    <span class="text-gray-500 pb-2">-</span>
                                    <div class="flex-1">
                                        <label class="text-[9px] text-gray-400 block mb-1">End</label>
                                        <input type="number" id="rand-end" placeholder="Max" class="w-full bg-black text-white p-2 rounded border border-gray-600 text-center text-sm font-mono">
                                    </div>
                                    <div class="flex-1">
                                        <label class="text-[9px] text-yellow-500 font-bold block mb-1">Laps</label>
                                        <input type="number" id="rand-qty" placeholder="20" class="w-full bg-black text-white p-2 rounded border border-yellow-600 text-center text-sm font-mono">
                                    </div>
                                </div>
                                <button onclick="quiz.createRandomRound()" class="mt-4 w-full bg-indigo-600 hover:bg-indigo-500 text-white py-3 rounded-lg font-bold text-xs uppercase tracking-widest shadow-lg shadow-indigo-900/50 transition-all">
                                    🎲 Generate Grid
                                </button>
                            </div>
                        </div>

                        <div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3">Tire Strategy (Questions per Lap)</p>
                            <div class="grid grid-cols-3 gap-3">
                                <button onclick="quiz.setTireStrategy(10, 'soft')" id="tire-soft" class="tire-btn tire-soft bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">🔴 Soft</span>
                                    <span class="text-[10px] opacity-70">(10)</span>
                                </button>
                                <button onclick="quiz.setTireStrategy(20, 'medium')" id="tire-medium" class="tire-btn tire-medium active bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">🟡 Medium</span>
                                    <span class="text-[10px] opacity-70">(20)</span>
                                </button>
                                <button onclick="quiz.setTireStrategy(50, 'hard')" id="tire-hard" class="tire-btn tire-hard bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
                                    <span class="block text-xs mb-1">⚪ Hard</span>
                                    <span class="text-[10px] opacity-70">(50)</span>
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                             <label class="flex items-center justify-between cursor-pointer group bg-black/30 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors">
                                <span class="text-xs font-bold text-gray-300 group-hover:text-cyan-400 transition-colors flex items-center gap-2"><span class="text-cyan-400">🔄</span> REVERSE (現代語⇒古文)</span>
                                <input type="checkbox" id="reverse-mode" class="accent-f1 w-5 h-5 cursor-pointer" onchange="quiz.updateSummary()">
                            </label>
                        </div>

                        <div class="pt-4 border-t border-gray-700 relative">
                            <input type="text" id="search-input" placeholder="Quick Scan (Search)..." class="w-full bg-black text-white p-3 rounded-lg border border-gray-700 focus:border-red-500 outline-none font-mono text-sm mb-3 placeholder-gray-600">
                             <div id="search-results" class="hidden absolute top-16 left-0 right-0 bg-gray-900 border border-gray-700 rounded-lg shadow-2xl max-h-48 overflow-y-auto z-50"></div>
                            <button onclick="quiz.openWordBook()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 py-3 rounded-lg font-bold transition-all uppercase text-xs flex items-center justify-center gap-2">
                                <span>📁</span> OPEN DATA CENTER
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="telemetry-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-blue-500 h-[90%] my-auto z-40 relative absolute inset-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="f1-font text-2xl font-bold text-blue-400 tracking-widest">TELEMETRY</h2>
                <button onclick="quiz.closeOverlay('telemetry-screen')" class="text-gray-400 active:text-white text-3xl p-2 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="bg-black/50 p-2 rounded-xl mb-4 border border-gray-800 h-64 w-full relative">
                <canvas id="weaknessRadarChart"></canvas>
            </div>
            <div class="text-left mb-4 h-full overflow-hidden flex flex-col">
                <h3 class="text-xs text-red-500 font-bold uppercase tracking-widest mb-2 flex-shrink-0">Degradation Report (Worst Laps)</h3>
                <div id="worst-words-list" class="space-y-1 overflow-y-auto pr-2 flex-grow scrollbar-thin"></div>
            </div>
        </div>
        
        <div id="wordbook-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-yellow-500 h-[90%] my-auto z-50 flex flex-col absolute inset-4">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="f1-font text-2xl font-bold text-yellow-500 tracking-widest">DATA CENTER</h2>
                <button onclick="quiz.closeOverlay('wordbook-screen')" class="text-gray-400 active:text-white text-3xl p-2 hover:text-white transition-colors">&times;</button>
            </div>
            <div class="flex flex-wrap gap-2 mb-2 flex-shrink-0 justify-center items-center">
                <div class="bg-gray-900 p-2 rounded border border-gray-700 flex items-center gap-2">
                    <span class="text-[9px] text-gray-500 uppercase tracking-widest font-bold">SECTOR</span>
                    <input type="number" id="wb-start" placeholder="1" class="w-16 bg-black text-white p-1 text-sm rounded border border-gray-700 font-mono text-center focus:border-yellow-500 outline-none">
                    <span class="text-gray-500">-</span>
                    <input type="number" id="wb-end" placeholder="END" class="w-16 bg-black text-white p-1 text-sm rounded border border-gray-700 font-mono text-center focus:border-yellow-500 outline-none">
                </div>
            </div>
            <div class="flex gap-2 mb-4 flex-shrink-0">
                <input type="text" id="wb-search" placeholder="Search components..." class="flex-1 bg-black text-white p-2 text-sm rounded border border-gray-700 font-mono focus:border-yellow-500 outline-none">
                <button id="wb-filter-btn" class="bg-gray-800 text-white px-3 rounded border border-gray-600 text-xs font-bold uppercase hover:bg-gray-700 transition-colors" onclick="quiz.toggleBookFilter()">ALL</button>
            </div>
            <div id="wb-list" class="flex-1 overflow-y-auto wb-scroll text-left space-y-2 pr-1">
            </div>
        </div>

        <div id="quiz-screen" class="hidden race-card p-6 rounded-2xl shadow-2xl relative flex flex-col justify-between my-auto min-h-[500px] w-full max-w-5xl mx-auto">
            <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col text-left">
                    <span id="circuit-name" class="f1-font text-[10px] text-gray-400 uppercase tracking-widest">ROUND 1</span>
                    <span id="question-number" class="f1-font text-white font-bold text-lg">LAP 1/20</span>
                </div>
                <div class="text-right">
                    <div id="timer" class="f1-font text-2xl text-yellow-400 font-mono">0.00s</div>
                    <div id="streak-display" class="f1-font text-[10px] text-green-500 font-bold uppercase tracking-widest hidden">PURPLE SECTOR</div>
                </div>
            </div>
            <div class="w-full bg-gray-800 h-1 mb-8 rounded-full overflow-hidden">
                <div id="progress-fill" class="bg-gradient-to-r from-red-600 to-yellow-500 h-full w-0 transition-all duration-300"></div>
            </div>
            
            <div id="vocab-interface" class="flex-grow flex flex-col justify-between">
                <div class="flex-grow flex flex-col items-center justify-center mb-8 relative">
                    <div class="absolute -top-6 text-gray-500 text-[10px] uppercase tracking-widest" id="question-label">Target</div>
                    <h2 id="target-word" class="jp-font text-5xl md:text-7xl font-bold text-white tracking-wide drop-shadow-xl break-words px-2 text-center transition-all"></h2>
                </div>
                
                <div id="options-container" class="grid grid-cols-2 gap-4 max-w-4xl mx-auto w-full"></div>
            </div>

            <div id="feedback" class="h-8 mt-4 flex items-center justify-center text-sm font-bold tracking-wider uppercase"></div>
        </div>

        <div id="fp-screen" class="hidden race-card p-6 rounded-2xl shadow-2xl relative flex flex-col justify-between my-auto min-h-[500px] w-full max-w-2xl mx-auto border-t-4 border-blue-500">
            <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col text-left">
                    <span class="f1-font text-[10px] text-blue-400 uppercase tracking-widest">FREE PRACTICE</span>
                    <span id="fp-counter" class="f1-font text-white font-bold text-lg">LAP 1/20</span>
                </div>
                <button onclick="quiz.exitFPMode()" class="text-gray-400 hover:text-white transition-colors">
                    <span class="f1-font font-bold text-xs uppercase border border-gray-600 px-3 py-1 rounded">BOX (戻る)</span>
                </button>
            </div>
            
            <div onclick="quiz.flipFPCard()" class="flex-grow flex flex-col items-center justify-center cursor-pointer bg-white/5 hover:bg-white/10 border border-white/20 rounded-2xl p-8 transition-colors relative min-h-[300px]">
                <div class="absolute top-4 right-4 text-gray-500 text-[10px] uppercase tracking-widest animate-pulse">Tap to Flip</div>
                
                <div id="fp-front" class="text-center">
                    <h2 id="fp-word" class="jp-font text-5xl md:text-7xl font-bold text-white tracking-wide drop-shadow-xl break-words px-2 leading-tight"></h2>
                </div>
                
                <div id="fp-back" class="hidden text-center w-full">
                    <h3 class="text-xs text-red-500 font-bold uppercase tracking-widest mb-2 border-b border-red-900/50 pb-1">Meaning</h3>
                    <p id="fp-meaning" class="jp-font text-2xl md:text-4xl font-bold text-white mb-8"></p>
                    
                    <h3 class="text-xs text-blue-400 font-bold uppercase tracking-widest mb-2 border-b border-blue-900/50 pb-1">Telemetry (語呂合わせ)</h3>
                    <p id="fp-goro" class="jp-font text-lg md:text-xl font-bold text-yellow-300"></p>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 mt-6">
                <button onclick="quiz.prevFPCard()" class="f1-font bg-gray-800 hover:bg-gray-700 text-white py-4 rounded-xl font-bold transition-all uppercase text-sm tracking-wider active:scale-95 border border-gray-600">◀ PREV</button>
                <button onclick="quiz.nextFPCard()" class="f1-font bg-blue-600 hover:bg-blue-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-blue-900/50 uppercase text-sm tracking-wider active:scale-95">NEXT ▶</button>
            </div>
        </div>
        
        <div id="result-screen" class="hidden race-card p-8 rounded-2xl shadow-2xl text-center animate-slide-in my-auto max-w-2xl mx-auto w-full">
            <h2 id="result-title" class="f1-font text-4xl mb-2 font-bold text-white italic tracking-tighter">CHECKERED FLAG</h2>
            <div class="w-full h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent opacity-50 mb-8"></div>
            
            <div id="accuracy-display" class="f1-font text-8xl font-bold mb-2 text-white glitch-text tracking-tighter">95.0%</div>
            <p id="rank-text" class="f1-font text-sm mb-8 text-gray-400 font-mono">P1: MAX VERSTAPPEN</p>
            
            <div id="pass-area" class="hidden mb-8 animate-slide-in">
                <p class="text-[#39ff14] font-bold f1-font text-xl mb-3 tracking-widest">LICENSE ACQUIRED</p>
            </div>
            
            <div id="fail-msg" class="hidden mb-8">
                <p class="text-red-500 font-bold f1-font text-sm tracking-widest">LICENSE DENIED (Req: 90%)</p>
            </div>

            <div class="bg-black/40 p-4 rounded-xl mb-8 text-left max-h-48 overflow-y-auto border border-gray-800 scrollbar-thin" id="review-list"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="quiz.returnToGrid()" class="f1-font border border-gray-600 hover:bg-gray-800 text-white py-4 rounded-xl font-bold transition-all uppercase text-sm tracking-wider">Garage</button>
                <button id="next-round-btn" class="f1-font bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-red-900/50 uppercase text-sm tracking-wider">Next Sector</button>
            </div>
        </div>
    </div>

    <script>
      // ★ここに古文データを貼り付けてください
      const rawData = `
あいなし: つまらない | 気に食わない | むやみに // 愛なし（あいなし）ではつまらない、むやみに気に食わない 
あかず（飽かず）: 物足りない | 満足しない | 嫌にならない // 開かず（あかず）の扉じゃ物足りない、嫌にならない 
あからさまなり: ついちょっと | 急に // アッ！カラス様（あからさまなり）急に、ついちょっと 
あきらむ（明らかむ）: 明らかにする // アキラむっ（あきらむ）つり、明らかにする 
あく（飽く）: 満足する | 嫌になる // 悪（あく）魔、満足するがやがて嫌になる 
あくがる: さまよい歩く | 上の空になる // アークがルンルン（あくがる）さまよい歩いて上の空 
あさまし: 驚きあきれる | 情けない | 興ざめだ | 話にならない | ひどい // 朝は目覚まし（あさまし）に驚き呆れて情けない 
あざむ（蔑む・侮る）: 見下す | 欺く // 朝むらさき（あざむ）式部を見下す、馬鹿にする 
あし（悪し）: 悪い | 下手だ | 卑しい // アシカのショーが（あし）悪い、下手だ 
あだなり（徒なり）: 浮気なさま | 無駄なさま | はかない // あーだこーだ（あだなり）浮気は無駄よ、はかないわ 
あたらし（惜し）: もったいない | 惜しい // ああ、たらし（あたらし）ちゃった、もったいない、惜しい 
あぢきなし: つまらない | どうしようもない | 道理に合わない // アジ着なし（あぢきなし）、つまらない、どうしようもない 
あてなり（宛なり）: 身分が高い | 高貴である | 上品だ // 宛名（あてなり）書き、身分が高くて上品だ 
あながちなり（強ちなり）: 無理やりだ | むやみだ // 穴がちいさい（あながち）、むやみに無理やりだ 
あはれなり: しみじみとする | 可愛い // ああ、晴れ（あはれ）なり、しみじみとする 
あふ（会ふ・逢ふ）: 結婚する | 出会う | 出くわす // ああ、ふと（あふ）結婚する 
あまた（数多）: たくさん // 余った（あまた）たくさん 
あやし（怪し・賤し）: 不思議だ | 卑しい | 粗末だ // あや、シーツが不思議だ、いやしい、粗末だ 
〜まほし: 理想的だ | 〜したい // あー、魔法（まほし）使いたい、理想的だ 
ありがたし（有り難し）: 珍しい | 生きていくのが困難だ | 優れている // ありが足し（ありがたし）算、めずらしい、生きづらい、すぐれている 
ありく（歩く）: 歩き回る | 〜し続ける // アリ食い（ありく）歩き回る 
いうなり（優なり）: 上品だ | 素晴らしく良い // 言うなり（いうなり）上品で素晴らしい 
いかがせん: どうしようか | どうしようもない // イカが千円（いかがせん）、どうしようか、どうしようもない 
いかで: なんとかして | どうして | どうやって（反語あり） // イカでかい（いかで）のはどうして、なんとかして 
いたし（甚し）: 甚だしい | 素晴らしい | たいそう | 苦痛である // 痛し（いたし）甚だひどいし苦痛だ、でもたいそう素晴らしい 
いたづらなり: 無駄である | むなしい | 何もない // いたずら（いたづらなり）しても無駄である、むなしい 
いつしか: 早く // いつ鹿（いつしか）早く見たい 
いとど: いっそう | その上 | さらに // いいトド（いとど）いっそう頑張る 
いとほし: 気の毒だ | 可愛い // 伊藤氏（いとほし）気の毒だ、かわいい 
いはけなし: 子供っぽい // 言い訳なし（いはけなし）よ、子供だな 
いふかひなし（言ふ甲斐なし）: どうしようもない | つまらない | 身分が低い // 言う甲斐なし（いふかひなし）どうしようもない、つまらない 
いぶせし: 憂鬱だ | 不快だ // 井伏氏（いぶせし）、憂鬱で不快だ 
いはむかたなし（言はむ方なし）: 言い尽くせない // イワンの肩なし（いはむかたなし）なんとも言いようがない 
いへばさらなり（言へば更なり）: 言うまでもない // 言えばサラリーマン（いへばさらなり）言うまでもない 
いみじ: 程度が甚だしい | 素晴らしい | ひどい // いいミジンコ（いみじ）甚だ素晴らしい、いやひどい 
いらふ（答ふ）: 返事する // イラッ！ふられて（いらふ）返事する 
うし（憂し）: つらい | 気に食わない | つれない // 牛（うし）はつらい、気に食わない 
うしろめたし: 心配だ | 後ろ暗い // 後ろの目、確か（うしろめたし）に心配だ 
うしろやすし（後ろ安し）: 安心だ // 後ろに安し（うしろやすし）さん、安心だ 
おどろおどろし: ますますひどく | 異様に | 気味が悪い // 踊ろ踊ろ尻（おどろおどろし）振るとますますひどく気味が悪い 
うつくし: かわいい | きれいだ | 立派だ // うっ、つくし（うつくし）かわいい、立派だ 
うるはし: 端麗である | 整っていて美しい | 格式ばっている // ウールはしっかり（うるはし）端麗だ、きちんと整っている 
え〜ず: 〜することができない // えーっ、ずっと（え〜ず）できないの 
おくる（後る・遅る）: 取り残される | 先立たれる | 劣る // オークル（おくる）塗るのが遅れる、劣る 
おこたる（怠る）: 病気が治る | 快方に向かう | 怠ける // おこた（おこたる）で病気が治る 
おこなふ（行ふ）: 仏道修行する | 勤行する // お粉（おこなふ）フリフリ仏道修行する 
おとなし（大人し）: おとなびている | 思慮分別がある | 主だっている // 大人しい（おとなし）子は大人びている 
おとにきく（音に聞く）: 噂に聞く | 評判が高い // 夫に聞く（おとにきく）と評判が高いとの噂だ 
おどろく: ハッとして気づく | 目が覚める | びっくりする // おっと6時（おどろく）！ハッと気づいて目が覚める 
おのづから: ひょっとして | 偶然 | 自然と // 小野塚ら（おのづから）ひょっとして偶然自然に
おはす: いらっしゃる // 大橋（おはす）の上にいらっしゃる
おぼえ: 評判 | 寵愛を受けること // オーボエ吹き（おぼえ）は評判いい、寵愛して
おほす: おっしゃる | 命じる // おーボスと（おほす）おっしゃる
おぼす: お思いになる // おーボスが（おぼす）お思いになる
おほせらる: おっしゃる // おおセールある（おほせらる）とおっしゃる
おぼつかなし: 気がかりだ | ぼんやりとしている | 待ち遠しい // おーボツ悲しい（おぼつかなし）気がかりだ
おほとのごもり: お休みになる // おお殿ごもり（おほとのごもり）とお休みになる
おほやけ: 宮中 | 天皇 // 大やけど（おほやけ）しちゃった宮中
おぼゆ: 自然に思われる | 思い出される | 似ている // お盆の湯（おぼゆ）に似ていると思われる
おぼろげなり: 普通だ | 格別だ // おーボロ儲け（おぼろげ）普通だ、いや格別だ
おろかなり: いい加減だ | 未熟だ // おー廊下（おろか）掃除がいい加減だ、未熟者
かこつ: 他のせいにする | 不平を言う // カッコつける（かこつ）な、他のせいにして不平を言う
かしこし: 恐れ多い | 非常に都合が良い // 貸しコシヒカリ（かしこし）非常に恐れ多い
かしづく: 大切に育てる | 大切に世話をする // 菓子づくり（かしづく）大切に育てる
かしらおろす: 出家する // 頭下ろす（かしらおろす）と出家する
かたち: 容貌 | 形 // 形（かたち）が良いのはご容貌
かたちをかふ: 出家する // 形を変ふ（かたちをかふ）と出家する
かたはらいたし: 苦々しい | 気恥ずかしい // 片腹いたし（かたはらいたし）そばで見ていて恥ずかしい
かたみに: 互いに // 形見に（かたみに）しよう、お互いに
かちより: 徒歩で // 徒歩（かち）より徒歩で
かなし: 悲しい | 可愛い | かわいそうだ // 悲しい（かなし）くらい君かわいい
か: 〜か | いや〜ではない // か、いや（か）そうじゃない
きこしめす: お聞きになる | 召し上がる // キノコしめじ（きこしめす）を召し上がる
きこゆ: 申し上げる | 評判である | わかる // 「聞こゆー？（きこゆ）」と申し上げる
ぐす: 備わる | 連れて行く // ぐっすり（ぐす）寝たまま連れて行く
くちをし: 残念だ | つまらない // 口惜し（くちをし）い、残念だ
けしき: 様子 | 意向 | 顔色 | 機嫌 // 毛、しきり（けしき）にはみ出す顔色・様子
げに: その通り | 本当に // げっ！忍者（げに）その通り本当に
こころざし: 愛情 | 贈り物 | 供養 // こころざし（こころざし）は愛情ある贈り物
こころづきなし: 気に食わない | 心に惹かれない // 所づきあいなし（こころづきなし）で気に食わない
こころづくし: あれこれと物を思うこと // 心づくし（こころづくし）の物思い
こころにくし: 奥ゆかしい | 上品だ // 心憎し（こころにくし）いほど奥ゆかしい
こころもとなし: じれったい | 不安だ | ぼんやりとしている // 心元金なし（こころもとなし）不安だ、じれったい
こそ〜已然形: 〜だけれども // こそ（こそ）〜だけれども
ことわりなり: 物の道理 | わけ | 当然である // 琴割ります（ことわりなり）、道理で当然
さうざうし: 心寂しい // 想像し（さうざうし）て心寂しい
さだかなり: 簡単だ | またとない // 定か（さだか）だ、はっきりしている
さかし: 賢い | 気丈だ | 小賢しい // 坂下（さかし）かしこい、こざかしい
さすがに: そうは言ってもやはり // さすがに（さすがに）そうは言ってもやはり
さながら: そのまま | 元のまま | 全部 | 全然 // サナギから（さながら）そのまま全部
さて: どうにでもなれ | しかし | そのまま // さて（さて）そのまま
さぶらふ: お仕えする | 〜でございます | 参上する // 三郎（さぶらふ）お仕えする
さへ: 〜までも // サルへ（さへ）までも
さらなり: 言うまでもない // サラリーマン（さらなり）になるのは言うまでもない
さればよ: やっぱりね | 思った通りだ // さればよ（さればよ）思った通りだ
しどけなし: くつろいでいる | だらしがない // シーツどけ、梨（しどけなし）くつろぐ、だらしない
しのぶ: 人目を避ける | 恋い慕う | 我慢する // 忍ぶ（しのぶ）ちゃん人目避けて我慢する
しるし: はっきりしている | 予想通り | 霊験 // シールしっかり（しるし）効き目はっきり
すき: 風流 | 好色 // スキンヘッド（すき）は風流だ
すさまじ: 興ざめだ | 寒々としている // スーさんマジ（すさまじ）今日サメですぞ
すずろなり: なんとなく | 思いがけない | やたらに | 関係ない // 鈴六個（すずろ）も、なんとなく思いがけない
ずちなし（術なし）: どうしようもない // ずっとチューなし（ずちなし）ではどうしようもない
すなはち: すぐに | 即座に | そこで // 砂鉢（すなはち）割れてすぐに即座に
せうそこ（消息）: 手紙 | 訪れること // セイウチそこそこ（せうそこ）手紙を書いて訪れる
たてまつる: 差し上げる | お召しになる | お乗りになる | 召し上がる // 立て！待つって（たてまつる）差し上げる
だに: 〜だけでも | 〜さえ // ダニ（だに）に刺されるだけでも、〜さえ
たのむ（頼む）: あてにする | 信頼する | あてにさせる // 頼む（たのむ）男にあてにする
たまふ（給ふ）: お与えになる | 〜なさる | 〜ております // 給ふ（たまふ）お与えになって、なさる、ております
たまはす: お与えになる | なさる // タマはスッ（たまはす）とお与えになる
たまはる（賜る）: いただく | お与えになる // 魂、春（たまはる）にいただく
ちぎり（契り）: 約束 | 前世の因縁 | 男女の縁 // 契り（ちぎり）を結んだ約束は前世の因縁
ついで（序）: 機会 | 順番 // ついで（ついで）の機会に順番待ち
つきづきし: 似合っている | 調和している // 月々（つきづき）シャツ、似合っている
つとめて: 早朝 | その翌朝 // 勤めて（つとめて）て、早朝、その翌朝
つゆ〜（打消）: まったく〜ない // 汁（つゆ）少しもこぼさない、まったくない
つれづれなり: 手持ち無沙汰だ | どうしようもなく退屈だ | 変化がない // 連れヅレヅレ（つれづれ）で手持ち無沙汰だ
つれなし: 予想を裏切って平然としている | そ知らぬ顔だ // 杖なし（つれなし）で平然としている、そ知らぬ顔だ
てしがな・にしがな: 〜したいものだ // てしかにしか（てしがな・にしがな）食いたいものだ
ときめく: 時世に合って栄える | 寵愛される // ときめく（ときめく）心、寵愛される
とく（疾く）: 早く | すぐに // とくとく（とく）早くすぐに
ところせし（所狭し）: 場所が狭い | 窮屈だ | いばっている | 大げさだ // 所狭し（ところせし）と窮屈だなんて大げさだ
としごろ（年頃）: 長年 | 数年来 // 年頃（としごろ）は長年続かない
とみなり（頓なり）: 急だ | 急なこと // トミー君（とみ）は急だな
な〜そ: 〜するな // なー、そこ（な〜そ）でするな
なかなかなり: 中途半端だ | かえってしない方が良い | 生じっか // なかなか（なかなか）かえってしない方が良い
ながむ（眺む・詠む）: 物思いに沈む | 歌を詠む // 長嶋（ながむ）物思いに沈む、歌を詠む
なさけ（情け）: 思いやり | 風情 | 男女間の愛情 // なさけ（なさけ）には風情がある、思いやりも
なつかし: 心惹かれる | 親しみやすい // 懐かしい（なつかし）映画に心惹かれる
なでふ: どうして | なんという | どういう // なでる（なでふ）ふりしてどうして打つの
など: どうして // など（など）どうして
なのめなり: 平凡だ | いい加減だ | 格別に // 何の目（なのめ）？平凡な目、いや格別だね
なべて: すべて | 普通に | ひと通りでない | 一面に // 鍋って（なべて）普通、すべて
なほ（尚）: やはり | さらに | それでも // なお（なほ）やはり、さらに
なほざりなり: いい加減だ | ほどほどだ // なおザリガニ（なほざりなり）の世話がいい加減だ
なまめかし: 優美だ | みずみずしく美しい | 色っぽい // 生めかしい（なまめかし）優美ちゃんはみずみずしい
未然形＋なむ: 〜してほしい // 未然にナムル（未然＋なむ）〜してほしい
なやむ（悩む）: 病気になる | 非難する | 苦しむ // 悩む（なやむ）と病気になって苦しむ
にほふ（匂ふ）: つややかに美しい | 色づく | 香りが漂う | 栄える // 日本のフン（にほふ）つややかに美しい
ねんごろなり（懇ろなり）: 丁寧だ | 睦まじい | 熱心だ // 粘土ゴロゴロ（ねんごろ）丁寧に熱心だ
ねんず（念ず）: 心の中で祈る | 我慢する // 捻挫（ねんず）したけど我慢する
のたまふ: おっしゃる // 脳足りん（のたまふ）とおっしゃる
ののしる: 大声で言い騒ぐ | 評判が立つ | 今をときめく // 脳の汁（ののしる）大声で言い騒ぐ
はかなし: 頼りない | むなしい | ちょっとした | 取るに足らない // 墓なし（はかなし）わ、ちょっと頼りなくて虚しいわ
はかばかし: テキパキしている | 際立っている | しっかりしている // 墓場で貸し借り（はかばかし）しっかりしている
はしたなし: 中途半端だ | みっともない | 捨て置けない // 端足んない（はしたなし）中途半端でみっともない
ばや: 〜したい // 婆や（ばや）は〜したい
ひがこと（僻事）: 間違い | 悪事 // 火がゴウゴウと（ひがこと）燃えたら間違いだ
びんなし（便なし）: 不都合だ | 気の毒だ // ビンなし（びんなし）ジャムなんて不都合だ、気の毒だ
ふみ（文・書）: 書物 | 手紙 | 漢字 | 漢詩 // 文（ふみ）を読んで手紙、漢詩
ほい（本意）: 本来の意志 | 出家の願い // ほいほい（ほい）出家が本来の目的
ほいなし: 物足りない | 不本意だ // 恋なし梨（ほいなし）ジャム、足らないし不本意だ
ほだし: 足手まとい | 修行の妨げ // 放り出した足（ほだし）は足手まとい、修行の妨げ
ほど: 程度 | 身分 | 時間 // ほどける（ほど）程度や身分
まうけ: 準備 | ごちそうの準備 // 儲け（まうけ）たらごちそうの準備
まめなり: 真面目だ | 実用的だ | 勤勉だ // マメなやつ（まめなり）は真面目で実用的だ
まもる: 見つめる | 見張る // 魔物くんを（まもる）じっと見つめる
まゐる: 参上する | 差し上げる | 召し上がる // まあイルカを（まゐる）差し上げに参上する
みそかなり: こっそり // 味噌カニを（みそかなり）こっそり食う
むげなり: この上なくひどい | 身分が低い | むやみに | 全く // 無限にひでえ（むげなり）、この上なくひどい
むつかし: 嫌だ | 鬱陶しい // 難しい（むつかし）試験は嫌で鬱陶しい
めざまし: 素晴らしい | 呆れるほどひどい | 気に食わない // 目覚まし（めざまし）鳴って素晴らしく気に食わない
めづ: 愛する | 褒める | 感心する // 目ぇずっと（めづ）見つめて愛する、感心だ
めでたし: 素晴らしい | 喜ばしい // 目出たし（めでたし）、しっかり素晴らしい
もがな: 〜があればなあ // もが（もがな）がいればなぁ
もぞ・もこそ: 〜すると困る | 〜すると大変だ // もぞもぞ（もぞ・もこそ）されると困る、大変だ
やうやう: だんだん // ヨーヨー（やうやう）だんだん上手になる
やがて: そのまま | すぐに // 矢が手（やがて）に刺さったまま、すぐに
やすし: 心穏やかだ | 簡単だ // 安い（やすし）寿司でも簡単に心穏やかになる
やすらふ: ためらう | 佇む | 滞在する // 安いピラフ（やすらふ）は注文ためらって佇む
やは: 〜か | いや〜ではない // ヤマハ（やは）のバイクか、いやそうじゃない
やはら: そっと | 静かに // やはら（やはら）そっと静かに
やむごとなし: 捨てては置けない | 格別だ | 身分が高い // やー見事な梨（やむごとなし）身分が高くて格別だ
ゆかし: 知りたい | 心惹かれる // 床下（ゆかし）知りたい、心惹かれる
ゆめゆめ: 決して〜ない | 全く〜ない // 夢々（ゆめゆめ）見るな、決して〜ない
ゆゆし: 恐れ多い | 甚だしい | 素晴らしい | ひどい | 不吉だ // UCCコーヒー（ゆゆし）なんて甚だ不吉だ、いや素晴らしい
よし: よい | 手段 | 理由 | 風情 // よし子（よし）ちゃん風情ある、手段と理由がよい
よしなし: 理由がない | 関係がない | つまらない // ヨッシー死な（よしなし）い、つまらんし理由も手段もない
よも〜じ: まさか | 決して〜ない // よもやまさか痔（よも〜じ）になるまい
れいの: いつもの | いつものように | 普通の // 例の（れいの）奥でいつもの普通のですね
わびし: 寂しい | つらい | 物悲しい // わさびしんどい（わびし）つらくて物悲しい
わりなし: 無茶苦茶だ | つらい | 仕方がない // 割り算梨（わりなし）じゃむちゃくちゃだ、つらいし仕方がない
ゐる: 座っている | 連れている | 連れて行く // イルカくんが（ゐる）座っているから連れて行こう
をかし: 趣がある | おかしい | 可愛い | 興味深い // お菓子（をかし）食べると趣がある、可愛い
をさをさ〜: めったに〜ない // おさるを刺（をさをさ）すこと、めったに〜ない
らうたし: かわいらしい | 優しく魅力的なこと // ラフな格好たしかに（らうたし）可愛い
あかぬわかれ: 名残惜しい別れ // あかん（あかぬ）別れは名残惜しい
あげつらふ: 議論する // 揚げ豆腐（あげつらふ）食いながら議論する
あした: 朝 | 翌朝 // 明日の（あした）朝は翌朝だ
あそばす: 〜なさる // ああソバカス（あそばす）だらけになさる
あそび: 管弦 | 芸能 // 遊び（あそび）といえば管弦の芸能
あつかふ: 世話をする | 病人の世話をする // あっ、ツタンカーメン（あつかふ）病人の世話をする
あつし: 重病だ | 気の毒だ // 淳の（あつし）ばあちゃん重病だ
あんない: 取次 | 事情 // あ、ナイス（あんない）取次事情
あなかしこ: 決して | ああ恐れ多いこと // 穴にカシコ（あなかしこ）い人、ああ恐れ多い、決して〜するな
あなかま: 静かに // 穴で釜（あなかま）ゆで、ああうるさい、静かに
あなづらはし: 馬鹿にしたくなる | 遠慮がいらない // あなたのヅラは（あなづらはし）馬鹿にしたくなる、遠慮がいらない
あなり: あるようだ | あるそうだ // あ、なるほど（あなり）あるようだ、あるそうだ
あへず: 耐えられない | 〜しようとしてもできない // ああ屁出ず（あへず）、耐えられない
あやなし: 訳がわからない | つまらない | やたらに // あや、梨（あやなし）がやたらにある、わけがわからない
あやにくなり: 意地悪だ | 都合が悪い // あや、肉（あやにく）ないとは意地悪だ、都合が悪い
あらがふ: 言い争う | 競争する // 新井が二人（あらがふ）言い争う
あらぬ: 意外だ | 無関係だ // アナの（あらぬ）噂とは意外にも無関係
あらはなり: 丸見えだ | 明白だ // あー半裸（あらはなり）丸見えだ
あらまし: 計画 | 全体 // あら、マシ（あらまし）な計画全体
ありつる: さっきの // アリとツル（ありつる）さっきの店
あれかにもあらず: ぼーっとしている // あれ？カニもあらず（あれかにもあらず）ぼーっとしている
いかめし: 盛大である | 激しい | おごそかだ // いかめし（いかめし）盛大でおごそかだ
いぎたなし: ぐっすり眠っている | 寝坊である // いいギターなし（いぎたなし）で寝坊する
いさ: さあどうかな // 勇（いさ）さん、さあどうかな
いざたまへ: さあ、いらっしゃい // いざ多摩へ（いざたまへ）さあいらっしゃい
いそぎ: 準備 | 急用 // 急ぎ（いそぎ）の準備
いたづらになる: 死ぬ // いたずら見つかって（いたづらになる）死ぬ
いたはる: 病気になる | 大切に世話をする // 板貼る（いたはる）病気になって大切に世話をする
いつく: 大切に育てる | 神に仕える // いーつくし（いつく）大切に育てる
いとけなし: 子供っぽい // いい時計じゃなし（いとけなし）子供っぽい
いとひすつ: 出家する // 伊藤婦人を捨てて（いとひすつ）出家する
いなぶ: 断る // 稲ぶつける（いなぶ）、いや断る
いはむかたなし: なんとも言いようがない // イワンの肩なし（いはむかたなし）なんとも言いようがない
いぶかし: 気がかりだ | 知りたい | 不審だ // イブ、貸し（いぶかし）が気がかりだ、知りたい
いまいます: いらっしゃる | お出かけになる // 今、います（いまいます）よ、いらっしゃる
いまめかし: 現代風 // 今おめかし（いまめかし）するのが現代風
うけたまはる: お受けする | お聞きする // 受けた、まー春（うけたまはる）をお受けする
うしろみ: 後見 | 世話をすること // 後ろで見（うしろみ）ている後見人
うしなふ: 死ぬ | なくなる // 牛なくす（うしなふ）と死ぬ
うたてし: 嫌だ | 情けない // 歌ってしまう（うたてし）の嫌だ情けない
うち: 宮中 | 天皇 // うち（うち）は宮中、天皇
うちいづ: 口に出して言う // ウッチー出っ歯と（うちいづ）口に出して言う
うちつけなり: 突然である | 軽率である // 打ち付け（うちつけ）ちゃったよ突然に
うつつ: 現実 | 正気 // うつつ（うつつ）を抜かさず現実に
うつろふ: 色あせる | 心変わりする | 移り住む // うつろ（うつろふ）な目で心変わり
うとし: 親しくない | よく知らない | 鬱陶しい // ウッ！年の差（うとし）、よく知らないから親しくない
うるさし: 面倒だ | 嫌味だ // うるさいし（うるさし）面倒で嫌味だな
え〜さらず: 避けられない // エイ、皿ずっと（え〜さらず）避けられない
えんなり: 優美だ | 色っぽい | 思わせぶりだ // 円なり（えんなり）優美だ、色っぽい
おいらかに: おっとりしている | 気楽だ | 率直に // おいらカニ（おいらかに）おっとりしている
おこす: こちらへ送ってくる // 起こす（おこす）とこちらへ送ってくる
おと: 評判 | 頼り // 夫（おと）の評判を頼りにする
おとづる: 訪ねる | 音を立てる // お父ちゃんずるずる（おとづる）音を立てて訪ねる
おどろかす: 起こす | 気づかせる // 驚かして（おどろかす）わっと起こす
おはします: いらっしゃる // お箸増す（おはします）いらっしゃる
おほけなし: 身分不相応だ | 恐れ多い // 大毛なし（おほけなし）身分不相応だ
おもしろし: 趣がある | 興味深い // 面白い（おもしろし）城は趣深い
おもてをふす: 面目を失わせる | 顔を潰す // おもてを伏す（おもてをふす）と顔を潰す
おもはずなり: 意外だ // 思わず鳴り（おもはずなり）響いて意外だ
おもひやる: 想像する | 気を晴らす // 思いをやる（おもひやる）と気を晴らす
およすぐ: 大人になる | おとなびる // お嫁すぐ（およすぐ）に大人になる
かひまみる: 覗き見る // 貝まみれ（かひまみる）を覗き見る
かぎり: 限界 | 臨終 | 全部 | 機会 // 鍵リリリ（かぎり）限界、臨終
かくれ: 死ぬ | 隠れる // 隠れ（かくれ）て死ぬ
かしかまし: やかましい // 貸しカマシ（かしかまし）やかましい
かたくななり: 見苦しい | 物分かりが悪い | 頑固だ // かたくなに（かたくななり）見苦しい、物分かりが悪い
かたし: 難しい // 肩し（かたし）てもらうの難しい
かたは: 不完全 | そば | 片方 // 片方（かたは）だけじゃ不完全だ
かたらふ: 結婚する | 親しく語り合う // 語らふ（かたらふ）うちに結婚する
かつ: 一方では | すぐに | その上 // カツ（かつ）一方ですぐに食う
かづく: 水中に潜る | 褒美としていただく | 与える // 家族（かづく）で潜って褒美をもらう
〜ばかり: そのくらい // 馬鹿に（ばかり）するなそのくらい
さばかり: そのくらい // 鯖、カニ（さばかり）そのくらい
からし: つらい | ひどい | 危ない // からし（からし）はつらい、危ない
〜がり: 〜のところへ // ガリ（がり）のところへ
かる: 離れる // 軽（かる）く離れる
きぬぎぬ: 男女が別れること // 着ぐるみヌギヌギ（きぬぎぬ）別れ
きは: 身分 | 程度 | 端 // キー（きは）は身分
きよらなり: 美しい | 清らかである | 潔い // 清原（きよらなり）美しい
くまなし: 抜け目がない | 限りがない // クマ、梨（くまなし）食う、抜け目がない
けいす・そうす: 申し上げる（皇太子・天皇へ） // けいすけ（けいす）皇太子、宗介（そうす）天皇に申し上げる
けうなり: 美しい | 珍しい // 毛売る（けうなり）、珍しい、美しい
けしからず: 不都合だ | 異常だ // けしからんずら（けしからず）は異様で不都合だ
けしきばむ: 様子が外に現れる | 気取る // 毛、しきりに番（けしきばむ）犬気取る
けむ: 〜しただろう // 煙（けむ）見えた、〜しただろう
ここち: 病気 | 気持ち // ここちょっと（ここち）病気
ここのへ: 宮中 // ここの部屋は（ここのへ）宮中みたい
ここだ・そこだ: たくさん | ひどく // ここだそこだ（ここだ・そこだ）たくさん
こころあり: 思いやりがある | 風情がある | 道理がわかる // 所アリ（こころあり）は思いやりがあって風情がある
こころぐるし: 気の毒だ | 気がかりだ // 心が苦しい（こころぐるし）のは気の毒だし気がかりだ
こころなし: 思いやりがない | 風情がない | 道理を解さない // 所なし（こころなし）は思いやりがない、風情がない
こころばへ: 心遣い | 趣 | 性質 // 所蠅（こころばへ）に心遣い
こころゆく: 満足する | 心が晴れ晴れする // 所行く（こころゆく）と満足する
こしらふ: 宥める | 言葉巧みに誘う // 腰振る（こしらふ）と言葉巧みに誘う、なだめる
こぞ: 去年 // こぞっと（こぞ）去年来た
こちたし: 大げさだ | 煩わしい // コーチたしかに（こちたし）大げさで煩わしい
こちなき: 武骨だ | 無作法だ // こっち泣き（こちなき）で無骨だ
ことごとし: 大げさだ // コートごとシチュー（ことごとし）なんて大げさだ
こまやかなり: 詳しい | 上品だ | 愛情が深い | にこやかだ // コマ屋がカニ（こまやかなり）に愛情が深い
こよなし: 格別だ | この上ない // 今宵の梨（こよなし）はこの上なく格別だ
ごらんず: ご覧になる // ご覧ずっと（ごらんず）ご覧になる
ざえ: 学問 | 芸能 // ざっと絵（ざえ）を見て漢字と芸能を学ぶ
さがなし: 意地悪だ | いたずらだ | たちが悪い // 佐賀の梨（さがなし）とはたちが悪い、いたずらだ
さす: 途中で〜するのをやめる // 刺す（さす）のを途中でやめる
さだめて: きっと // 定めて（さだめて）打てばきっと当たる
さはる: 邪魔になる | 差し支える // さわる（さはる）と邪魔になる
さらず: 避けられない // 皿ずっと（さらず）避けられない
さらぬ: それ以外の | なんでもない // 皿塗る（さらぬ）以外はなんでもない
さらば: それなら // さらば（さらば）地球よ、それなら
さる: 相当な | そのような // 猿（さる）でも相当な、そのような
さるべき: 当然だ | 運命にある | 立派な // 猿べき（さるべき）そうなるのが当然、立派な
されば: 思った通りだ | それだから // 猿は（されば）その出会い、思った通りだ
しか: そう | そのように // 鹿（しか）！そう、そのように
しかなり: そうである // 鹿鳴り（しかなり）そうである
したためる: 準備する | 食べる | 収める | 書き記す // したっ、食べる（したためる）準備する
しただる: 雫が垂れる | 涙がこぼれる // 脂肪たるんで（しただる）涙がボタボタ滴る
しる: 納める | わかる // シルク（しる）で治めればわかる
しろしめす: 領りなさる | 知っていらっしゃる // 城示す（しろしめす）王様、知っていらっしゃる
すくよかなり: しっかりしている | ぶっきらぼうだ // すごくよか（すくよか）奴、しっかりしていて無骨だ
すさび: 気まぐれ | もてあそび // 寂しいの（すさび）、気まぐれに弄び
ずは: もし〜ないならば // ズバッと（ずは）言わないで、もし言いたくないならば
すみぞめ: 喪服 // 炭で染めた（すみぞめ）喪服
すむ: 通って結婚生活を営む // スムーズに（すむ）通って結婚生活を営む
せちなり: ひたすら | 大切な | 素晴らしい // せっちんに（せちなり）ひたすら大切だ
せむかたなし: どうしようもない // 専務肩なし（せむかたなし）どうしようもない
せめて: 無理に | 甚だしく // せめて（せめて）も無理だ、甚だしい
〜てん・〜さ・〜ぞ・〜かし: 〜だよ // 天才ぞかし（てん・さ・ぞ・かし）〜だよ
そこはかとなし: 特に理由がない | どうということもない // 底はカニとなし（そこはかとなし）特に理由はない
そこばく: たくさん | たいそう // そこにバグ（そこばく）たくさん
そしる: 非難する // ソーシャル（そしる）で非難する
そばむ: 横を向く | 知らないふりをする // 蕎麦無理（そばむ）して横向いて
〜そむ: 〜し始める // 染む（そむ）し始める
そらごと: 嘘 // 空飛ぶごと（そらごと）なんて嘘だ
たいだいし: もってのほか | 面倒である // 怠惰な石（たいだいし）もってのほか、面倒だ
たぐひなし: 比べるものがない // 類なし（たぐひなし）比べるものがない
たけし: 勢いが盛んだ | 勇ましい | 精一杯だ // たけし（たけし）は盛んだ、勇ましい
ただならず: 妊娠する | 普通ではない // ただの奈良漬（ただならず）で妊娠する
たばかる: 騙す | 計画をする | 相談する // 束軽く（たばかる）騙す計画をする
〜たまふ: 〜なさる | 〜してください // 多分（たまふ）お与えになって、なさる
たまさかなり: たまたまだ | 偶然 | もしも // たまたま逆さ（たまさか）なり、偶然
ためし: 前例 | 話の種 // 試し（ためし）にやって前例
たより: 縁 | 手紙 | 便利 | ついで // 頼り（たより）のついでに便利な手紙
つかまつる: お仕え申し上げる // 捕まえた鶴（つかまつる）にお仕え申し上げる
つかはす: おやりになる | 行かせる // 捕まるはず（つかはす）行かせる、おやりになる
つたなし: まずい | 不安だ // 綱なし（つたなし）まずい、不安だ
〜つつ: 〜し続けて // 筒（つつ）し続けて
つつましげなり: 遠慮がちだ // 筒見しげしげ（つつましげなり）遠慮がち
つつむ: 隠す | 遠慮する // 包む（つつむ）と隠して遠慮する
つまはじき: 嫌う | 非難する // 妻端っこで（つまはじき）嫌う、非難する
なかなか: 少しも | ごくわずか | かえって // なかなか（なかなか）で麺ごくわずか、かえって
つやつや〜: まったく〜ない // つやつや（つやつや）の皿、まったくない
〜てふ: 〜という // 蝶（てふ）という
とが: 欠点 | 犯罪 // 尖った（とが）欠点は犯罪だ
とかく: あれやこれや | とにかく // とにかく（とかく）あれやこれや
とし: 早い // 年（とし）とるの早い
とぶらふ: 訪れる | 見舞う | 弔問する // 飛ぶフラフープ（とぶらふ）お見舞いに訪れる
とむ: 訪問する | 見舞う // トム君（とむ）が訪問する
ながら: 〜のまま | 〜ながら // 涙ながら（ながら）そのまま
なごり: 心残り | 別れの余韻 // なごり雪（なごり）は別れの余韻
なのめならず: 格別である | 随分だ // ななめな随分（なのめならず）格別だ
なめし: 失礼だ // なぁ飯（なめし）はまだか、失礼だな
ならふ: 慣れる | 学ぶ // 習ふ（ならふ）ように慣れる
にくし: 嫌だ | 見苦しい | 無愛想だ // 肉脂肪（にくし）見苦しい、嫌だ
にげなし: ふさわしくない // 髭なし（にげなし）ふさわしくない
にはかなり: 突然だ | またとない // 俄か雨（にはかなり）突然だ、またとない
ねたし: 癪だ | 妬ましい // ねた！しょうもない（ねたし）癪だ
のたまはす: おっしゃる // 乗ったバス（のたまはす）とおっしゃる
のみ: ただ | もう // 飲み（のみ）だけ、ただもう
はつかなり: ちょっと | ほのかだ // 20日なり（はつかなり）ちょっとね
はづかし: 立派な | 優れている | 気詰まりだ // 恥ずかしい（はづかし）ぐらい立派ね
はばかる: 遠慮する | 遮られる // 葉っぱ軽く（はばかる）遠慮する
はやく: なんとまあ | すでに // 早く蹴り（はやく）いれろ、なんとまあ
ひたぶるなり: ただ一筋だ | 全く〜ない // 額ブルブル（ひたぶるなり）ただ一筋だ
びんなし: 気の毒だ | 不都合だ // 瓶なし（びんなし）ジャムなんて不都合だ、気の毒だ
ふるさと: 馴染みの土地 | 生まれ故郷 // 古い里（ふるさと）の馴染みの友はキュートだね
ほっしん: 出家すること // ホッ、心ちゃん（ほっしん）出家する
まうく: 準備する | 持つ | 病気になる // マーク（まうく）準備して大儲け
まうす: 申し上げる // マウス（まうす）が申し上げる
まかる: 退出する // まあ軽く（まかる）退出する
まさなし: 良くない | 思いがけない // まさに梨（まさなし）良くない
まだ: 早くも | もう // まだ（まだ）来てないの早くも待ちくたびれた
まどふ: 思い悩む | 慌てる | ひどく〜する // 窓拭き（まどふ）道に迷ってひどく慌てる
まねぶ: 伝える | 勉強する | 真似る // まあねぶって（まねぶ）真似ると伝える
まばゆし: 眩しい | 恥ずかしい | 見ていられないほど美しい // 眩い（まばゆし）光、美しくて見ていられない
まほなり: 完璧だ | 直接だ // 魔法なり（まほなり）完璧
みまかる: 死ぬ // 身、真っ赤に（みまかる）なって死ぬ
みやび: 都会風 // 雅（みやび）都会風に
みゆ: 結婚する | 会う | 見える // ミュウ（みゆ）と結婚する
みる: 世話をする | 結婚する // ミルクを（みる）世話して結婚する
むつけし: 不気味だ | 武骨だ // むっ！付け髭（むつけし）不気味な顔
むつまじ: 親しい // 睦美とマジ（むつまじ）で親しい
むなしくなる: 死ぬ // むなしくなる（むなしくなる）と死ぬ
めす: お呼びになる | 召し上がる | 〜なさる // メス（めす）呼ぶとお取り寄せになる
めづらし: 素晴らしい | 新鮮だ | めったに見られない // 珍しい（めづらし）のは素晴らしく新鮮だ
めやすし: 感じが良い // 目安し（めやすし）そりゃ感じが良い
〜めり: 〜のようだ // メリー（めり）さんのようだ
もてなす: 取り扱う | 世話をする | ごちそうする // モテないっす（もてなす）が取り扱って世話をする
ものがたりす: 話す // 物語す（ものがたりす）っかり話す
ものかは: 問題ではない | 〜であろうか // もの買わん（ものかは）やつは問題じゃない
ものす: いる | 来る | 食べる | 行く | 手紙を書く // ものすっごい（ものす）入れ食いなので食べてから行く
ものも覚えず: 呆然としている | どうして良いかわからない // 何もかも覚えずに（ものも覚えず）呆然としている
やさし: 優美だ | 感心だ | つらい | 決まりが悪い // 優しい（やさし）優美ちゃん感心だ
やつす: 出家する | みすぼらしくなる // やつ、すっかり（やつす）出家して
やる: 心を晴らす | 行かせる // やる（やる）と心が晴れる
やるかたなし: 心が晴れない // やり方なし（やるかたなし）だと心が晴れない
ゆくりなし: 突然だ | 思いがけない // ゆっくり梨（ゆくりなし）突然変異
ゆめ〜: 決して〜ない // 夢を（ゆめ）決して見るな
ゆゑ: 理由 | 風情 | 縁故 // ゆえ（ゆゑ）理由を言っちゃ風情もない
よしあり: 風情がある | 由緒がある // よしアリンコ（よしあり）にも風情がある
よしなしごと: つまらないこと // ヨッシー梨ごと（よしなしごと）はつまらない
よすが: 親類 | ゆかり | 手がかり | 拠り所 // 寄るすがら（よすが）のしんどい拠点
よそふ: 比べる | カッコつける // よそ夫（よそふ）と比べてカッコつける
よのつね: 当たり前すぎる | 普通 // 夜の狐（よのつね）は当たり前すぎる
よのなか: 男と女の仲 | この世 | 世間 // 世の中（よのなか）男と女の仲でだけ
よもすがら: 一晩中 // 読むすがら（よもすがら）一晩中
よろし: 悪くない | よろしい // よし（よろし）悪くない
よをすつ: 出家する // 洋服すてて（よをすつ）出家する
らうたし: かわいい // ラフな格好たし（らうたし）かに可愛い
〜らむ: 〜しているだろう // ラム（らむ）ちゃん今頃何しているだろう
れいならず: 病気だ | 妊娠している | いつものようではない // 例ならず（れいならず）ずっと病気も妊娠も
ろんなし: 言うまでもない // ローンなし（ろんなし）なのは言うまでもない
わざと: わざわざ | 本格的に | 格別に // わざと（わざと）わざわざ本格的に
わたる: 行く | 〜し続ける | 一面に〜する // ワタル（わたる）くん行ったり来たりし続ける
わづらふ: 病気になる | 苦しむ | 〜しかねる // 煩わし（わづらふ）かねる病気になる
わぶ: つらく思う | 困る | 落ちぶれる // わー、ブラック（わぶ）企業はつらくて困る
わろし: 良くない | みっともない // 悪し（わろし）良くない、みっともない
〜に〜を: 〜なので（理由） // 兄を（に〜を）選ぶのは形容詞なので
をこなり: 馬鹿げている // 怒るな（をこなり）馬鹿げている
をさをさし: しっかりしている // おさおさし（をさをさし）てしっかりしている
をんなで・をとこで: ひらがな | 漢字 // 女手（をんなで）はひらがな、男手（をとこで）は漢字
あえかなり: 華奢だ // あえか（あえかなり）は華奢だ
あかぬ: 満足していない // あかん（あかぬ）満足していないのに
あからむ: 赤くなる | わかる // 赤らむ（あからむ）赤くなる、わかる
あてはかなり: 上品だ | 鮮やかだ // 派手はかなり（あてはかなり）上品ですわ
〜べかめり: 〜に違いない // べかめり（べかめり）に違いない
あへなし: がっかりする | どうしようもない // あーへなへな（あへなし）がっかりどうしようもない
あへなむ: 仕方がない | 差し支えないだろう // ああ変なムード（あへなむ）で仕方がない
ありめり: あるようだ // アリ、目にあ（ありめり）るようだ
あり: 生きている | 生活する // 蟻（あり）も生きている
ありありて: 生き長らえて | トドのつまり // ありありて（ありありて）生き長らえて
ありとある: すべての // ありとあらゆる（ありとある）すべての
あへし: ご馳走する // アリスに（あへし）ご馳走する
あんじまうけ: 準備 | ご馳走の準備 // あんじまうけ（あんじまうけ）ご馳走の準備
あるは: あるものは | または // あるは（あるは）あるものは
いかさまなり: どのように // イカサマって（いかさまなり）どのようにやるの
いくばく: どれほど | それほど // いくらバクバク（いくばく）どれほど食べても
いさむ: 忠告する | 禁止する // イサム（いさむ）君への忠告を禁止する
いたはし: 苦しい | 気の毒だ | お世話したい // 板橋（いたはし）苦しいの気の毒でお世話したい
いづら・いづち: どこ | どのあたり // いづら、いい土（いづら・いづち）どこで買ったの
いでたつ: 出発する | 出世する // 家出たついで（いでたつ）に出発し出世する
いと〜: あまり〜ない // 糸（いと）あまり痛くない
いと〜なし: それほど良くない // いい年なし（いと〜なし）それほど良くない
いはけなり: 非常に | 幼稚だ // 言い訳ばかり（いはけなり）非常に幼稚だ
いひなす: 悪く言う | 否定する // 言いなす（いひなす）悪く言って否定する
いまいます: いらっしゃる | お出かけになる // 今います（いまいます）いらっしゃる
いむ: 嫌って避ける | 身を清める // 忌む（いむ）嫌って避けて身を清める
いもぬ: 寝る // 芋ぬくぬく（いもぬ）寝る
うきよ: つらくはかない世の中 | 俗世 // 憂き世（うきよ）はつらいよ
うしろめたなし: 気がかりだ | 後ろ暗い // 後ろにメーターなし（うしろめたなし）心配で気がかりだ
うたてあり: 嫌だ // 歌ってアリ（うたてあり）さん嫌だ
うちとく: 気を許す | くつろぐ // うちとく（うちとく）くつろいで気を許す
うとまし: 嫌だ | 気味が悪い // うっ！トマトしなびて（うとまし）嫌だ、気味が悪い
うへ: 天皇 | 宮中 // 上（うへ）の天皇
うむず: 嫌になる | 塞ぎ込む // うーんずっと（うむず）塞ぎ込んで嫌になる
えならず: なんとも言えないほど良い // Aならず（えならず）なんとも言えないほど良い
おきつ: 指図する | 計画する // 起きつ（おきつ）で計画を指図する
おきな・おみな: 老人 | おじいさん | おばあさん // 大きな（おきな）おじいさん、おーみんな（おみな）おばあさん
おづ: 怖がる // オズ（おづ）の魔法使いを怖がる
おほどかなり: おっとりしている // 大戸が鳴り（おほどかなり）おっとりしている
おもてをおこす: 名誉を回復する // 表を起こす（おもてをおこす）名誉を回復する
おもひきや: 思ったか | いや思いもしなかった // 思いきや（おもひきや）思っただろうか、いや思いもしなかった
かかり: こうだ | このようだ // 係（かかり）こうだ
かきくらす: 悲しみに暮れる // 柿食らうす（かきくらす）と悲しみに暮れる
かけても〜: 決して〜ない // 書けても（かけても）決して書けない
かごと: 言い訳 | 愚痴 // カゴ取られた（かごと）と愚痴をこぼす、言い訳する
〜かし: 〜だよ | 〜ね // 歌詞（かし）だよ、〜ね
かずならず: 取るに足らない // 数ならず（かずならず）取るに足らない
かたじけなし: 恐れ多い | もったいない // 型事件なし（かたじけなし）恐れ多いしもったいない
かど: 才能 | 見所 // 角（かど）の才能、見所
かねて: あらかじめ // 鐘て（かねて）あらかじめ
かまふ: 作る | 計画を立てる // カマ二つ（かまふ）作る、計画を立てる
かまへて: 必ず | 決して | 注意して // 構えて（かまへて）打てば必ず当たる、注意して、決して〜するな
かりそめなり: ちょっとだけ | 一時的 // 仮に染めた髪（かりそめなり）ちょっとだけ一時的
かれがれなり: 疎遠になっている // 彼がれんこん（かれがれなり）疎遠になった
きはやかなり: 目立っている | 思い切りが良い // 木はヤカンより（きはやかなり）目立っている
くもゐ: 宮中 | 雲 | はるか遠く // 雲いる（くもゐ）宮中、はるか遠く
くやし: 残念だ // 食うやし（くやし）残念だ
くんず: 塞ぎ込む // クーンずっと（くんず）塞ぎ込む
けうとし: 疎ましい | 気味が悪い // 毛うとしい（けうとし）疎ましい気味が悪い
けさう: 恋すること // 化粧（けさう）して恋すること
けし: 異様な | 不実だ // ケシ（けし）ゴム異様だ、不実だ
けしうはあらず: 悪くはない | 不自然ではない // 消しゴムはあらず（けしうはあらず）とも悪くはない
けやけし: 目立っている | 格別だ // 毛やけに白くて（けやけし）目立っている
こうず: 疲れる | 困る // こうずっと（こうず）疲れて困る
こけのころも: 俗世を捨てた僧 // 苔の衣（こけのころも）俗世を捨てた僧
こころうし: つらい | 不快だ // 心牛（こころうし）さん、つらくて不快だ
こころやまし: 満足できず不愉快だ // 心、山氏（こころやまし）満足できず不愉快だ
こときる: 死ぬ | 物事が終わる // 琴切る（こときる）と死んで全てが終わる
ことなしび: 平気な顔 | しらばくれている // 事なし美（ことなしび）平気な顔でしらばくれている
ことのは: 言葉 // 琴の葉（ことのは）は言葉
こぼつ: 壊す | 落とす // コボちゃんツルッ（こぼつ）と落として壊す
さが: 生まれつきの性格 | 運命 | 習わし // 佐賀（さが）の習わし、生まれつきの性格で運命だ
さしたる: 大した〜ない // 刺したる（さしたる）といっても大したことない
さた: 始末 | 命令 | 知らせ // サタン（さた）の始末、命令、知らせ
さはり: 差し支え // 触り（さはり）ますが差し支えますか
さらにもいはず: 言うまでもないほどだ // 皿にもイワシ（さらにもいはず）は言うまでもないほどだ
さらぬわかれ: 死別 // 皿ぬる別れ（さらぬわかれ）は死別
さるは: そうだけれども // サルはそうだ（さるは）けれども
したりがほ: 得意顔 // したり顔（したりがほ）で得意顔
しな: 身分 | 人柄 | 階段 // 品（しな）のいい身分と人柄、階段を上がる
すかす: 騙す | 慰める | おだてる // 酢かす（すかす）で騙す、慰める、おだてる
すきずきし: 物好きだ | 好色だ | 風情だ // 好き好きしんちゃん（すきずきし）物好きだ、風情だ
すくせ: 前世からの因縁 // 尽くせ（すくせ）前世の因縁
すごし: ぞっとする | もの寂しい | 素晴らしい // 過ごしやすい（すごし）夏なんてぞっとして素晴らしい
すさぶ: 興じる | 盛んに〜する // スサブ物理（すさぶ）に興じて盛んにする
すだく: 集まる | 鳴く // 巣だ食う（すだく）と集まって鳴く
すべなし: どうしようもない // 滑る話（すべなし）もうどうしようもない
すまふ: 辞退する | 争う // すもう取り（すまふ）争いを辞退する
すゑ: 和歌の下の句 | 子孫 | 将来 // 杖（すゑ）の下置くと将来子孫
せきあへず: 涙をこらえきれない // 咳あへず（せきあへず）涙をこらえきれない
そのかみ: あの頃 | 過去 // その髪型（そのかみ）あの頃流行ったな
たづき: 手段 | 様子 // たぬき（たづき）の手段様子
たのし: 裕福だ | 頼もしい // 楽しい頼もしい（たのし）夫で裕福だ
たふ: 能力がある | 我慢する // タフ（たふ）な能力、我慢する
たまのを: 命 // 玉の緒（たまのを）命少し
ためらふ: 落ち着く | グズグズする // ためらってふと（ためらふ）落ち着く
たゆむ: 油断する | 疲れる // タイム君（たゆむ）油断するな
つきかげ: 月の光 // 月影に（つきかげ）月光仮面
つきなし: 似合わない | 取りつく島もない // ツキなし（つきなし）なんて似合わない
つくづくと: しみじみと | じっくり // 机作りは（つくづくと）しみじみと
すゑ: さっと置く | じっとさせる // 据ゑ（すゑ）さっと置く、じっとさせる
つぼ: 壺 | 要所 // ツボ（つぼ）は要所
てうず: 退治する | 料理する | 作る // 腸ズルズル退治（てうず）しながら料理を作る
てづから: 自分の手で // 手作りだから（てづから）自分の手で
〜てむ・〜なむ: 〜してくれないか // テムにはナミヤを（てむ・なむ）助けてくれないか
どち: 仲間 // どっちが仲間（どち）
とばかり: ちょっとの間 // とばかりで（とばかり）ちょっとの間
はた: 何はさておき | また | あるいは // 旗（はた）なになにもまた、あるいは
ながめ: 物思い | ぼんやり見ること // 長めの休憩で（ながめ）物思い
な〜そ: 〜するな // なー、そこ（な〜そ）でするな
なさけなし: 風情がない | 思いやりがない // なぁ酒がない（なさけなし）のは風情がない
なじかは: どうしてか // なぜかは（なじかは）どうしてか
なづむ: 悩み苦しむ | こだわる // 夏むんむん（なづむ）悩み苦しむ
なに〜: 〜で有名である | 名として持つ // 何（なに）で有名である
なにかは: どうしてか // 何かは（なにかは）どうしてか
なの〜: どうして〜か // 何の（なの）どうして〜か
なにかはせむ: どうしようか | いやどうしようもない // 何かせん（なにかはせむ）どうしようか、いやどうしようもない
なまめく: 優美である | みずみずしく美しい // 生メイクの優美（なまめく）ちゃんみずみずしい
なめげなり: 失礼だ // ナメてゲンナリ（なめげなり）失礼だ
なめり: 〜であるようだ // なぁメリーちゃん（なめり）であるようだ
なやまし: 気分が悪い // 悩みマシーン（なやまし）気分が悪い
ねぶ: 大人びる | 年を取る // ねぇブって（ねぶ）大人びる
ねをなく: 声を上げて泣く // 猫をなくして（ねをなく）声をあげて泣く
はかなく成る: 死ぬ // 墓はなくなる（はかなくなる）と死ぬ
はつ: 死ぬ | 終わる | すっかり〜しきる // 初登場で死んで（はつ）すっかり終わる
はなから: すぐに | 〜するやいなや // 鼻から（はなから）すぐに兄弟飛び出す
ひがし: ひねくれている | 情を解さない | 見苦しい // 東に沈む（ひがし）とはひねくれてる
ひかふ: つかむ | 控える // 控え2人で（ひかふ）つかむ
ひとかたならず: 堂々ではない | 一通りではない // 人方ならず（ひとかたならず）一通りではない
ひとやりならず: 自ら進んですることだ // 人やりならず（ひとやりならず）自ら進んで
ひとりごつ: 独り言を言う // 1人でごつんと（ひとりごつ）独り言
ひとわろし: みっともない // 人悪し（ひとわろし）みっともない
ひなぶ: 田舎めく // 雛ぶる（ひなぶ）田舎めく
ひねもす: 一日中 // 昼寝もするなら（ひねもす）一日中
ひま: 隙間 | 合間 // ひまわりの隙間（ひま）
ふりはつ: わざわざ〜しきる // 振りはつ（ふりはつ）わざわざしちゃう
ふる: 年をとる | 年月が経つ | 古びる // 古時計（ふる）年をとる
まうづ: 参上する | 参詣する // まあうずうずして（まうづ）参上する
まゐります: 参上いたします // まあ腕組んで参上（まゐります）
まじる・まじらふ: 入り乱れる | 宮仕えする // 混じる（まじる）入り乱れる
まがふ: 見分けがつかない | 乱れる // 漫画2つ入り乱れ（まがふ）見分けがつかない
まがまがし: 不吉だ | いまいましい // まあ我慢が死んでいる（まがまがし）不吉だ
まこと: 真実 | 誠実 // まこと（まこと）真実、誠実で
まだき: まだ早い | 早くも // まだき（まだき）てないの早くも
まめごと: 真面目なこと // まめな仕事（まめごと）真面目だね
まゐらす: 〜し申し上げる // まあイライラする（まゐらす）とか申し上げる
みゆき: 天皇・上皇のお出かけ // みゆきの（みゆき）お出かけ
〜むず: 〜しただろう | 〜だろう // 難易度ムズだ（〜むず）〜だろう
むつかる: 不機嫌だ | 不平を言う // むつかる（むつかる）不機嫌だ
むねん: 不機嫌だ | 不平を言う // 無念（むねん）不機嫌だ
〜めざ: 〜ではないか // 目やにだろうか、いやそうではね（〜めざ）
〜もぞ・〜もこそ: 〜した通りに | 〜すると大変だ // もぞもこそ（もぞ・もこそ）すると大変だ
もどかし: 気に食わない | じれったい // もどかしいなぁ（もどかし）気に食わんぞ
もどく: 真ねる | 非難する // 猛毒マネて（もどく）非難する
〜ものから: 〜ものの | 〜けれども // ものから（ものから）気にならないものの
やくと: ひたすら | もっぱら // 役と（やくと）ひたすらもっぱら
やつる: みすぼらしくなる // やつルックスが（やつる）みすぼらしく
やむ: 死ぬ | 治る | 終わる // 山と死ぬが治る（やむ）
やや: だんだん | ちょっと // ややこしい話ちょっと（やや）だんだん
〜や: 〜だろうか // 嫌なんだろうか（〜や）
夕されば: 夕方になると // UFOを去れば（夕されば）夕方になる
ゆるさる: 認められる | 許される // ゆるめの服が（ゆるさる）許される
ゆゑゆゑし: もったいぶっている | 嗜み深い // ゆえゆえ全部（ゆゑゆゑし）もったいぶって
よし〜: 悪くすると〜ない // 妖精ずっと（よし〜）悪くすると〜ない
よに〜: 決して〜ない // 世に不可能は決してない（よに〜）
よぶ: 求婚する | 呼び続ける // ようバブーと（よぶ）求婚する
らうがはし: 騒がしい | 無作法だ // 廊下が走る（らうがはし）騒がしい
らうらうじ: 洗練されている | 優雅だ // 浪人浪人（らうらうじ）洗練されている優雅だ
わく: 理解する | 区別する // 枠を区別して（わく）理解する
わたり: あたり | 人 // 渡りに船だあたり（わたり）に
おこがまし: 馬鹿げている | みっともない // 怒るがマシ（おこがまし）とは馬鹿げている
をりふし: 季節 | ちょうど // オリーフシ君の季節はちょうど（をりふし）
      `; 

    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });
    document.addEventListener('touchmove', function(event) { if (event.scale !== 1) { event.preventDefault(); } }, { passive: false });

    class HybridQuiz {
        constructor() {
            this.wordsPerRound = 20; 
            this.masterList = [];
            this.vocabRounds = [];
            this.currentRoundIndex = 0;
            this.questions = [];
            this.currentIndex = 0;
            this.missCount = 0;
            this.missedWordsLog = [];
            this.startTime = 0;
            this.lapStartTime = 0; 
            this.timerInterval = null;
            this.currentStreak = 0;
            this.maxStreak = 0; 
            this.dueMistakes = [];
            this.allMistakes = []; 
            this.bookmarkedOnly = false;

            this.isPitStopMode = false;
            this.isReverseMode = false;
            
            document.getElementById('wb-search').addEventListener('input', () => this.renderWordBook());
            document.getElementById('wb-start').addEventListener('input', () => this.renderWordBook());
            document.getElementById('wb-end').addEventListener('input', () => this.renderWordBook());

            this.parseData();
            this.generateRounds();
            this.initUI();
            this.initSearch(); 
        }

        parseData() {
            if(!rawData.trim()) { this.masterList = []; return; }
            const lines = rawData.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            this.masterList = [];
            lines.forEach(line => {
                let goro = "";
                let mainPart = line;
                // 語呂合わせ（//）の分離
                if(line.includes('//')) {
                    const parts = line.split('//');
                    mainPart = parts[0].trim();
                    goro = parts[1].trim();
                }

                let sep = -1;
                if (mainPart.indexOf(':') !== -1) sep = mainPart.indexOf(':');
                else if (mainPart.indexOf('：') !== -1) sep = mainPart.indexOf('：');
                
                if (sep !== -1) {
                    const w = mainPart.substring(0, sep).trim();
                    const mRaw = mainPart.substring(sep + 1).trim();
                    const mList = mRaw.split('|').map(s => s.trim());
                    // g: goro としてデータを保持
                    this.masterList.push({ w: w, m: mList, g: goro });
                }
            });
        }

        generateRounds() {
            const wordCopy = [...this.masterList]; 
            this.vocabRounds = [];
            let roundNum = 1;
            let currentWordIndex = 1; 
            while (wordCopy.length > 0) {
                const chunk = wordCopy.splice(0, this.wordsPerRound);
                if (chunk.length > 0) {
                    this.vocabRounds.push({ id: roundNum, name: `SECTOR ${roundNum} (No.${currentWordIndex} - ${currentWordIndex + chunk.length - 1})`, words: chunk });
                    roundNum++;
                    currentWordIndex += chunk.length;
                }
            }
        }

        initUI() {
            const selector = document.getElementById('round-selector');
            selector.innerHTML = '';
            if(this.vocabRounds.length === 0) { selector.innerHTML = '<option>Load Data or Login</option>'; }
            else {
                this.vocabRounds.forEach((round, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = round.name;
                    selector.appendChild(opt);
                });
            }

            const lastPlayed = localStorage.getItem('rb26_kobun_last_round');
            if (lastPlayed) {
                const roundIdx = parseInt(lastPlayed);
                if (!isNaN(roundIdx) && roundIdx < this.vocabRounds.length) {
                    selector.value = roundIdx;
                    const option = selector.options[roundIdx];
                    if (option) option.text = "◀ LAST ▶ " + option.text;
                }
            }
            this.updateSummary();
        }

        updateSummary() {
            const selector = document.getElementById('round-selector');
            let roundName = "Custom / Random";
            if (selector.selectedIndex >= 0) {
                roundName = selector.options[selector.selectedIndex].text;
            }
            
            const tire = this.wordsPerRound;
            const rev = document.getElementById('reverse-mode').checked ? "REV" : "STD";
            
            document.getElementById('strategy-summary').innerText = `${roundName} | ${tire} Qs | ${rev}`;
        }

        toggleStrategyMenu() {
            const panel = document.getElementById('strategy-panel');
            const btn = document.getElementById('strategy-toggle-btn');
            if (panel.classList.contains('open')) {
                panel.classList.remove('open');
                btn.classList.remove('bg-gray-700', 'text-white');
                btn.classList.add('bg-gray-800', 'text-gray-400');
                btn.innerText = "Show Settings ▼";
            } else {
                panel.classList.add('open');
                btn.classList.remove('bg-gray-800', 'text-gray-400');
                btn.classList.add('bg-gray-700', 'text-white');
                btn.innerText = "Hide Settings ▲";
            }
        }

        switchStrategyTab(tab) {
            const normalDiv = document.getElementById('strategy-normal');
            const randomDiv = document.getElementById('strategy-random');
            const tabNorm = document.getElementById('tab-normal');
            const tabRand = document.getElementById('tab-random');

            if (tab === 'normal') {
                normalDiv.classList.remove('hidden');
                randomDiv.classList.add('hidden');
                tabNorm.classList.add('text-white', 'border-red-500');
                tabNorm.classList.remove('text-gray-500', 'border-transparent');
                tabRand.classList.remove('text-white', 'border-red-500');
                tabRand.classList.add('text-gray-500', 'border-transparent');
            } else {
                normalDiv.classList.add('hidden');
                randomDiv.classList.remove('hidden');
                tabRand.classList.add('text-white', 'border-red-500');
                tabRand.classList.remove('text-gray-500', 'border-transparent');
                tabNorm.classList.remove('text-white', 'border-red-500');
                tabNorm.classList.add('text-gray-500', 'border-transparent');
            }
        }

        initSearch() {
            const input = document.getElementById('search-input');
            const results = document.getElementById('search-results');
            input.addEventListener('input', (e) => {
                const q = e.target.value.toLowerCase().trim();
                if (!q) { results.classList.add('hidden'); return; }
                const hits = this.masterList.map((item, index) => ({ ...item, i: index + 1 }))
                    .filter(item => item.w.toLowerCase().includes(q) || item.m.some(m => m.toLowerCase().includes(q)))
                    .slice(0, 50);
                if (hits.length > 0) {
                    results.classList.remove('hidden');
                    results.innerHTML = hits.map(h => `
                        <div class="p-3 border-b border-gray-800 flex justify-between items-center group hover:bg-white/5 transition-colors">
                            <div class="text-left"><div class="flex items-baseline gap-2"><span class="text-[10px] text-yellow-500 font-mono opacity-70">No.${h.i}</span><span class="text-red-400 font-bold text-xs jp-font">${h.w}</span></div><span class="text-gray-400 text-[10px] pl-1 truncate block max-w-[200px]">${h.m.join(' / ')}</span></div>
                        </div>`).join('');
                } else {
                    results.classList.remove('hidden');
                    results.innerHTML = `<div class="p-3 text-gray-500 text-[10px] text-center">NO DATA</div>`;
                }
            });
            document.addEventListener('click', (e) => { if (!input.contains(e.target) && !results.contains(e.target)) results.classList.add('hidden'); });
        }

        createCustomRound() {
            const s = parseInt(document.getElementById('custom-start').value) - 1;
            const e = parseInt(document.getElementById('custom-end').value);
            if(isNaN(s) || isNaN(e) || s < 0 || e > this.masterList.length || s >= e) { alert("Invalid Range"); return; }
            const customWords = this.masterList.slice(s, e);
            this.vocabRounds.unshift({ id: 'custom', name: `CUSTOM (No.${s+1}-${e})`, words: customWords });
            this.initUI();
            document.getElementById('round-selector').value = 0;
            this.updateSummary();
        }

        createRandomRound() {
            const sVal = document.getElementById('rand-start').value;
            const eVal = document.getElementById('rand-end').value;
            const qVal = document.getElementById('rand-qty').value;
            
            let s = parseInt(sVal) - 1;
            let e = parseInt(eVal);
            let qty = parseInt(qVal);

            if (isNaN(s)) s = 0;
            if (isNaN(e)) e = this.masterList.length;
            if (isNaN(qty) || qty <= 0) qty = this.wordsPerRound; 

            if (s < 0 || e > this.masterList.length || s >= e) { alert("Invalid Range for Random GP"); return; }

            const rangePool = this.masterList.slice(s, e);
            this.shuffle(rangePool);
            const selectedWords = rangePool.slice(0, qty);
            
            this.vocabRounds.unshift({ id: 'random', name: `🎲 RANDOM (Range: ${s+1}-${e})`, words: selectedWords });
            this.initUI();
            document.getElementById('round-selector').value = 0;
            this.updateSummary();
            this.start();
        }
        
        setTireStrategy(count, type) {
            this.wordsPerRound = count;
            this.generateRounds();
            this.initUI();
            document.querySelectorAll('.tire-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tire-${type}`).classList.add('active');
            this.updateSummary();
        }

        start() {
            this.currentIndex = 0;
            this.missCount = 0;
            this.currentStreak = 0; 
            this.maxStreak = 0;     
            this.missedWordsLog = [];
            this.startTime = Date.now();
            this.startTimer();
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            this.startVocabMode();
        }

        startVocabMode() {
            if(this.vocabRounds.length === 0) { alert("Data not loaded"); this.returnToGrid(); return; }
            this.isPitStopMode = false;
            
            const selector = document.getElementById('round-selector');
            this.currentRoundIndex = parseInt(selector.value);
            const selectedRound = this.vocabRounds[this.currentRoundIndex];
            
            if (selectedRound.id !== 'custom' && selectedRound.id !== 'random') {
                localStorage.setItem('rb26_kobun_last_round', this.currentRoundIndex);
            }

            this.isReverseMode = document.getElementById('reverse-mode').checked;

            let modeTitle = this.isReverseMode ? " [REV]" : "";
            document.getElementById('circuit-name').innerText = selectedRound.name + modeTitle;
            document.getElementById('question-label').innerText = this.isReverseMode ? "TRANSLATE" : "MEANING";

            this.questions = selectedRound.words.map(target => {
                // 多義語の中から1つだけランダムに選ぶ
                const randomMeaning = target.m[Math.floor(Math.random() * target.m.length)];
                const fullMeanings = target.m; // 保存用に全意味も持っておく

                const qText = this.isReverseMode ? randomMeaning : target.w;
                const aText = this.isReverseMode ? target.w : randomMeaning;
                
                const distractors = this.getDistractors(target, this.isReverseMode);
                const options = [aText, ...distractors].sort(() => Math.random() - 0.5);
                
                const existingData = (this.allMistakes || []).find(item => item.word === target.w || item.w === target.w) || {};

                return { 
                    w: target.w, 
                    m: fullMeanings, // 記録用（配列）
                    displayM: randomMeaning, // 表示用（単一）
                    qText: qText, 
                    aText: aText, 
                    o: options,
                    docId: existingData.id || null, 
                    interval: existingData.interval || 0,
                    repetitions: existingData.repetitions || 0,
                    easeFactor: existingData.easeFactor || 2.5
                };
            });
            this.questions.sort(() => Math.random() - 0.5);
            this.showVocabQuestion();
        }
        
        getDistractors(targetWord, isReverse) {
             const distractors = [];
             if (this.masterList.length < 4) return ["Option A", "Option B", "Option C"]; 

             // ターゲットの「正解文字列」
             // 通常モードなら：targetWord.w が問題。targetWord.m (配列) のどれかが正解。
             // ダミー選択肢は他の単語の m (配列) から1つ選ぶ。
             
             // Reverseモードなら：targetWord.m (配列) のどれかが問題。targetWord.w が正解。
             // ダミー選択肢は他の単語の w を選ぶ。

             let attempts = 0;
             while (distractors.length < 3 && attempts < 100) {
                 const r = this.masterList[Math.floor(Math.random() * this.masterList.length)];
                 
                 // 正解候補と同じ単語データならスキップ
                 if (r.w === targetWord.w) {
                     attempts++;
                     continue;
                 }

                 let candidate;
                 if (isReverse) {
                     // 答えは単語そのもの
                     candidate = r.w;
                 } else {
                     // 答えは意味（多義語の中から1つ選ぶ）
                     candidate = r.m[Math.floor(Math.random() * r.m.length)];
                 }

                 if (!distractors.includes(candidate)) {
                     distractors.push(candidate);
                 }
                 attempts++;
             }
             return distractors;
         }

         showVocabQuestion() {
             const q = this.questions[this.currentIndex];
             document.getElementById('question-number').innerText = `LAP ${this.currentIndex + 1} / ${this.questions.length}`;
             
             const targetDisplay = document.getElementById('target-word');
             targetDisplay.innerHTML = "";
             targetDisplay.innerText = q.qText;
             
             // 文字数でサイズ調整
             const len = q.qText.length;
             let sizeClass = "text-5xl md:text-7xl";
             if(len > 10) sizeClass = "text-3xl md:text-5xl";
             if(len > 20) sizeClass = "text-xl md:text-3xl";

             targetDisplay.className = `jp-font ${sizeClass} font-bold text-white tracking-wide drop-shadow-lg break-words px-2 text-center leading-tight`;

             this.lapStartTime = Date.now(); 

             document.getElementById('progress-fill').style.width = `${(this.currentIndex / this.questions.length) * 100}%`;
             document.getElementById('feedback').innerText = '';
             
             const container = document.getElementById('options-container');
             container.innerHTML = '';
             
             q.o.forEach(opt => {
                 const btn = document.createElement('button');
                 // 日本語が含まれる場合はゴシック体
                 const isJp = /[あ-んア-ン一-龥]/.test(opt);
                 const fontClass = isJp ? "jp-font tracking-wider" : "text-sm";
                 // 文字数でサイズ調整
                 const textSize = opt.length > 20 ? "text-xs" : (opt.length > 10 ? "text-sm" : "text-lg");
                 
                 btn.className = `option-btn w-full h-full flex items-center justify-center p-5 rounded-xl bg-white/10 border border-white/20 hover:bg-white/20 active:border-red-500 font-bold shadow-lg ${fontClass} ${textSize} transition-all min-h-[80px]`;
                 btn.innerText = opt;
                 btn.onclick = () => this.handleVocabAnswer(opt, q);
                 container.appendChild(btn);
             });
         }

         handleVocabAnswer(selected, q) {
             const btns = document.querySelectorAll('.option-btn');
             if (btns.length > 0 && btns[0].disabled) return;
             btns.forEach(b => b.disabled = true);

             const feedback = document.getElementById('feedback');
             const timeTaken = (Date.now() - this.lapStartTime) / 1000;
             const isCorrect = (selected === q.aText);

             if (window.handleSRSUpdate) {
                 window.handleSRSUpdate({ ...q, timeTaken: timeTaken }, isCorrect);
             }

             if (isCorrect) {
                 this.currentStreak++;
                 if (this.currentStreak > this.maxStreak) {
                     this.maxStreak = this.currentStreak;
                 }
                 
                 if (timeTaken < 1.5) {
                     feedback.innerHTML = `<span class="text-[#39ff14] text-xs font-bold animate-pulse">🟣 PURPLE SECTOR (${timeTaken.toFixed(2)}s)</span>`;
                 } else if (timeTaken > 5.0) {
                     feedback.innerHTML = `<span class="text-yellow-500 text-xs font-bold">🟡 SLOW (${timeTaken.toFixed(2)}s)</span>`;
                 }

                 setTimeout(() => {
                     this.currentIndex++;
                     if (this.currentIndex < this.questions.length) this.showVocabQuestion();
                     else this.finish();
                 }, 400); 

             } else {
                 this.missCount++;
                 this.currentStreak = 0; 
                 
                 // 正解表示（意味は全リスト表示ではなく、出題された正解を表示するが、わかりやすさのため全意味を出してもよい。ここではシンプルに）
                 // 全意味を表示して復習しやすくする
                 const displayCorrect = Array.isArray(q.m) ? q.m.join(' / ') : q.m;
                 
                 feedback.innerText = `WRONG: ${q.w} = ${displayCorrect}`;
                 feedback.className = "mt-4 text-center h-6 font-bold text-red-500 animate-pulse";
                 
                 if (!this.missedWordsLog.find(item => item.w === q.w)) {
                     this.missedWordsLog.push({ w: q.w, m: displayCorrect });
                 }
                 
                 this.questions.push(q);
                 setTimeout(() => { 
                     this.currentIndex++; 
                     this.showVocabQuestion(); 
                 }, 2000); // 読む時間を少し確保
             }
         }

         startTimer() {
             if (this.timerInterval) clearInterval(this.timerInterval);
             this.timerInterval = setInterval(() => { document.getElementById('timer').innerText = ((Date.now() - this.startTime) / 1000).toFixed(2) + 's'; }, 50);
         }

         shuffle(array) {
             for (let i = array.length - 1; i > 0; i--) {
                 const j = Math.floor(Math.random() * (i + 1));
                 [array[i], array[j]] = [array[j], array[i]];
             }
         }

         finish() {
             clearInterval(this.timerInterval);
             document.getElementById('quiz-screen').classList.add('hidden');
             document.getElementById('result-screen').classList.remove('hidden');
             
             const totalTime = (Date.now() - this.startTime) / 1000;
             let totalQs = this.questions.length; // ペナルティ込みの総出題数にはしたくない場合調整が必要だが、シンプルに
             
             // 純粋な問題数ベースでのスコア
             let correctCount = Math.max(0, this.wordsPerRound - this.missCount);
             let accuracy = (correctCount / this.wordsPerRound) * 100;
             if(accuracy < 0) accuracy = 0;
             if(accuracy > 100) accuracy = 100; // 念のため
             
             const accDisplay = document.getElementById('accuracy-display');
             accDisplay.innerText = `${accuracy.toFixed(1)}%`;

             if (window.saveRaceResult) {
                 let roundName = "UNKNOWN ROUND";
                 if (this.isPitStopMode) {
                     roundName = "SRS PIT STOP";
                 } else if (this.vocabRounds[this.currentRoundIndex]) {
                     roundName = this.vocabRounds[this.currentRoundIndex].name;
                 }

                 const resultData = {
                     accuracy: parseFloat(accuracy.toFixed(1)),
                     round: roundName,
                     score: `${correctCount}/${this.wordsPerRound}`,
                     streak: this.maxStreak,
                     time: parseFloat(totalTime.toFixed(2))
                 };
                 window.saveRaceResult(resultData);
             }
             
             const passArea = document.getElementById('pass-area');
             const failMsg = document.getElementById('fail-msg');

             if (accuracy >= 90) {
                 accDisplay.style.color = "#4ade80"; 
                 passArea.classList.remove('hidden');
                 failMsg.classList.add('hidden');
             } else {
                 accDisplay.style.color = "#ef4444"; 
                 passArea.classList.add('hidden');
                 failMsg.classList.remove('hidden');
             }

             document.getElementById('rank-text').innerText = `Time: ${totalTime.toFixed(2)}s | Misses: ${this.missCount}`;
             document.getElementById('result-title').innerText = "CHECKERED FLAG";
             
             const review = document.getElementById('review-list');
             let summaryHtml = `<div class="mb-4 font-bold text-white uppercase text-sm tracking-widest border-b border-gray-700 pb-2">Lap Analysis</div>`;
             if (this.missedWordsLog.length > 0) { summaryHtml += this.missedWordsLog.map(item => `<div class="mb-2 text-sm p-2 bg-red-900/10 border border-red-900/30 rounded"><span class="font-bold text-white block jp-font">${item.w}</span><span class="text-gray-400">${item.m}</span></div>`).join(''); } else { summaryHtml += '<p class="text-green-500 font-bold">Perfect Lap. No Issues Detected.</p>'; }
             review.innerHTML = summaryHtml;
             
            const nextBtn = document.getElementById('next-round-btn');
            const currentRound = this.vocabRounds[this.currentRoundIndex];

            if (!this.isPitStopMode) {
                if (currentRound && currentRound.id === 'random') {
                    nextBtn.classList.remove('hidden');
                    nextBtn.innerText = "AGAIN (SAME SETUP)"; 
                    nextBtn.onclick = () => { 
                        this.createRandomRound(); 
                    };
                } else if (this.currentRoundIndex + 1 < this.vocabRounds.length) {
                    nextBtn.classList.remove('hidden');
                    nextBtn.innerText = "NEXT SECTOR";
                    nextBtn.onclick = () => { 
                        document.getElementById('round-selector').value = this.currentRoundIndex + 1; 
                        this.start(); 
                    };
                } else {
                    nextBtn.classList.add('hidden');
                }
            } else { 
                nextBtn.classList.add('hidden'); 
            }
             
             if (window.fetchSRSItems) window.fetchSRSItems();
             if (window.incrementDailyLaps) window.incrementDailyLaps(); 
         }

         returnToGrid() {
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
             if (window.fetchSRSItems) window.fetchSRSItems();
         }
        
         updatePitStopButton(count) {
             const text = document.getElementById('mistake-count-display');
             const overlay = document.getElementById('pit-alert-overlay');
             if (count > 0) {
                 text.innerText = "CRITICAL"; text.classList.remove('text-green-500'); text.classList.add('text-red-500');
                 overlay.classList.remove('hidden'); overlay.onclick = () => this.startPitStop();
             } else {
                 text.innerText = "OPTIMAL"; text.classList.add('text-green-500'); text.classList.remove('text-red-500');
                 overlay.classList.add('hidden');
             }
         }
        
         startPitStop() {
             if (!this.dueMistakes || this.dueMistakes.length === 0) return;
             const vocabDue = this.dueMistakes;
             if (!vocabDue || vocabDue.length === 0) return;

             this.isPitStopMode = true; 
             
             this.questions = vocabDue.map(item => {
                 const word = item.word || item.w;
                 const meaningArray = Array.isArray(item.meaning) ? item.meaning : [item.meaning || item.m];
                 // 復習時もランダムに意味を1つ選ぶ
                 const randomMeaning = meaningArray[Math.floor(Math.random() * meaningArray.length)];

                 const targetWord = { w: word, m: meaningArray };
                 
                 const distractors = this.getDistractors(targetWord, false);
                 const options = [randomMeaning, ...distractors].sort(() => Math.random() - 0.5);
                 
                 return { 
                     w: word, 
                     m: meaningArray, 
                     displayM: randomMeaning,
                     qText: word, 
                     aText: randomMeaning, 
                     o: options, 
                     docId: item.id, 
                     interval: item.interval || 0, 
                     repetitions: item.repetitions || 0, 
                     easeFactor: item.easeFactor || 2.5 
                 };
             });
             
             this.questions.sort(() => Math.random() - 0.5);
             this.currentIndex = 0; this.missCount = 0; this.missedWordsLog = [];
             this.currentStreak = 0; this.maxStreak = 0;
             document.getElementById('circuit-name').innerText = "SRS PIT STOP";
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('quiz-screen').classList.remove('hidden');
             
             this.startTime = Date.now();
             this.startTimer();
             this.showVocabQuestion();
         }
        
         openTelemetry() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('telemetry-screen').classList.remove('hidden');
             const mistakes = this.allMistakes || [];
             const worstWords = [...mistakes].sort((a, b) => (a.easeFactor || 2.5) - (b.easeFactor || 2.5)).slice(0, 20);
             const listContainer = document.getElementById('worst-words-list');
             if (worstWords.length === 0) listContainer.innerHTML = `<div class="text-gray-500 text-xs italic">No degradation.</div>`;
             else {
                 listContainer.innerHTML = worstWords.map(item => `
                     <div class="flex justify-between items-center bg-gray-900/40 p-3 rounded-lg border-l-2 border-red-500 mb-1">
                         <span class="font-bold text-gray-200 text-xs jp-font">${item.word || item.w}</span>
                         <span class="text-[10px] text-gray-500 font-mono">EF:${(item.easeFactor||2.5).toFixed(2)}</span>
                     </div>`).join('');
             }
             const ctx = document.getElementById('weaknessRadarChart').getContext('2d');
             if (this.telemetryChart) this.telemetryChart.destroy();
             const buckets = [0, 0, 0, 0, 0];
             mistakes.forEach(m => {
                 const int = m.interval || 0;
                 if (int <= 1) buckets[0]++; else if (int <= 6) buckets[1]++; else if (int <= 14) buckets[2]++; else if (int <= 30) buckets[3]++; else buckets[4]++;
             });
             this.telemetryChart = new Chart(ctx, {
                 type: 'bar',
                 data: { labels: ['1d', '2-6d', '2w', '1mo', 'Master'], datasets: [{ data: buckets, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'], borderColor: '#333', borderWidth: 1 }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8' } } } }
             });
         }
         closeOverlay(id) {
             document.getElementById(id).classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
         }

         openWordBook() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('wordbook-screen').classList.remove('hidden');
             this.bookmarkedOnly = false;
             document.getElementById('wb-filter-btn').innerText = "ALL";
             this.renderWordBook();
         }

         toggleBookFilter() {
             this.bookmarkedOnly = !this.bookmarkedOnly;
             document.getElementById('wb-filter-btn').innerText = this.bookmarkedOnly ? "FLAGGED" : "ALL";
             document.getElementById('wb-filter-btn').className = this.bookmarkedOnly 
                 ? "bg-red-600 text-white px-3 rounded border border-red-800 text-xs font-bold uppercase hover:bg-red-500 transition-colors" 
                 : "bg-gray-800 text-white px-3 rounded border border-gray-600 text-xs font-bold uppercase hover:bg-gray-700 transition-colors";
             this.renderWordBook();
         }

        // ===== FREE PRACTICE (フラッシュカード) モード =====
        startFPMode() {
            if(this.vocabRounds.length === 0) { alert("Data not loaded"); return; }
            const selector = document.getElementById('round-selector');
            this.currentRoundIndex = parseInt(selector.value);
            const selectedRound = this.vocabRounds[this.currentRoundIndex];
            
            this.fpQuestions = selectedRound.words;
            this.fpIndex = 0;
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('fp-screen').classList.remove('hidden');
            
            this.showFPCard();
        }
        
        showFPCard() {
            const q = this.fpQuestions[this.fpIndex];
            document.getElementById('fp-counter').innerText = `LAP ${this.fpIndex + 1} / ${this.fpQuestions.length}`;
            document.getElementById('fp-word').innerText = q.w;
            document.getElementById('fp-meaning').innerText = q.m.join(' / ');
            document.getElementById('fp-goro').innerText = q.g ? q.g : "※NO DATA (語呂合わせ未登録)";
            
            // 常に表面（単語）からスタート
            document.getElementById('fp-front').classList.remove('hidden');
            document.getElementById('fp-back').classList.add('hidden');
        }
        
        flipFPCard() {
            const front = document.getElementById('fp-front');
            const back = document.getElementById('fp-back');
            if (!front.classList.contains('hidden')) {
                front.classList.add('hidden');
                back.classList.remove('hidden');
            } else {
                front.classList.remove('hidden');
                back.classList.add('hidden');
            }
        }
        
        nextFPCard() {
            if (this.fpIndex < this.fpQuestions.length - 1) {
                this.fpIndex++;
                this.showFPCard();
            } else {
                this.exitFPMode();
            }
        }
        
        prevFPCard() {
            if (this.fpIndex > 0) {
                this.fpIndex--;
                this.showFPCard();
            }
        }
        
        exitFPMode() {
            document.getElementById('fp-screen').classList.add('hidden');
            document.getElementById('start-screen').classList.remove('hidden');
        }

         renderWordBook() {
             const listEl = document.getElementById('wb-list');
             const query = document.getElementById('wb-search').value.toLowerCase().trim();
             const startVal = parseInt(document.getElementById('wb-start').value);
             const endVal = parseInt(document.getElementById('wb-end').value);

             listEl.innerHTML = '';

             let dataSrc = this.masterList.length > 0 ? this.masterList : (this.allMistakes || []);
             
             let merged = dataSrc.map((item, idx) => {
                 const srs = this.allMistakes.find(m => m.word === item.w || m.w === item.w);
                 // データセンターでは全意味を表示したいのでjoinする
                 const mStr = Array.isArray(item.m) ? item.m.join(' / ') : (item.meaning ? (Array.isArray(item.meaning) ? item.meaning.join(' / ') : item.meaning) : "");
                 
                 return {
                     w: item.w || item.word,
                     m: mStr,
                     id: idx,
                     srs: srs || null
                 };
             });

             const filtered = merged.filter(item => {
                 const matchQ = item.w.toLowerCase().includes(query) || item.m.toLowerCase().includes(query);
                 const matchBook = this.bookmarkedOnly ? (item.srs && item.srs.bookmarked) : true;
                 const wordNum = item.id + 1;
                 const matchRange = (!startVal || wordNum >= startVal) && (!endVal || wordNum <= endVal);

                 return matchQ && matchBook && matchRange;
             });

             if (filtered.length === 0) {
                 listEl.innerHTML = `<div class="text-gray-500 text-xs text-center py-4">No components found.</div>`;
                 return;
             }

             const displayLimit = 100;
             const viewData = filtered.slice(0, displayLimit);

             viewData.forEach(item => {
                 const div = document.createElement('div');
                 div.className = "flex items-center justify-between bg-gray-900/50 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors group";
                 
                 let statusColor = "bg-gray-700"; 
                 let statusText = "NEW";
                 if (item.srs) {
                     if (item.srs.interval > 14) { statusColor = "bg-green-500"; statusText = "OK"; }
                     else if (item.srs.interval > 3) { statusColor = "bg-yellow-500"; statusText = "WARN"; }
                     else { statusColor = "bg-red-500"; statusText = "CRIT"; }
                 }

                 const isBookmarked = item.srs && item.srs.bookmarked;
                 const safeW = encodeURIComponent(item.w);
                 const safeM = encodeURIComponent(item.m);
                 const displayW = item.w.replace(/</g, "&lt;").replace(/>/g, "&gt;");
                 const displayM = item.m.replace(/</g, "&lt;").replace(/>/g, "&gt;");

                 div.innerHTML = `
                     <div class="flex items-center gap-3 overflow-hidden">
                         <div class="w-1 h-8 ${statusColor} rounded-full shrink-0"></div>
                         <div class="text-left overflow-hidden">
                             <div class="flex items-center gap-2">
                                 <span class="text-[9px] text-yellow-500 font-mono opacity-70">No.${item.id + 1}</span>
                                 <span class="font-bold text-gray-200 text-sm jp-font truncate">${displayW}</span>
                                 <span class="text-[9px] text-gray-500 font-mono border border-gray-700 px-1 rounded">${statusText}</span>
                             </div>
                             <p class="text-[10px] text-gray-400 truncate">${displayM}</p>
                         </div>
                     </div>
                     <div class="flex items-center gap-2 shrink-0">
                         <button class="${isBookmarked ? 'text-red-500' : 'text-gray-600 hover:text-gray-400'} p-2" onclick="window.toggleBookmark('${safeW}', '${safeM}')">
                             ${isBookmarked ? '🚩' : '🏳️'}
                         </button>
                     </div>
                 `;
                 listEl.appendChild(div);
             });
             
             if(filtered.length > displayLimit) {
                  const more = document.createElement('div');
                  more.className = "text-center text-xs text-gray-600 py-2";
                  more.innerText = `...and ${filtered.length - displayLimit} more. Refine sector or search.`;
                  listEl.appendChild(more);
             }
         }
    }

    window.quiz = new HybridQuiz();
    </script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import { 
          getFirestore, collection, addDoc, query, where, getDocs, doc, setDoc, updateDoc, 
          Timestamp, orderBy, limit, runTransaction, onSnapshot, getDoc, increment,
          initializeFirestore, persistentLocalCache, 
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      // Kobun用Firebase Config
      const firebaseConfig = {
         apiKey: "AIzaSyC_30asSoRz9LAyYLuzYqxGhHJNWbuLvKE",
         authDomain: "kobun-b0fb5.firebaseapp.com",
        projectId: "kobun-b0fb5",
        storageBucket: "kobun-b0fb5.firebasestorage.app",
        messagingSenderId: "892077460039",
        appId: "1:892077460039:web:d2fb94787344b49087ff62",
        measurementId: "G-1RJJ1LPXS9"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      
      const db = initializeFirestore(app, {
          localCache: persistentLocalCache({
              tabManager: undefined 
          })
      });

      const gateScreen = document.getElementById('gate-screen');
      const startScreen = document.getElementById('start-screen');
      const loginStatus = document.getElementById('login-status');
      const gateLoginBtn = document.getElementById('gate-login-btn');
      
      window.currentUser = null;
      let unsubscribeStats = null;
      const statsRef = doc(db, "stats", "daily_global_kobun");

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          console.log("Authorized Driver:", user.displayName);
          window.currentUser = user;
          loginStatus.innerText = "Syncing Telemetry Data...";
          
          if (!unsubscribeStats) {
              unsubscribeStats = onSnapshot(statsRef, (docSnap) => {
                  if (docSnap.exists()) {
                      const data = docSnap.data();
                      const todayStr = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }).split(' ')[0];
                      if (data.date === todayStr) {
                          const display = document.getElementById('daily-laps-display');
                          if(display) display.innerText = data.count;
                      } else {
                          const display = document.getElementById('daily-laps-display');
                          if(display) display.innerText = 0;
                      }
                  }
              }, (error) => {
                  console.warn("Stats sync warning:", error.message);
              });
          }

          try {
              await window.fetchSRSItems();
              
              const userNameDisplay = document.getElementById('user-name');
              if(userNameDisplay) userNameDisplay.innerText = user.displayName || "RACING DRIVER";
              
              gateScreen.classList.add('hidden');
              
              const isQuizActive = !document.getElementById('quiz-screen').classList.contains('hidden');
              const isResultActive = !document.getElementById('result-screen').classList.contains('hidden');
              
              if (!isQuizActive && !isResultActive) {
                  startScreen.classList.remove('hidden');
              }
          } catch (error) {
              console.error("Init Error:", error);
              loginStatus.innerText = "Data Sync Failed. Retrying...";
              setTimeout(() => location.reload(), 3000);
          }

        } else {
          if (unsubscribeStats) {
              unsubscribeStats();
              unsubscribeStats = null;
          }

          window.currentUser = null;
          startScreen.classList.add('hidden');
          gateScreen.classList.remove('hidden');
          loginStatus.innerText = "System Standby...";
        }
      });

      gateLoginBtn.addEventListener('click', async () => {
        loginStatus.innerText = "Connecting to Paddock...";
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } 
        catch (error) { console.error(error); loginStatus.innerText = "Access Denied."; }
      });

      window.fetchSRSItems = async () => {
        if (!window.currentUser) return;
        const CACHE_KEY = `kobun_srs_data_${window.currentUser.uid}`;
        const TIME_KEY = `kobun_srs_time_${window.currentUser.uid}`;
        const CACHE_DURATION = 12 * 60 * 60 * 1000; 

        const now = Date.now();
        const lastFetch = parseInt(localStorage.getItem(TIME_KEY) || '0');
        let allItems = [];
        let loadedFromCache = false;

        if (now - lastFetch < CACHE_DURATION && localStorage.getItem(CACHE_KEY)) {
            try {
                const rawString = localStorage.getItem(CACHE_KEY);
                if (rawString) {
                    const rawData = JSON.parse(rawString);
                    allItems = rawData.map(item => ({ 
                        ...item, 
                        nextReview: { toDate: () => new Date(item.nextReviewSeconds * 1000) } 
                    }));
                    loadedFromCache = true;
                }
            } catch (e) { 
                console.warn("Cache corrupted"); 
                localStorage.removeItem(CACHE_KEY); 
            }
        }

        if (!loadedFromCache) {
            try {
                const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
                const snapshot = await getDocs(mistakesRef);
                allItems = [];
                snapshot.forEach(docSnap => {
                    const d = docSnap.data();
                    const nrSec = d.nextReview && d.nextReview.seconds ? d.nextReview.seconds : (Date.now()/1000);
                    allItems.push({ id: docSnap.id, ...d, nextReviewSeconds: nrSec });
                });
                localStorage.setItem(CACHE_KEY, JSON.stringify(allItems));
                localStorage.setItem(TIME_KEY, now.toString());
                allItems = allItems.map(item => ({ ...item, nextReview: { toDate: () => new Date(item.nextReviewSeconds * 1000) } }));
            } catch (e) { console.error("Telemetry Error:", e); throw e; }
        }

        const dueItems = [];
        const nowTs = Date.now() / 1000;
        
        allItems.forEach(item => { 
            if (item.nextReviewSeconds <= nowTs) {
                dueItems.push(item); 
            }
        });

        if(window.quiz) {
            window.quiz.allMistakes = allItems;
            window.quiz.dueMistakes = dueItems;
            window.quiz.updatePitStopButton(dueItems.length);
        }
      };

      window.handleSRSUpdate = async (questionObj, isCorrect) => {
        if (!window.currentUser) return;
        
        const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
        const now = new Date();
        const safeWordId = questionObj.docId || btoa(encodeURIComponent(questionObj.w)).replace(/\//g, '_').replace(/\+/g, '-');
        const targetRef = doc(mistakesRef, safeWordId);
        
        const currentParams = { 
            interval: questionObj.interval || 0, 
            repetitions: questionObj.repetitions || 0, 
            easeFactor: questionObj.easeFactor || 2.5 
        };
        
        const timeTaken = questionObj.timeTaken || 3.0;
        let nextInterval, nextRepetitions, nextEaseFactor;

        if (!isCorrect) {
            nextRepetitions = 0; 
            nextInterval = 1; 
            nextEaseFactor = Math.max(1.3, currentParams.easeFactor - 0.2); 
        } else {
            nextRepetitions = currentParams.repetitions + 1;
            
            let easeBonus = 0;
            if (timeTaken < 1.5) easeBonus = 0.3;
            else if (timeTaken > 5.0) easeBonus = -0.15;
            else easeBonus = 0.1;

            let rawEase = currentParams.easeFactor + easeBonus;
            nextEaseFactor = Math.min(3.0, Math.max(1.3, rawEase));

            if (nextRepetitions === 1) nextInterval = 1; 
            else if (nextRepetitions === 2) nextInterval = 6; 
            else nextInterval = Math.max(1, Math.round(currentParams.interval * nextEaseFactor));
        }

        const nextDate = new Date(); 
        nextDate.setDate(now.getDate() + nextInterval);
        const nextReviewSeconds = Math.floor(nextDate.getTime() / 1000);

        // Firestore保存（全意味配列を保存）
        setDoc(targetRef, { 
            word: questionObj.w, 
            meaning: questionObj.m, // 配列
            nextReview: Timestamp.fromDate(nextDate), 
            interval: nextInterval, 
            repetitions: nextRepetitions, 
            easeFactor: nextEaseFactor, 
            lastReviewed: Timestamp.fromDate(now) 
        }, { merge: true })
        .catch((e) => console.error("Telemetry Failed:", e));

        try {
            const CACHE_KEY = `kobun_srs_data_${window.currentUser.uid}`;
            const rawString = localStorage.getItem(CACHE_KEY);
            let localData = [];
            if (rawString) localData = JSON.parse(rawString);

            const index = localData.findIndex(item => item.word === questionObj.w || item.id === safeWordId);
            
            const newItemState = {
                id: safeWordId,
                word: questionObj.w,
                meaning: questionObj.m,
                nextReviewSeconds: nextReviewSeconds, 
                interval: nextInterval,
                repetitions: nextRepetitions,
                easeFactor: nextEaseFactor
            };

            if (index !== -1) {
                localData[index] = { ...localData[index], ...newItemState };
            } else {
                localData.push(newItemState);
            }

            localStorage.setItem(CACHE_KEY, JSON.stringify(localData));

            if(window.quiz && window.quiz.allMistakes) {
                const memIndex = window.quiz.allMistakes.findIndex(m => m.id === safeWordId || m.word === questionObj.w);
                
                if(memIndex !== -1) {
                     window.quiz.allMistakes[memIndex] = { 
                         ...window.quiz.allMistakes[memIndex], 
                         ...newItemState,
                         nextReview: { toDate: () => new Date(nextReviewSeconds * 1000) }
                     };
                }
                
                const nowTs = Date.now() / 1000;
                window.quiz.dueMistakes = window.quiz.allMistakes.filter(item => 
                    item.nextReviewSeconds <= nowTs
                );
                window.quiz.updatePitStopButton(window.quiz.dueMistakes.length);
            }

        } catch(e) {
            console.error("Cache Update Failed:", e);
        }
      };

      window.saveRaceResult = async (data) => {
          if (!window.currentUser) return;
          try {
              const now = new Date();
              const docId = now.getFullYear() + "-" +
                  ("0" + (now.getMonth() + 1)).slice(-2) + "-" +
                  ("0" + now.getDate()).slice(-2) + "_" +
                  ("0" + now.getHours()).slice(-2) +
                  ("0" + now.getMinutes()).slice(-2) +
                  ("0" + now.getSeconds()).slice(-2) + "-" +
                  ("00" + now.getMilliseconds()).slice(-4);

              const leaderboardDocRef = doc(db, "leaderboard", docId);
              const payload = {
                  uid: window.currentUser.uid,
                  driver: window.currentUser.displayName || "Unknown Driver",
                  date: now.toLocaleString('ja-JP'),
                  timestamp: Timestamp.now(), 
                  ...data                   
              };
              await setDoc(leaderboardDocRef, payload);
          } catch (e) { console.error(e); }
      };

      window.toggleBookmark = async (safeWord, safeMeaning) => {
          if (!window.currentUser) { alert("Sign in required."); return; }
          const word = decodeURIComponent(safeWord);
          const meaning = decodeURIComponent(safeMeaning); // ここで来るのは全意味文字列

          let currentItem = window.quiz.allMistakes.find(m => m.word === word || m.w === word);
          const isCurrentlyBookmarked = currentItem && currentItem.bookmarked === true;
          const newValue = !isCurrentlyBookmarked;

          if (currentItem) {
              currentItem.bookmarked = newValue;
          } else {
              // 新規追加
              // meaning文字列を配列に戻して保持してもよいが、表示用なので文字列のままでも運用可
              // ただしSRSロジックでは配列を期待しているので注意
              // ここでは簡易的に文字列を配列化して保持
              const mList = meaning.split(' / ');
              window.quiz.allMistakes.push({ 
                   word: word, meaning: mList, bookmarked: newValue, 
                   interval: 0, repetitions: 0, easeFactor: 2.5,
                   nextReviewSeconds: Date.now() / 1000 
              });
              currentItem = window.quiz.allMistakes.find(m => m.word === word);
          }
          window.quiz.renderWordBook(); 

          const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
          const docId = btoa(encodeURIComponent(word)).replace(/\//g, '_').replace(/\+/g, '-');
          const targetRef = doc(mistakesRef, docId);

          let safeNextReview = Timestamp.now();
          if (currentItem && currentItem.nextReviewSeconds) {
              safeNextReview = Timestamp.fromDate(new Date(currentItem.nextReviewSeconds * 1000));
          }

          try {
              await setDoc(targetRef, {
                  word: word,
                  meaning: currentItem.meaning || meaning.split(' / '), // 配列で保存
                  bookmarked: newValue,
                  interval: currentItem ? (currentItem.interval || 0) : 0,
                  repetitions: currentItem ? (currentItem.repetitions || 0) : 0,
                  easeFactor: currentItem ? (currentItem.easeFactor || 2.5) : 2.5,
                  nextReview: safeNextReview
              }, { merge: true });
          } catch(e) {
              console.error("Bookmark Error:", e);
              if(currentItem) currentItem.bookmarked = !newValue;
              window.quiz.renderWordBook();
          }
      };

      window.incrementDailyLaps = async () => {
          if (!window.currentUser) return; 
          const statsRef = doc(db, "stats", "daily_global_kobun");
          const todayStr = new Date().toLocaleString('ja-JP', { timeZone: 'Asia/Tokyo' }).split(' ')[0];
          try {
              await runTransaction(db, async (transaction) => {
                  const sfDoc = await transaction.get(statsRef);
                  if (!sfDoc.exists()) {
                      transaction.set(statsRef, { count: 1, date: todayStr });
                  } else {
                      const data = sfDoc.data();
                      if (data.date === todayStr) {
                          transaction.update(statsRef, { count: increment(1) });
                      } else {
                          transaction.set(statsRef, { count: 1, date: todayStr });
                      }
                  }
              });
          } catch (e) { console.error(e); }
      };
    </script>
</body>
</html>
