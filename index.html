<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#0b0e14">
    <title>Kobun GP</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Chakra+Petch:ital,wght@0,300;0,400;0,500;0,600;0,700;1,300;1,400;1,500;1,600;1,700&display=swap');
        
        :root { --f1-red: #e10600; --rb-navy: #0b0e14; }

    html, body {
        height: 100%; width: 100%; overflow: hidden; 
        background-color: #0b0e14; color: #e2e8f0;
        font-family: 'Inter', system-ui, -apple-system, sans-serif; /* Ê®ôÊ∫ñ„Ç¥„Ç∑„ÉÉ„ÇØ„Å´Êàª„Åô */
        -webkit-user-select: none; user-select: none;
        touch-action: manipulation;
    }

        /* ËÉåÊôØÂãïÁîª„ÅÆË®≠ÂÆö */
        #bg-video {
            position: fixed; right: 0; bottom: 0;
            min-width: 100%; min-height: 100%;
            width: auto; height: auto; z-index: -1;
            object-fit: cover; filter: brightness(0.5);
        }

       .f1-font { font-family: 'Chakra Petch', sans-serif; }
        /* .jp-font „ÇØ„É©„Çπ„ÅØÂâäÈô§„ÄÅ„ÇÇ„Åó„Åè„ÅØÁ©∫„Å´„Åó„Å¶„Åä„Åè */
        .jp-font { }

        .race-card {
            background: rgba(11, 14, 20, 0.85);
            backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        .option-btn { 
            transition: all 0.1s; position: relative; overflow: hidden;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(255, 255, 255, 0.05);
        }
        .option-btn:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.2); }
        .option-btn:disabled { opacity: 0.6; }

        .tire-btn { opacity: 0.4; transform: scale(0.95); transition: all 0.2s; border-width: 2px; }
        .tire-btn.active { opacity: 1; transform: scale(1); box-shadow: 0 0 15px rgba(255,255,255,0.1); }
        .tire-soft.active { border-color: #ef4444; color: #ef4444; } 
        .tire-medium.active { border-color: #eab308; color: #eab308; } 
        .tire-hard.active { border-color: #f8fafc; color: #f8fafc; } 

        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.3s ease-out forwards; }
        
        .wb-scroll::-webkit-scrollbar { width: 4px; }
        .wb-scroll::-webkit-scrollbar-track { background: #1a1a1a; }
        .wb-scroll::-webkit-scrollbar-thumb { background: #e10600; border-radius: 4px; }
    </style>
</head>
<body class="text-sm md:text-base">

    <video autoplay muted loop playsinline poster="./F1.jpg" id="bg-video">
        <source src="./f1.mp4" type="video/mp4">
    </video>

    <div id="app" class="w-full max-w-6xl mx-auto flex flex-col h-full p-4 overflow-hidden relative">
        
        <div id="gate-screen" class="race-card p-8 rounded-2xl text-center relative animate-slide-in my-auto max-w-md mx-auto w-full">
            <h1 class="f1-font text-5xl mb-2 font-bold text-white tracking-wider">KOBUN<span class="text-red-600">-GP</span></h1>
            <p class="text-gray-400 f1-font text-xs uppercase tracking-[0.4em] mb-12">Classical Japanese Racing</p>
            <button id="gate-login-btn" class="w-full f1-font bg-white hover:bg-gray-200 text-black px-8 py-4 rounded-xl font-bold tracking-widest uppercase transition-all shadow-lg flex items-center justify-center gap-3 active:scale-95">
                Sign In (Google)
            </button>
            <p id="login-status" class="mt-6 text-[10px] text-gray-600 font-mono">System Standby...</p>
        </div>

        <div id="start-screen" class="hidden race-card p-4 md:p-6 rounded-2xl relative z-10 animate-slide-in my-auto w-full max-w-5xl mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
                <div class="md:col-span-5 flex flex-col gap-6">
                    <div class="flex justify-between items-end border-b border-gray-700 pb-4">
                        <div class="flex items-center gap-3">
                            <div class="w-3 h-3 rounded-full bg-green-500 animate-pulse shadow-[0_0_10px_#22c55e]"></div>
                            <p id="user-name" class="f1-font text-xl text-white font-bold truncate">DRIVER</p>
                        </div>
                        <div class="text-right">
                            <span class="text-[10px] text-gray-500 uppercase tracking-widest block">Daily Laps</span>
                            <span id="daily-laps-display" class="f1-font text-3xl text-white font-bold leading-none">0</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div id="tire-status-box" class="bg-red-900/20 p-4 rounded-xl border border-red-900/30 text-center relative overflow-hidden group hover:bg-red-900/30 transition-colors cursor-pointer">
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-1">Review Status</p>
                            <span id="mistake-count-display" class="f1-font text-xl text-green-500 font-bold">OPTIMAL</span>
                            <div id="pit-alert-overlay" class="hidden absolute inset-0 bg-red-600 flex items-center justify-center animate-pulse">
                                <span class="f1-font text-white font-bold text-sm">PIT STOP REQUIRED</span>
                            </div>
                        </div>
                        <button onclick="quiz.openTelemetry()" class="bg-blue-900/20 p-4 rounded-xl border border-blue-900/30 flex flex-col items-center justify-center hover:bg-blue-900/30 transition-colors">
                            <span class="text-2xl mb-1">üìä</span>
                            <span class="text-[10px] text-blue-300 uppercase font-bold tracking-widest">Data Analysis</span>
                        </button>
                    </div>

                    <button onclick="quiz.start()" class="w-full f1-font bg-gradient-to-r from-red-600 to-red-700 hover:from-red-500 text-white py-6 rounded-xl font-bold tracking-[0.2em] uppercase transition-all shadow-lg shadow-red-900/40 text-2xl border-b-4 border-red-900 mt-auto active:border-b-0 active:translate-y-1">
                        Start Engine
                    </button>
                </div>

                <div class="md:col-span-7 flex flex-col gap-4 border-t md:border-t-0 md:border-l border-gray-700 pt-6 md:pt-0 md:pl-8">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-gray-400">‚öôÔ∏è</span>
                        <h3 class="f1-font text-lg font-bold text-white tracking-widest uppercase">Race Strategy</h3>
                        <p id="strategy-summary" class="ml-auto text-[10px] text-gray-500 font-mono border border-gray-700 px-2 py-1 rounded">Setup: Standard</p>
                    </div>

                    <div class="space-y-5">
                        <div>
                            <label class="text-gray-500 text-[10px] uppercase tracking-widest block mb-2">Sector Selection</label>
                            <div class="relative">
                                <select id="round-selector" class="w-full bg-black/50 text-white p-3 rounded-lg border border-gray-600 focus:border-red-500 outline-none font-mono text-xs appearance-none cursor-pointer hover:bg-black/70 transition-colors" onchange="quiz.updateSummary()"></select>
                                <div class="absolute right-4 top-1/2 transform -translate-y-1/2 pointer-events-none text-gray-500">‚ñº</div>
                            </div>
                        </div>

                        <div>
                            <p class="text-[10px] text-gray-500 uppercase tracking-widest mb-3">Laps (Questions)</p>
                            <div class="grid grid-cols-3 gap-3">
    <button onclick="quiz.setTireStrategy(10, 'soft')" id="tire-soft" class="tire-btn tire-soft bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
        <span class="block text-xs mb-1">üî¥ Soft</span>(10)
    </button>
    <button onclick="quiz.setTireStrategy(20, 'medium')" id="tire-medium" class="tire-btn tire-medium active bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
        <span class="block text-xs mb-1">üü° Medium</span>(20)
    </button>
    <button onclick="quiz.setTireStrategy(50, 'hard')" id="tire-hard" class="tire-btn tire-hard bg-black/40 text-gray-400 py-3 rounded-lg border border-gray-700 f1-font text-xs font-bold uppercase tracking-wider hover:bg-gray-800">
        <span class="block text-xs mb-1">‚ö™ Hard</span>(50)
    </button>
</div>
                        </div>

                        <div class="grid grid-cols-1 gap-4">
                             <label class="flex items-center justify-between cursor-pointer group bg-black/30 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors">
                                <span class="text-xs font-bold text-gray-300 group-hover:text-cyan-400 transition-colors flex items-center gap-2">
                                    <span class="text-cyan-400">üîÑ</span> REVERSE GRID (Áèæ‰ª£Ë™ûË®≥ ‚áí Âè§ÊñáÂçòË™û)
                                </span>
                                <input type="checkbox" id="reverse-mode" class="w-5 h-5 cursor-pointer accent-red-600" onchange="quiz.updateSummary()">
                            </label>
                        </div>

                        <div class="pt-4 border-t border-gray-700">
                            <button onclick="quiz.openWordBook()" class="w-full bg-gray-700 hover:bg-gray-600 text-gray-200 border border-gray-600 py-3 rounded-lg font-bold transition-all uppercase text-xs flex items-center justify-center gap-2">
                                <span>üìÅ</span> OPEN DATA CENTER (ÂçòË™ûÂ∏≥)
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="telemetry-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-blue-500 h-[90%] my-auto z-40 absolute inset-4">
            <div class="flex justify-between items-center mb-4">
                <h2 class="f1-font text-2xl font-bold text-blue-400 tracking-widest">TELEMETRY</h2>
                <button onclick="quiz.closeOverlay('telemetry-screen')" class="text-gray-400 active:text-white text-3xl p-2">&times;</button>
            </div>
            <div class="bg-black/50 p-2 rounded-xl mb-4 border border-gray-800 h-64 w-full relative">
                <canvas id="weaknessRadarChart"></canvas>
            </div>
            <div class="text-left mb-4 h-full overflow-hidden flex flex-col">
                <h3 class="text-xs text-red-500 font-bold uppercase tracking-widest mb-2 flex-shrink-0">Degradation Report (Ëã¶ÊâãÂçòË™û)</h3>
                <div id="worst-words-list" class="space-y-1 overflow-y-auto pr-2 flex-grow scrollbar-thin"></div>
            </div>
        </div>
        
        <div id="wordbook-screen" class="hidden race-card p-6 rounded-2xl text-center border-t-4 border-yellow-500 h-[90%] my-auto z-50 flex flex-col absolute inset-4">
            <div class="flex justify-between items-center mb-4 flex-shrink-0">
                <h2 class="f1-font text-2xl font-bold text-yellow-500 tracking-widest">DATA CENTER</h2>
                <button onclick="quiz.closeOverlay('wordbook-screen')" class="text-gray-400 active:text-white text-3xl p-2">&times;</button>
            </div>
            <div class="flex gap-2 mb-4 flex-shrink-0">
                <input type="text" id="wb-search" placeholder="Search..." class="flex-1 bg-black text-white p-2 text-sm rounded border border-gray-700 focus:border-yellow-500 outline-none">
                <button id="wb-filter-btn" class="bg-gray-800 text-white px-3 rounded border border-gray-600 text-xs font-bold uppercase hover:bg-gray-700 transition-colors" onclick="quiz.toggleBookFilter()">ALL</button>
            </div>
            <div id="wb-list" class="flex-1 overflow-y-auto wb-scroll text-left space-y-2 pr-1"></div>
        </div>

        <div id="quiz-screen" class="hidden race-card p-6 rounded-2xl shadow-2xl relative flex flex-col justify-between my-auto min-h-[500px] w-full max-w-5xl mx-auto">
            <div class="flex justify-between items-start mb-6">
                <div class="flex flex-col text-left">
                    <span id="circuit-name" class="f1-font text-[10px] text-gray-400 uppercase tracking-widest">ROUND 1</span>
                    <span id="question-number" class="f1-font text-white font-bold text-lg">LAP 1/20</span>
                </div>
                <div class="text-right">
                    <div id="timer" class="f1-font text-2xl text-yellow-400 font-mono">0.00s</div>
                </div>
            </div>
            <div class="w-full bg-gray-800 h-1 mb-8 rounded-full overflow-hidden">
                <div id="progress-fill" class="bg-gradient-to-r from-red-600 to-yellow-500 h-full w-0 transition-all duration-300"></div>
            </div>
            
            <div class="flex-grow flex flex-col items-center justify-center mb-8 relative">
                <div class="absolute -top-6 text-gray-500 text-[10px] uppercase tracking-widest" id="question-label">Target</div>
                <h2 id="target-word" class="jp-font text-5xl md:text-7xl font-bold text-white tracking-wide drop-shadow-xl break-words px-2 text-center transition-all py-8"></h2>
            </div>
            
            <div id="options-container" class="grid grid-cols-1 md:grid-cols-2 gap-4 max-w-4xl mx-auto w-full"></div>

            <div id="feedback" class="h-8 mt-4 flex items-center justify-center text-sm font-bold tracking-wider uppercase"></div>
        </div>

        <div id="result-screen" class="hidden race-card p-8 rounded-2xl shadow-2xl text-center animate-slide-in my-auto max-w-2xl mx-auto w-full">
            <h2 class="f1-font text-4xl mb-2 font-bold text-white italic tracking-tighter">CHECKERED FLAG</h2>
            <div class="w-full h-1 bg-gradient-to-r from-transparent via-red-600 to-transparent opacity-50 mb-8"></div>
            
            <div id="accuracy-display" class="f1-font text-8xl font-bold mb-2 text-white glitch-text tracking-tighter">100%</div>
            <p id="rank-text" class="f1-font text-sm mb-8 text-gray-400 font-mono"></p>
            
            <div class="bg-black/40 p-4 rounded-xl mb-8 text-left max-h-48 overflow-y-auto border border-gray-800 scrollbar-thin" id="review-list"></div>
            
            <div class="grid grid-cols-2 gap-4">
                <button onclick="quiz.returnToGrid()" class="f1-font border border-gray-600 hover:bg-gray-800 text-white py-4 rounded-xl font-bold transition-all uppercase text-sm tracking-wider">Garage</button>
                <button id="next-round-btn" class="f1-font bg-red-600 hover:bg-red-500 text-white py-4 rounded-xl font-bold transition-all shadow-lg shadow-red-900/50 uppercase text-sm tracking-wider">Next Sector</button>
            </div>
        </div>
    </div>

    <script>
      // ‚òÖÂè§Êñá„Éá„Éº„ÇøÔºà„Åì„Åì„Å´„Éá„Éº„Çø„ÇíËøΩÂä†„Åó„Å¶„Åè„Å†„Åï„ÅÑÔºâ
      // „Éï„Ç©„Éº„Éû„ÉÉ„Éà: „ÄåÂè§ÊñáÂçòË™û: ÊÑèÂë≥1 | ÊÑèÂë≥2 | ÊÑèÂë≥3„Äç
      const rawData = `
„Åä„Å©„Çç„Åè: „ÅØ„Å£„Å®Ê∞ó„Å•„Åè | ÁõÆ„ÅåË¶ö„ÇÅ„Çã
„Å≠„Çì„Åö: Á•à„Çã | ÊàëÊÖ¢„Åô„Çã
„ÅÇ„Å¶„Å™„Çä: Ë∫´ÂàÜ„ÅåÈ´ò„ÅÑ | ‰∏äÂìÅ„Å†
„ÅÆ„ÅÆ„Åó„Çã: Â§ßÈ®í„Åé„Åô„Çã | Ë©ïÂà§„Å´„Å™„Çã | Âã¢„ÅÑ„ÅåÁõõ„Çì„Å†
„ÇÑ„Åå„Å¶: „Åù„ÅÆ„Åæ„Åæ | „Åô„Åê„Å´
„Åë„Åó„Åç: ÊßòÂ≠ê | Ê©üÂ´å | ÊÄù„ÅÑ
„ÅÜ„Å§„Åè„Åó: „Åã„Çè„ÅÑ„Çâ„Åó„ÅÑ | Á´ãÊ¥æ„Å†
„Åã„Å™„Åó: „ÅÑ„Å®„Åó„ÅÑ | „Åã„Çè„ÅÑ„ÅÑ | ÊÇ≤„Åó„ÅÑ
„Çí„Åã„Åó: Ë∂£„Åå„ÅÇ„Çã | „Åä„ÇÇ„Åó„Çç„ÅÑ | Áæé„Åó„ÅÑ
„ÅÇ„ÅØ„Çå„Å™„Çä: „Åó„Åø„Åò„Åø„Å®ÊÉÖË∂£Ê∑±„ÅÑ | Ê∞ó„ÅÆÊØí„Å†
      `; 

    document.addEventListener('dblclick', function(event) { event.preventDefault(); }, { passive: false });

    class HybridQuiz {
        constructor() {
            this.wordsPerRound = 20; 
            this.masterList = [];
            this.vocabRounds = [];
            this.currentRoundIndex = 0;
            this.questions = [];
            this.currentIndex = 0;
            this.missCount = 0;
            this.missedWordsLog = [];
            this.startTime = 0;
            this.timerInterval = null;
            this.allMistakes = []; 
            this.dueMistakes = [];
            this.bookmarkedOnly = false;
            this.isPitStopMode = false;
            this.isReverseMode = false;

            document.getElementById('wb-search').addEventListener('input', () => this.renderWordBook());

            this.parseData();
            this.generateRounds();
            this.initUI();
        }

        parseData() {
            if(!rawData.trim()) { this.masterList = []; return; }
            const lines = rawData.split('\n').map(l => l.trim()).filter(l => l.length > 0);
            this.masterList = [];
            lines.forEach(line => {
                // „Çª„Éë„É¨„Éº„Çø„ÅØ„Ç≥„É≠„É≥„ÅãÂÖ®Ëßí„Ç≥„É≠„É≥
                let sep = -1;
                if (line.indexOf(':') !== -1) sep = line.indexOf(':');
                else if (line.indexOf('Ôºö') !== -1) sep = line.indexOf('Ôºö');
                
                if (sep !== -1) {
                    const w = line.substring(0, sep).trim();
                    const mRaw = line.substring(sep + 1).trim();
                    // „Éë„Ç§„Éó | „ÅßÂå∫Âàá„Å£„Å¶ÈÖçÂàó„Å´„Åô„Çã
                    const meanings = mRaw.split('|').map(m => m.trim());
                    this.masterList.push({ w: w, m: meanings });
                }
            });
        }

        generateRounds() {
            const wordCopy = [...this.masterList]; 
            this.vocabRounds = [];
            let roundNum = 1;
            while (wordCopy.length > 0) {
                const chunk = wordCopy.splice(0, this.wordsPerRound);
                if (chunk.length > 0) {
                    this.vocabRounds.push({ id: roundNum, name: `SECTOR ${roundNum}`, words: chunk });
                    roundNum++;
                }
            }
        }

        initUI() {
            const selector = document.getElementById('round-selector');
            selector.innerHTML = '';
            if(this.vocabRounds.length === 0) { selector.innerHTML = '<option>No Data Loaded</option>'; }
            else {
                this.vocabRounds.forEach((round, index) => {
                    const opt = document.createElement('option');
                    opt.value = index;
                    opt.text = round.name;
                    selector.appendChild(opt);
                });
            }
            this.updateSummary();
        }

        updateSummary() {
            const selector = document.getElementById('round-selector');
            let roundName = selector.options[selector.selectedIndex]?.text || "Unknown";
            const tire = this.wordsPerRound;
            const rev = document.getElementById('reverse-mode').checked ? "REV" : "STD";
            document.getElementById('strategy-summary').innerText = `${roundName} | ${tire} Qs | ${rev}`;
        }

        setTireStrategy(count, type) {
            this.wordsPerRound = count;
            this.generateRounds();
            this.initUI();
            document.querySelectorAll('.tire-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tire-${type}`).classList.add('active');
            this.updateSummary();
        }

        start() {
            this.currentIndex = 0;
            this.missCount = 0;
            this.missedWordsLog = [];
            this.startTime = Date.now();
            this.startTimer();
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('result-screen').classList.add('hidden');
            document.getElementById('quiz-screen').classList.remove('hidden');
            
            this.startVocabMode();
        }

        startVocabMode() {
            if(this.vocabRounds.length === 0) { alert("Data Error"); this.returnToGrid(); return; }
            this.isPitStopMode = false;
            
            const selector = document.getElementById('round-selector');
            this.currentRoundIndex = parseInt(selector.value);
            const selectedRound = this.vocabRounds[this.currentRoundIndex];
            
            this.isReverseMode = document.getElementById('reverse-mode').checked;

            document.getElementById('circuit-name').innerText = selectedRound.name + (this.isReverseMode ? " [REV]" : "");
            document.getElementById('question-label').innerText = this.isReverseMode ? "TRANSLATE TO KOBUN" : "MEANING";

            this.questions = selectedRound.words.map(target => {
                // ‚òÖÂ§öÁæ©Ë™ûÂØæÂøúÔºö„É©„É≥„ÉÄ„É†„Å´1„Å§„ÅÆÊÑèÂë≥„ÇíÈÅ∏„Å∂
                const randomMeaning = target.m[Math.floor(Math.random() * target.m.length)];
                
                const qText = this.isReverseMode ? randomMeaning : target.w;
                const aText = this.isReverseMode ? target.w : randomMeaning;
                
                // ÈÅ∏ÊäûËÇ¢‰ΩúÊàê
                const distractors = this.getDistractors(target, this.isReverseMode);
                const options = [aText, ...distractors].sort(() => Math.random() - 0.5);
                
                const existingData = (this.allMistakes || []).find(item => item.word === target.w) || {};

                return { 
                    w: target.w, 
                    mAll: target.m.join(' / '), // ÂÖ®„Å¶„ÅÆÊÑèÂë≥ÔºàË®òÈå≤Áî®Ôºâ
                    qText: qText, 
                    aText: aText, 
                    o: options,
                    docId: existingData.id || null, 
                    interval: existingData.interval || 0,
                    repetitions: existingData.repetitions || 0,
                    easeFactor: existingData.easeFactor || 2.5
                };
            });
            this.questions.sort(() => Math.random() - 0.5);
            this.showQuestion();
        }
        
        getDistractors(target, isReverse) {
             const distractors = [];
             // Ëá™ÂàÜ‰ª•Â§ñ„ÅÆÂçòË™û„É™„Çπ„Éà
             const otherWords = this.masterList.filter(item => item.w !== target.w);
             
             if(otherWords.length < 3) return ["Option A", "Option B", "Option C"]; 

             let attempts = 0;
             while (distractors.length < 3 && attempts < 100) {
                 const r = otherWords[Math.floor(Math.random() * otherWords.length)];
                 
                 // Reverse„É¢„Éº„Éâ„Å™„ÇâÂçòË™û(w)„Çí„ÄÅÈÄöÂ∏∏„É¢„Éº„Éâ„Å™„ÇâÊÑèÂë≥„É™„Çπ„Éà(m)„Åã„Çâ„É©„É≥„ÉÄ„É†„Å´1„Å§ÈÅ∏„Å∂
                 const candidate = isReverse ? r.w : r.m[Math.floor(Math.random() * r.m.length)];
                 
                 if (!distractors.includes(candidate) && candidate !== (isReverse ? target.w : target.m)) {
                     distractors.push(candidate);
                 }
                 attempts++;
             }
             return distractors;
         }

         showQuestion() {
             showQuestion() {
     const q = this.questions[this.currentIndex];
     document.getElementById('question-number').innerText = `LAP ${this.currentIndex + 1} / ${this.questions.length}`;
     
     const targetDisplay = document.getElementById('target-word');
     targetDisplay.innerText = q.qText;
             
             // „Éï„Ç©„É≥„ÉàÂàá„ÇäÊõø„ÅàÔºàÂè§ÊñáÂçòË™û„Å™„ÇâÊòéÊúù‰Ωì„ÄÅÁèæ‰ª£Ë™û„Å™„Çâ„Ç¥„Ç∑„ÉÉ„ÇØÂØÑ„ÇäÔºâ
             //if (!this.isReverseMode) targetDisplay.classList.add('jp-font');
             //else targetDisplay.classList.remove('jp-font');

             document.getElementById('progress-fill').style.width = `${(this.currentIndex / this.questions.length) * 100}%`;
             document.getElementById('feedback').innerText = '';
             
             const container = document.getElementById('options-container');
             container.innerHTML = '';
             
             q.o.forEach(opt => {
                 const btn = document.createElement('button');
                 // ÈÅ∏ÊäûËÇ¢„ÅÆÊñáÂ≠ó„Çµ„Ç§„Ç∫Ë™øÊï¥ÔºàÁèæ‰ª£Ë™ûË®≥„ÅØÈï∑„Åè„Å™„Çä„Åå„Å°„Å™„ÅÆ„ÅßÔºâ
                 const fontClass = "text-lg md:text-xl jp-font";
                 btn.className = `option-btn w-full flex items-center justify-center p-4 rounded-xl text-white font-bold shadow-lg ${fontClass} min-h-[80px]`;
                 btn.innerText = opt;
                 btn.onclick = () => this.handleAnswer(opt, q);
                 container.appendChild(btn);
             });
         }

         handleAnswer(selected, q) {
             const btns = document.querySelectorAll('.option-btn');
             btns.forEach(b => b.disabled = true);

             const feedback = document.getElementById('feedback');
             const isCorrect = (selected === q.aText);

             // FirebaseÊõ¥Êñ∞Áî®ÔºàÊ≠£Ëß£„Éª‰∏çÊ≠£Ëß£„Å´„Åã„Åã„Çè„Çâ„ÅöÂçòË™ûID„ÅßÊõ¥Êñ∞Ôºâ
             if (window.handleSRSUpdate) {
                 window.handleSRSUpdate(q, isCorrect);
             }

             if (isCorrect) {
                 feedback.innerHTML = `<span class="text-[#39ff14] text-xs font-bold animate-pulse">üü£ PURPLE SECTOR (OK)</span>`;
                 setTimeout(() => this.next(), 400); 
             } else {
                 this.missCount++;
                 feedback.innerText = `WRONG: ${q.aText}`;
                 feedback.className = "mt-4 text-center h-6 font-bold text-red-500 animate-pulse";
                 this.missedWordsLog.push({ w: q.w, m: q.mAll });
                 // ÈñìÈÅï„Åà„ÅüÂïèÈ°å„ÅØÂæå„Çç„Å´ËøΩÂä†„Åó„Å¶ÂÜçÂá∫È°å
                 this.questions.push(q);
                 setTimeout(() => { 
                     this.next(); 
                 }, 1500);
             }
         }
         
         next() {
             this.currentIndex++;
             if (this.currentIndex < this.questions.length) this.showQuestion();
             else this.finish();
         }

         startTimer() {
             if (this.timerInterval) clearInterval(this.timerInterval);
             this.timerInterval = setInterval(() => { document.getElementById('timer').innerText = ((Date.now() - this.startTime) / 1000).toFixed(2) + 's'; }, 50);
         }

         finish() {
             clearInterval(this.timerInterval);
             document.getElementById('quiz-screen').classList.add('hidden');
             document.getElementById('result-screen').classList.remove('hidden');
             
             // „Çπ„Ç≥„Ç¢Ë®àÁÆóÔºàËøΩÂä†„Åï„Çå„Åü„Éö„Éä„É´„ÉÜ„Ç£ÂïèÈ°åÂàÜ„ÅØÊØçÊï∞„Åã„ÇâÈô§„Åè„Å™„Å©Ë™øÊï¥ÂèØ„Å†„Åå„ÄÅ„Åì„Åì„Åß„ÅØÂçòÁ¥îË®àÁÆóÔºâ
             const totalQs = this.questions.length; 
             const uniqueQs = this.wordsPerRound; // Êú¨ÂΩì„ÅÆÂïèÈ°åÊï∞
             const correctCount = uniqueQs - (this.missedWordsLog.length); // ÂàùÂõûÊ≠£Ëß£Êï∞„Éô„Éº„Çπ
             let accuracy = Math.max(0, (correctCount / uniqueQs) * 100);
             
             document.getElementById('accuracy-display').innerText = `${accuracy.toFixed(0)}%`;
             document.getElementById('rank-text').innerText = `Misses: ${this.missedWordsLog.length}`;
             
             const review = document.getElementById('review-list');
             review.innerHTML = this.missedWordsLog.length > 0 
                ? this.missedWordsLog.map(item => `<div class="mb-2 text-sm p-2 bg-red-900/10 border border-red-900/30 rounded"><span class="font-bold text-white block jp-font">${item.w}</span><span class="text-gray-400">${item.m}</span></div>`).join('') 
                : '<p class="text-green-500 font-bold">Perfect Lap. No Issues Detected.</p>';

            // Ê¨°„ÅÆ„É©„Ç¶„É≥„Éâ„Å∏ÈÄ≤„ÇÄ„Éú„Çø„É≥
            const nextBtn = document.getElementById('next-round-btn');
            if (this.currentRoundIndex + 1 < this.vocabRounds.length && !this.isPitStopMode) {
                nextBtn.classList.remove('hidden');
                nextBtn.onclick = () => { 
                    document.getElementById('round-selector').value = this.currentRoundIndex + 1; 
                    this.start(); 
                };
            } else {
                nextBtn.classList.add('hidden');
            }
             
             if (window.fetchSRSItems) window.fetchSRSItems();
             if (window.incrementDailyLaps) window.incrementDailyLaps(); 
         }

         returnToGrid() {
             document.getElementById('result-screen').classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
             if (window.fetchSRSItems) window.fetchSRSItems();
         }
        
         // SRSÂæ©Áøí„É¢„Éº„ÉâÔºàPIT STOPÔºâ
         updatePitStopButton(count) {
             const text = document.getElementById('mistake-count-display');
             const overlay = document.getElementById('pit-alert-overlay');
             if (count > 0) {
                 text.innerText = "CRITICAL"; text.classList.remove('text-green-500'); text.classList.add('text-red-500');
                 overlay.classList.remove('hidden'); 
                 document.getElementById('tire-status-box').onclick = () => this.startPitStop();
             } else {
                 text.innerText = "OPTIMAL"; text.classList.add('text-green-500'); text.classList.remove('text-red-500');
                 overlay.classList.add('hidden');
                 document.getElementById('tire-status-box').onclick = null;
             }
         }
        
         startPitStop() {
             if (!this.dueMistakes || this.dueMistakes.length === 0) return;
             this.isPitStopMode = true; 
             
             this.questions = this.dueMistakes.map(item => {
                 // ÈÖçÂàóÂåñ„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÂè§„ÅÑ„Éá„Éº„Çø„Åå„ÅÇ„ÇãÂ†¥Âêà„ÅÆ„Ç¨„Éº„Éâ
                 const meanings = Array.isArray(item.meaning) ? item.meaning : [item.meaning];
                 const randomMeaning = meanings[Math.floor(Math.random() * meanings.length)];
                 const distractors = this.getDistractors({w: item.word, m: meanings}, false);
                 const options = [randomMeaning, ...distractors].sort(() => Math.random() - 0.5);
                 
                 return { 
                     w: item.word, 
                     mAll: meanings.join(' / '), 
                     qText: item.word, 
                     aText: randomMeaning, 
                     o: options, 
                     docId: item.id, 
                     interval: item.interval, 
                     repetitions: item.repetitions, 
                     easeFactor: item.easeFactor 
                 };
             });
             
             this.questions.sort(() => Math.random() - 0.5);
             this.currentIndex = 0; this.missCount = 0; this.missedWordsLog = [];
             document.getElementById('circuit-name').innerText = "SRS PIT STOP";
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('quiz-screen').classList.remove('hidden');
             this.startTime = Date.now();
             this.startTimer();
             this.showQuestion();
         }
        
         openTelemetry() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('telemetry-screen').classList.remove('hidden');
             const mistakes = this.allMistakes || [];
             const worstWords = [...mistakes].sort((a, b) => (a.easeFactor || 2.5) - (b.easeFactor || 2.5)).slice(0, 20);
             const listContainer = document.getElementById('worst-words-list');
             
             if (worstWords.length === 0) listContainer.innerHTML = `<div class="text-gray-500 text-xs italic">No degradation.</div>`;
             else {
                 listContainer.innerHTML = worstWords.map(item => `
                     <div class="flex justify-between items-center bg-gray-900/40 p-3 rounded-lg border-l-2 border-red-500 mb-1">
                         <span class="font-bold text-gray-200 text-sm jp-font">${item.word}</span>
                         <span class="text-[10px] text-gray-500 font-mono">EF:${(item.easeFactor||2.5).toFixed(2)}</span>
                     </div>`).join('');
             }
             // „Ç∞„É©„ÉïÊèèÁîª
             const ctx = document.getElementById('weaknessRadarChart').getContext('2d');
             if (this.telemetryChart) this.telemetryChart.destroy();
             const buckets = [0, 0, 0, 0, 0];
             mistakes.forEach(m => {
                 const int = m.interval || 0;
                 if (int <= 1) buckets[0]++; else if (int <= 3) buckets[1]++; else if (int <= 7) buckets[2]++; else if (int <= 14) buckets[3]++; else buckets[4]++;
             });
             this.telemetryChart = new Chart(ctx, {
                 type: 'bar',
                 data: { labels: ['Danger', 'Warning', 'Stable', 'Good', 'Master'], datasets: [{ data: buckets, backgroundColor: ['#ef4444', '#f97316', '#eab308', '#22c55e', '#3b82f6'], borderColor: '#333', borderWidth: 1 }] },
                 options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.1)' } }, x: { grid: { display: false }, ticks: { color: '#94a3b8', font: {size: 10} } } } }
             });
         }
         closeOverlay(id) {
             document.getElementById(id).classList.add('hidden');
             document.getElementById('start-screen').classList.remove('hidden');
         }

         openWordBook() {
             document.getElementById('start-screen').classList.add('hidden');
             document.getElementById('wordbook-screen').classList.remove('hidden');
             this.bookmarkedOnly = false;
             document.getElementById('wb-filter-btn').innerText = "ALL";
             this.renderWordBook();
         }

         toggleBookFilter() {
             this.bookmarkedOnly = !this.bookmarkedOnly;
             document.getElementById('wb-filter-btn').innerText = this.bookmarkedOnly ? "FLAGGED" : "ALL";
             this.renderWordBook();
         }

         renderWordBook() {
             const listEl = document.getElementById('wb-list');
             const query = document.getElementById('wb-search').value.toLowerCase().trim();
             listEl.innerHTML = '';

             // „Éû„Çπ„Çø„Éº„Éá„Éº„Çø„Å®SRS„Éá„Éº„Çø„ÅÆ„Éû„Éº„Ç∏
             const merged = this.masterList.map((item, idx) => {
                 const srs = (this.allMistakes || []).find(m => m.word === item.w);
                 return { w: item.w, m: item.m.join(' / '), id: idx, srs: srs || null };
             });

             const filtered = merged.filter(item => {
                 const matchQ = item.w.includes(query) || item.m.includes(query);
                 const matchBook = this.bookmarkedOnly ? (item.srs && item.srs.bookmarked) : true;
                 return matchQ && matchBook;
             });

             if (filtered.length === 0) {
                 listEl.innerHTML = `<div class="text-gray-500 text-xs text-center py-4">No data found.</div>`;
                 return;
             }

             const displayLimit = 50;
             filtered.slice(0, displayLimit).forEach(item => {
                 let statusColor = "bg-gray-700"; 
                 if (item.srs) {
                     if (item.srs.interval > 14) statusColor = "bg-green-500";
                     else if (item.srs.interval > 3) statusColor = "bg-yellow-500";
                     else statusColor = "bg-red-500";
                 }
                 const isBookmarked = item.srs && item.srs.bookmarked;

                 const div = document.createElement('div');
                 div.className = "flex items-center justify-between bg-gray-900/50 p-3 rounded-lg border border-gray-800 hover:border-gray-600 transition-colors";
                 div.innerHTML = `
                     <div class="flex items-center gap-3 overflow-hidden">
                         <div class="w-1 h-8 ${statusColor} rounded-full shrink-0"></div>
                         <div class="text-left overflow-hidden">
                             <div class="font-bold text-gray-200 text-lg jp-font truncate">${item.w}</div>
                             <p class="text-xs text-gray-400 truncate">${item.m}</p>
                         </div>
                     </div>
                     <button class="${isBookmarked ? 'text-red-500' : 'text-gray-600 hover:text-gray-400'} p-2" onclick="window.toggleBookmark('${item.w}')">
                         ${isBookmarked ? 'üö©' : 'üè≥Ô∏è'}
                     </button>
                 `;
                 listEl.appendChild(div);
             });
         }
    }

    window.quiz = new HybridQuiz();
    </script>
    
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
      import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
      import { 
          getFirestore, collection, addDoc, doc, setDoc, query, where, getDocs, 
          Timestamp, increment, runTransaction, onSnapshot, initializeFirestore, persistentLocalCache
      } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

      // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Å´„ÅÇ„Å™„Åü„ÅÆFirebase„Éó„É≠„Ç∏„Çß„ÇØ„Éà„ÅÆË®≠ÂÆö„ÇíË≤º„Çä‰ªò„Åë„Å¶„Åè„Å†„Åï„ÅÑ‚òÖ‚òÖ‚òÖ
      const firebaseConfig = {
         apiKey: "AIzaSyC_30asSoRz9LAyYLuzYqxGhHJNWbuLvKE",
         authDomain: "kobun-b0fb5.firebaseapp.com",
        projectId: "kobun-b0fb5",
        storageBucket: "kobun-b0fb5.firebasestorage.app",
        messagingSenderId: "892077460039",
        appId: "1:892077460039:web:d2fb94787344b49087ff62",
        measurementId: "G-1RJJ1LPXS9"
      };
      // ‚òÖ‚òÖ‚òÖ„Åì„Åì„Åæ„Åß‚òÖ‚òÖ‚òÖ

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = initializeFirestore(app, { localCache: persistentLocalCache({}) });

      // ‰ª•‰∏ã„ÄÅFirebaseÈÄ£Êê∫„É≠„Ç∏„ÉÉ„ÇØÔºàÂè§ÊñáÁî®„Å´Ë™øÊï¥Ê∏à„ÅøÔºâ
      const gateScreen = document.getElementById('gate-screen');
      const startScreen = document.getElementById('start-screen');
      const loginStatus = document.getElementById('login-status');
      
      window.currentUser = null;
      let unsubscribeStats = null;
      const statsRef = doc(db, "stats", "daily_global_kobun"); // Áµ±Ë®àID„ÇíÂ§âÊõ¥

      onAuthStateChanged(auth, async (user) => {
        if (user) {
          window.currentUser = user;
          loginStatus.innerText = "Syncing...";
          
          if (!unsubscribeStats) {
              unsubscribeStats = onSnapshot(statsRef, (docSnap) => {
                  if (docSnap.exists()) {
                      const data = docSnap.data();
                      const todayStr = new Date().toLocaleString('ja-JP').split(' ')[0];
                      if (data.date === todayStr) {
                          const display = document.getElementById('daily-laps-display');
                          if(display) display.innerText = data.count;
                      }
                  }
              });
          }

          try {
              await window.fetchSRSItems();
              document.getElementById('user-name').innerText = user.displayName || "DRIVER";
              gateScreen.classList.add('hidden');
              startScreen.classList.remove('hidden');
          } catch (error) {
              console.error(error);
              loginStatus.innerText = "Connection Failed. Reloading...";
          }
        } else {
            window.currentUser = null;
            startScreen.classList.add('hidden');
            gateScreen.classList.remove('hidden');
        }
      });

      document.getElementById('gate-login-btn').addEventListener('click', async () => {
        const provider = new GoogleAuthProvider();
        try { await signInWithPopup(auth, provider); } catch (e) { console.error(e); }
      });

      // SRS„Éá„Éº„ÇøÂèñÂæó
      window.fetchSRSItems = async () => {
        if (!window.currentUser) return;
        // „Ç≠„É£„ÉÉ„Ç∑„É•„Ç≠„Éº„ÇíÂ§âÊõ¥„Åó„Å¶Ê∑∑‰ø°„ÇíÈò≤„Åê
        const CACHE_KEY = `kobun_srs_${window.currentUser.uid}`;
        const mistakesRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes"); // „Ç≥„É¨„ÇØ„Ç∑„Éß„É≥Âêç„ÇíÂ§âÊõ¥

        try {
            const snapshot = await getDocs(mistakesRef);
            let allItems = [];
            snapshot.forEach(docSnap => {
                const d = docSnap.data();
                const nrSec = d.nextReview && d.nextReview.seconds ? d.nextReview.seconds : (Date.now()/1000);
                allItems.push({ id: docSnap.id, ...d, nextReviewSeconds: nrSec });
            });
            
            // Âè§Êñá„Ç¢„Éó„É™„Å´„Éá„Éº„Çø„Çí„Çª„ÉÉ„Éà
            if(window.quiz) {
                window.quiz.allMistakes = allItems;
                const nowTs = Date.now() / 1000;
                window.quiz.dueMistakes = allItems.filter(item => item.nextReviewSeconds <= nowTs);
                window.quiz.updatePitStopButton(window.quiz.dueMistakes.length);
            }
        } catch (e) { console.error("Fetch Error:", e); }
      };

      // SRSÊõ¥Êñ∞Âá¶ÁêÜ
      window.handleSRSUpdate = async (q, isCorrect) => {
        if (!window.currentUser) return;
        
        // ID„ÅØÂçòË™û„Åù„ÅÆ„ÇÇ„ÅÆÔºà„Åæ„Åü„ÅØBase64Ôºâ„Å´„Åô„Çã
        const safeId = btoa(encodeURIComponent(q.w)).replace(/\//g, '_').replace(/\+/g, '-');
        const userRef = collection(db, "users", window.currentUser.uid, "kobun_mistakes");
        const targetRef = doc(userRef, safeId);

        const current = { 
            interval: q.interval || 0, 
            repetitions: q.repetitions || 0, 
            easeFactor: q.easeFactor || 2.5 
        };

        let nextInterval, nextRepetitions, nextEaseFactor;

        if (!isCorrect) {
            nextRepetitions = 0; 
            nextInterval = 1; 
            nextEaseFactor = Math.max(1.3, current.easeFactor - 0.2); 
        } else {
            nextRepetitions = current.repetitions + 1;
            nextEaseFactor = Math.min(3.0, Math.max(1.3, current.easeFactor + 0.1));
            if (nextRepetitions === 1) nextInterval = 1;
            else if (nextRepetitions === 2) nextInterval = 4; // Â∞ë„ÅóÁ∑©„ÇÅ„Å´Ë™øÊï¥
            else nextInterval = Math.round(current.interval * nextEaseFactor);
        }

        const nextDate = new Date();
        nextDate.setDate(nextDate.getDate() + nextInterval);

        // Firestore„Å´‰øùÂ≠òÔºàmeaning„Å´„ÅØÂÖ®ÊÑèÂë≥„É™„Çπ„Éà„Çí‰øùÂ≠òÔºâ
        setDoc(targetRef, { 
            word: q.w, 
            meaning: q.mAll ? q.mAll.split(' / ') : [q.aText], // ÈÖçÂàó„Å®„Åó„Å¶‰øùÂ≠ò
            nextReview: Timestamp.fromDate(nextDate), 
            interval: nextInterval, 
            repetitions: nextRepetitions, 
            easeFactor: nextEaseFactor, 
            lastReviewed: Timestamp.now() 
        }, { merge: true });
      };

      // „Éñ„ÉÉ„ÇØ„Éû„Éº„ÇØÂá¶ÁêÜ
      window.toggleBookmark = async (word) => {
          if (!window.currentUser) return;
          const safeId = btoa(encodeURIComponent(word)).replace(/\//g, '_').replace(/\+/g, '-');
          const targetRef = doc(collection(db, "users", window.currentUser.uid, "kobun_mistakes"), safeId);
          
          let item = window.quiz.allMistakes.find(m => m.word === word);
          const newVal = !(item && item.bookmarked);
          
          // UIÂç≥ÊôÇÊõ¥Êñ∞
          if(item) item.bookmarked = newVal;
          else {
              // Êñ∞Ë¶èÁôªÈå≤„ÅÆÂ†¥Âêà
              const masterItem = window.quiz.masterList.find(m => m.w === word);
              if(masterItem) {
                  item = { word: word, meaning: masterItem.m, bookmarked: newVal, interval:0, repetitions:0, easeFactor:2.5, nextReviewSeconds: Date.now()/1000 };
                  window.quiz.allMistakes.push(item);
              }
          }
          window.quiz.renderWordBook();

          setDoc(targetRef, { 
              word: word, 
              bookmarked: newVal,
              // Êó¢Â≠ò„Éá„Éº„Çø„Åå„Å™„Åë„Çå„Å∞ÂàùÊúüÂÄ§„ÇíÂÖ•„Çå„Çã
              meaning: item ? item.meaning : [],
              interval: item ? item.interval : 0,
              repetitions: item ? item.repetitions : 0,
              easeFactor: item ? item.easeFactor : 2.5,
              nextReview: item && item.nextReview ? item.nextReview : Timestamp.now()
          }, { merge: true });
      };

      // ÂÖ®‰ΩìÂë®ÂõûÊï∞„Ç´„Ç¶„É≥„Éà
      window.incrementDailyLaps = async () => {
          if (!window.currentUser) return; 
          const todayStr = new Date().toLocaleString('ja-JP').split(' ')[0];
          try {
              await runTransaction(db, async (transaction) => {
                  const docSnap = await transaction.get(statsRef);
                  if (!docSnap.exists() || docSnap.data().date !== todayStr) {
                      transaction.set(statsRef, { count: 1, date: todayStr });
                  } else {
                      transaction.update(statsRef, { count: increment(1) });
                  }
              });
          } catch (e) { console.error(e); }
      };
    </script>
</body>
</html>
